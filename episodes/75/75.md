[![Watch on youtube](https://img.youtube.com/vi/9ucne6RT11A/0.jpg)](https://www.youtube.com/watch?v=9ucne6RT11A&list=PLyzwHTVJlRc8yjlx4VR4LU5A5O44og9in&index=7)

all right hello and welcome to the nix-hour

let's see if that works I changed some things here hopefully I don't get any
computer freezes anymore

but yeah let's (get) going

so today we'll talk about uh well language tooling was the original issue

[ISSUE 20](https://github.com/tweag/nix-hour/issues/20)

kind of want to make it a bit more general to for nix tooling

we had some

I need to briefly check if the stream is actually working

does it should work yeah it does work all right

so um we had a suggestion here for to cover some nix tooling

and so I thought might be a good idea

I also want to maybe bring up uh this here

that's awesome-nix in the nix-community repo

which has a whole bunch more

and well we can't cover everything of course

but maybe we can jump into some

but we also got some comments here about uh one of them

they're more about language tooling

which I'm not sure we can get to today

but uh I guess we can keep the the issue open and cover it in the future

and if anyone here knows more about gomod2nix or yarn2nix

uh help is also appreciated

but yeah

I just kind of want to jump in here and try out some of these or look into how
they work

and maybe let's just go into the first one here and uh check it out

> https://github.com/tweag/nix-hour/issues/20#issuecomment-2021099035 A few
> dev-tools I find occasionally useful:
>
>     * [martinvonz/jj](https://github.com/martinvonz/jj?rgh-link-date=2024-03-26T17%3A47%3A44.000Z)   better git interface, especially for rebasing
>
>     * [viperML/nh](https://github.com/viperML/nh?rgh-link-date=2024-03-26T17%3A47%3A44.000Z)      general nix helper unifiing a lot of tools
>
>     * [Gabriella439/nix-diff](https://github.com/Gabriella439/nix-diff?rgh-link-date=2024-03-26T17%3A47%3A44.000Z)  derivation diffing
>
>     * [nix-community/nix-init](https://github.com/nix-community/nix-init?rgh-link-date=2024-03-26T17%3A47%3A44.000Z) initialize a package structure from a project url

_opens https://github.com/jj-vcs/jj_

> git compatible VCS that is both simple and powerful

I'm not sure if that's actually git related but it does nix related

but it does look interesting

um yeah I think we'll skip over this because

uh it doesn't seem very nix related

um the other one here the other ones here do though

_opens https://github.com/viperML/nh_

> nh Yet another nix cli helper

somewhat recently announced

it has

I mean let's check it out

so I'm going to go into here

I'm just going to add nh

```console
$ ns -p nh
> nix-shell --command zsh -p nh
```

hope that's the one

I set it up also so the cli here prints what the commands expand to

this way I don't need to explain the aliases all the time

uh but yeah let's let's check it out

```console
$ nh --help
nh is yet another nix helper

Usage: nh [OPTIONS] <COMMAND>

Commands:
  os           NixOS functionality
  home         Home-manager functionality
  search       Searches packages by querying search.nixos.org
  clean        Enhanced nix cleanup
  completions  Generate shell completion files into stdout

Options:
  -v, --verbose  Show debug logs
  -h, --help     Print help
  -V, --version  Print version
```

that is indeed the one

let's see what kind of things we have here

```console
$ nh os --help
NixOS functionality

Reimplementations of nixos-rebuild

Usage: nh os [OPTIONS] <COMMAND>

Commands:
  switch  Build and activate the new configuration, and make it the boot default
  boot    Build the new configuration and make it the boot default
  test    Build and activate the new configuration
  build   Build the new configuration

Options:
  -v, --verbose
          Show debug logs

  -h, --help
          Print help (see a summary with '-h')
```

> OS switch boot test

so that's I guess a CLI for nixos

> for home manager

> search

> clean

I'm not sure what that is about and

> completions

for it

okay um now os

well I guess let's just try running it

so I have a bit of a special setup here where my nixos configuration is just
pretty much empty

```console
$ cat /etc/nixos/configuration.nix
{ lib, ... }: {
  boot.loader.grub.device = "nodev";
  fileSystems."/".device = "/devst";
  system.stateVersion = "23.11";

  environment.systemPackages = [ ];
}
```

I don't deploy from here

but let's see how it handles it

I'm going to just run let's do build

```console
$ nb os build
> nix-build os build
error: path '/home/tweagysil/os' does not exist
```

oh os does not exist I see

oh no I said nb okay nh

```console
$ nh os build
error: the following required arguments were not provided:
  <FLAKEREF>

Usage: nh os build <FLAKEREF> [-- <EXTRA_ARGS>...]

For more information, try '--help'.
```

oh it needs

okay it it needs flake um

okay let's let's try it out so

I'm gonna create actually do I have flake here?

```console
$ ls /etc/nixos
configuration.nix
flake.lock
```

see I do not I only have flake.lock here

um okay let's get let's get an example here

I'm going to go to templates [here](https://github.com/NixOS/templates)

these are some flake templates

and I just want a simple um full

let's see is there for nixos?

let's search for `nixosConfiguration`

_searches
https://github.com/search?q=repo%3ANixOS%2Ftemplates%20nixosConfiguration&type=code_

um there is in full okay let's do that

so I think I should be able to

```console
$ nix flake init -t templates#full
refusing to overwrite existing file '/etc/nixos/flake.nix'
 please merge it manually with '/nix/store/hdiywpk93br863is4xbmr061bysaly1x-source/full/flake.nix'


    You just created a template that will show you all standard flake outputs.

    Read more about it here:

    https://github.com/NixOS/templates/tree/master/full

error: encountered 1 conflicts - see above
```

oh I did that before (bash history)

> would override flake.nix

all right let's get rid of that

```console
$ rm flake.nix
```

also flake.lock `rm flake.lock`

Okay `vim flake.nix`

and then let's remove everything that we don't actually need

so we don't need any of this

we just want the nixosConfiguration here

overlay stuff we don't need that

also inputs we only need a nixpkgs input

so let's get rid of all these

> registry, nixpkgs, github branch

okay I'm just going to I mean I really don't need much here

just need an

`inputs.nixpkgs.url = "github:nixos/nixpkgs/nixos-unstable";`

> [!NOTE]
>
> nixos-unstable is
> [57d6973abba7ea108bac64ae7629e7431e0199b6](https://github.com/nixOS/nixpkgs/commit/57d6973abba7ea108bac64ae7629e7431e0199b6)
> as of this nix-hour

let's use nixos-unstable so we get a tested branch

then in here just going to get nixpkgs

and uh let's see

so nixosSystem

> boot.isContainer

I'm not sure why we would want that

but I can let me let me do it like this

configuration.nix

really standard setup

okay and all right we have configuration.nix here already

```nix
# file: flake.nix
{
  description = "A template that shows all standard flake outputs";

  inputs.nixpkgs.url = "github:nixos/nixpkgs/nixos-unstable";

  outputs =
    { nixpkgs, ... }:
    {
      # Used with `nixos-rebuild --flake .#<hostname>`
      # nixosConfigurations."<hostname>".config.system.build.toplevel must be a derivation
      nixosConfigurations.example = nixpkgs.lib.nixosSystem {
        system = "x86_64-linux";
        modules = [
          ./configuration.nix
        ];
      };
    };
}
```

```nix
# file: configuration.nix
{ lib, ... }:
{
  boot.loader.grub.device = "nodev";
  fileSystems."/".device = "/devst";
  system.stateVersion = "23.11";

  environment.systemPackages = [ ];
}
```

okay that's good

yeah and then let's just try building that so

```console
$ nh os build /etc/nixos
```

all right

so I guess it wraps it right we saw that

nh wraps using nix-output-monitor by default

which is a very nice way to visualize nix build progress

```console
$ nh os build /etc/nixos
> Building NixOS configuration
warning: creating lock file '"/etc/nixos/flake.lock"':
• Added input 'nixpkgs':
    'github:nixos/nixpkgs/57d6973abba7ea108bac64ae7629e7431e0199b6?narHash=sha256-9YrUjdztqi4Gz8n3mBuqvCkMo4ojrA6nASwyIKWMpus%3D' (2024-06-12)
error: flake 'path:/etc/nixos' does not provide attribute 'packages.x86_64-linux.nixosConfigurations.""zion"".config.system.build.toplevel', 'legacyPackages.x86_64-linux.nixosConfigurations.""zion"".config.system.build.toplevel' or 'nixosConfigurations.""zion"".config.system.build.toplevel'
┏━ 1 Errors:
┃ error: flake 'path:/etc/nixos' does not provide attribute 'packages.x86_64-linux.nixosConfigurations.""zion"".config.system.build.toplevel', 'legacyPackages.x86_64-linux.nixosConfigurations.""zion"".config.system.build.toplevel' or 'nixo…
┣━━━
┗━ ∑ ⚠ Exited with 1 errors reported by nix at 11:43:37 after 0s
Error:
   0: Command exited with status Exited(1)

Location:
   src/commands.rs:151
```

and we got an error here

so it does not provide

oh right `zion`

we need to that's my hostname

um you can see nixos/flake.nix

just do this zion

```nix
# file: /etc/nixos/flake.nix
# change example to zion
    nixosConfigurations.zion = ...
```

```console
$ nh os build /etc/nixos
... runs in background ...
```

okay and uh what else does it does it have

so we have visualization of the upgrade diff with nvd

nvd if we look into that _opens https://gitlab.com/khumba/nvd 404, now at
https://sr.ht/~khumba/nvd/_

that's um package version diff tool

so it kind of displays it like this

```
$ nvd diff /nix/var/nix/profiles/system-{14,15}-link
<<< /nix/var/nix/profiles/system-14-link
>>> /nix/var/nix/profiles/system-15-link
Version changes:
[U*]  #1  cpupower                5.4.87 -> 5.4.88
[U*]  #2  firefox                 84.0.1 -> 84.0.2
[U.]  #3  firefox-unwrapped       84.0.1 -> 84.0.2
[U.]  #4  initrd-linux            5.4.87 -> 5.4.88
[U.]  #5  linux                   5.4.87 -> 5.4.88
[U.]  #6  nixos-system-unnamed    20.09.git.6ad5c94ed93 -> 20.09.git.9bf1626e7bb
[U.]  #7  system76-acpi-module    1.0.1-5.4.87 -> 1.0.1-5.4.88
[U.]  #8  system76-io-module      1.0.1-5.4.87 -> 1.0.1-5.4.88
[U.]  #9  x86_energy_perf_policy  5.4.87 -> 5.4.88
Added packages:
[A+]  #1  bpytop  1.0.50
Closure size: 2205 -> 2206 (38 paths added, 37 paths removed, delta +1).
```

I thought something like this also existed for like nix

um oh and I'm I'm reading comments on my phone now

> youtube chat
>
> <confus> it's an alternative git cli
>
> main features: Tree of builds with nix-output-monitor Visualization of the
> upgrade diff with nvd Asking for confirmation before performing activation

> tree builds visualization

> alternative

the `jj` thing here is an alternative to to the git cli

yeah oh and uh

let's see so this is

```console
$ nh os build /etc/nixos
... omitted ...
```

oh there's a lot of output here

oh and even I need to look my scroll buffer here to go even back further

uh what happened here so we have version changes

```console
... omitted ...
┃ ✔ nixos-system-nixos-24.11.20240612.57d6973
┣━━━ Builds            │ Downloads         │ Host
┃        │ ✔ 224 │     │     │       │     │ localhost
┃        │       │     │     │ ↓ 301 │     │ https://cache.nixos.org
┗━ ∑ ⏵ 0 │ ✔ 224 │ ⏸ 0 │ ↓ 0 │ ↓ 301 │ ⏸ 0 │ Finished at 11:51:44 after 4m50s
$ nh os build /etc/nixos
> Comparing changes
<<< /run/current-system
>>> /tmp/nh-os0F48pL/result
Version changes:
[C*]  #001  acl                     2.3.2 x2, 2.3.2-bin, 2.3.2-doc, 2.3.2-man -> 2.3.2, 2.3.2-bin, 2.3.2-doc, 2.3.2-man
[C*]  #002  attr                    2.5.2 x2, 2.5.2-bin, 2.5.2-doc, 2.5.2-man -> 2.5.2, 2.5.2-bin, 2.5.2-doc, 2.5.2-man
[D.]  #003  audit                   3.1.2 x2, 3.1.2-bin -> 3.1.2, 3.1.2-bin
```

um now how did it... oh I see it used `/run/current-system`

now note about `/run/current-system`

there's `/run/current-system` and there's `/run/booted-system`

in most cases these arethe same but if you rebuild your system and don't reboot

then it changes and and so it's actually often different

but `/run/booted-system` matters mainly because of the booted Linux kernel and
the initrd

```
$ nh os build /etc/nixos
...
> Comparing changes
<<< /run/current-system
>>> /tmp/nh-os0F48pL/result
...
```

but yeah so current system and then it compares that okay that's pretty neat

what do these two x (2.3.2 x2) here indicate?

let's see nvd what are those

(do we have let me)

if I get `nh` available

```console
$ ns -p nh
> nix-shell --command zsh -p nh
```

I guess nvd yeah that's not available by default

```console
$ nvd
nvd: command not found
```

so nvd let me add that manually

```console
$ ns -p nvd
> nix-shell --command zsh -p nvd
```

nvd let's just run the man page

```console
$ man nvd
```

what are these x's

can we see any explanation here

let's see

> if there are multiple versions of a package they will be shown separate by
> commas if there are multiple occurrences of a single package version, they
> will be shown with an X suffix

I see, okay

so actually I guess what we can read out of that is that for some reason there's
two separate versions of `acl`

which is kind of weird

and ideally you would want to avoid

because that just means you have kind of the double closure size for that

we could maybe look into that a bit more specifically as well

we have systemd

for systemd I happen to know

actually I'm not entirely sure I but I think there's like boot systemd version
that or a bootstrap systemd verion that's used

or a what is it something else like separate package I can't remember it though

there's selection state changes

```console
... omitted ...
Selection state changes:
[C+]  #1  dhcpcd                10.0.6
[C+]  #2  hicolor-icon-theme    0.17
[C-]  #3  jq                    1.7.1, 1.7.1-bin, 1.7.1-doc, 1.7.1-lib, 1.7.1-man
[C-]  #4  mdadm                 4.3
[C-]  #5  xauth                 1.1.3
... omitted ...
```

so that's all nvd's output probably

selection state changes

what does that mean?

and we have we have a lot of like special output here

let's look into this bit more

mystery for now to me

```console
$ man nvd
...
   After this, packages are listed.  Each package is displayed on a line like the
   following.

       [U.]  #1  linux                   5.4.99 -> 5.4.100
        ^^   ^   ^                       ^
        ||   |   package name            package versions
        ||   count of packages within the section
        |package selection state
        package install state

   The  package  install  state is a single character indicating the whether the package is newly being added or removed, up‐
   graded or downgraded. The possibilities here are:

     I: Installed (no change).
     A: Package is newly added to the closure.
     R: All versions of the package are being removed the closure.
     U: The package is being upgraded.
     D: The package is being downgraded.
     C: None of the above apply; unspecified changes.
...
```

okay we have package selection state, I see and install state

```console
$ man nvd
...
  The package selection state character indicates the presence of the package in environment.systemPackages, and changes to
  that inclusion.  The possibilities here are:

    +: Package is newly selected in environment.systemPackages.
    -: Package is newly unselected.
    *: Package is selected; state unchanged.
    .: Package is not selected; it's a dependency.
...
```

okay interesting so hold on

plus means in system packages um

this is selected state unchanged okay

```console
$ nh os build /etc/nixos
... omitted ...
Version changes:
[C*]  #001  acl                     2.3.2 x2, 2.3.2-bin, 2.3.2-doc, 2.3.2-man -> 2.3.2, 2.3.2-bin, 2.3.2-doc, 2.3.2-man
[C*]  #002  attr                    2.5.2 x2, 2.5.2-bin, 2.5.2-doc, 2.5.2-man -> 2.5.2, 2.5.2-bin, 2.5.2-doc, 2.5.2-man
[D.]  #003  audit                   3.1.2 x2, 3.1.2-bin -> 3.1.2, 3.1.2-bin
```

so oh I see so these are all star or so these are kind of already selected

okay so already part of uh the closure and here it's a dependency

these (dots .) are dependencies I see

and they they also came bolded in this case, okay

uh but yeah so these dhcpcd would be added to environmental system packages

jq would be removed, okay kind of makes sense

um what else do we have we have added packages

oh I see these are all changed ones

added ones we have removed ones okay

so that's that's a lot of output um and right a lot of removed ones because I'm
evaluating an empty configuration here that's also why I wouldn't want to
actually actually activate this one

we have closure size that's neat so how many paths how many removed uh and disk
usage

so well apparently I have more than 15 GB in my my current system closure size

and maybe we can also briefly just check, because this info can be gotten on the
cli as well if you want to like just manually look at it

that's uh uh so there's commands like `nix show..` or I think it's
`nix path-info`

yeah `path-info -S` I think what is S? I forgot

```
$ nix path-info -S
error: flake 'path:/etc/nixos' does not provide attribute 'packages.x86_64-linux.default' or 'defaultPackage.x86_64-linux'
```

```
$ nix path-info --help
      · --closure-size / -S

        Print the sum of the sizes of the NAR serialisations of the closure of each path.

      · --human-readable / -h

        With -s and -S, print sizes in a human-friendly format such as 5.67G.

      · --json

        Produce output in JSON format, suitable for consumption by another program.
```

help -S that's closure size, human readable, json which might be used by nvd
underneath

um but yeah so we can use it like this

run current system for example

```
$ nix path-info /run/current-system
/nix/store/lm6df1jds3man01i2shzigrn79hc5xz3-nixos-system-zion-24.11pre-git
$ nix path-info /run/current-system -Sh
/nix/store/lm6df1jds3man01i2shzigrn79hc5xz3-nixos-system-zion-24.11pre-git        16.4G
$ nix path-info /run/current-system -Sh -s
/nix/store/lm6df1jds3man01i2shzigrn79hc5xz3-nixos-system-zion-24.11pre-git        60.9K    16.4G
```

and then this so yeah we can see here my current closure size is about 16gb

and uh I wonder this can probably well we can also use individual paths here

I suppose uh we can get individual path with like

> [!NOTE]
>
> the below output is not the one from the nix-hour as it is not worth it to
> transcribe the exact output, this is from the my system

```
$ nix-store -q --references /run/current-system
/nix/store/0ip389clsbrbjmhmrysgfghqnhx8qlfd-glibc-locales-2.40-66
/nix/store/xy4jjgw87sbgwylm5kn047d9gkbhsr9x-bash-5.2p37
/nix/store/0n3igv0cc5qgd559qkba0j5qcp8b41c2-install-grub.sh
/nix/store/1q9lw4r2mbap8rsr8cja46nap6wvrw2p-bash-interactive-5.2p37
/nix/store/2a0i71awc5c0q2vyn0d3gk85g78srmgy-manifest-for-users.json
/nix/store/2l23lk60khahkx3k6i8hhlblhx5gmw8a-linux-6.12.31
/nix/store/303islqk386z1w2g1ngvxnkl4glfpgrs-glibc-2.40-66-bin
/nix/store/4fwp1nqmank38wmzi6cq946gsjp0ps1n-users-groups.json
/nix/store/6kldkgh0i8h6wwfi78nviki6a15h03bw-perl-5.40.0-env
/nix/store/75m2zly9vl6gvx3gc23y7hgjsbarqf7r-switch-to-configuration-0.1.0
/nix/store/7sb1nkpf82nb5kj7qc4bbqkwj1l1mdv9-update-users-groups.pl
/nix/store/87fck6hm17chxjq7badb11mq036zbyv9-coreutils-9.7
/nix/store/7y59hzi3svdj1xjddjn2k7km96pifcyl-findutils-4.10.0
/nix/store/89n5wybyxmy114c1ww06dph1rsz35sv5-manifest.json
/nix/store/8vqqb9hp35whmp9fxd4c01z2zrdy8g5g-pre-switch-checks
/nix/store/b895xnbwyfj1msj6ljcsvwfdhwqhd2vd-shadow-4.17.4
/nix/store/j2v7jjnczkj7ra7jsgq6kv3242a1l52x-getent-glibc-2.40-66
/nix/store/qvyvscqgr6vyqvmjdgxqa521myv5db0p-kmod-31
/nix/store/if9z6wmzmb07j63c02mvfkhn1mw1w5p4-systemd-257.5
/nix/store/af291yai47szhz3miviwslzrjqky31xw-util-linux-2.41-bin
/nix/store/9na7gqxfdhn09hrj61xsdn7g4qhgdsg5-local-cmds
/nix/store/dwxmc2d8wmwxcybdyb8f7gqnnhy512js-sops-install-secrets-0.0.1
/nix/store/gkbc6nv3h0hsp06kqk0p6s9911c2a1gg-mounts.sh
/nix/store/gqmr3gixlddz3667ba1iyqck3c0dkpvd-gnugrep-3.11
/nix/store/l9k50q7ivq3sgxw8d07fkliz0zadf3r1-initrd-linux-6.12.31
/nix/store/mhxn5kwnri3z9hdzi3x0980id65p0icn-lib.sh
/nix/store/mlc23ciq7cj05wb0wkyrn75xjbfka5xi-linux-6.12.31-modules
/nix/store/mmz4qa42fhacp04wfjhwlslnlfffyxjv-append-initrd-secrets
/nix/store/rg5rf512szdxmnj9qal3wfdnpfsx38qi-setup-etc.pl
/nix/store/s10ivw5xxlzbcy6aah65wcfgsbb5jhg0-firmware
/nix/store/skd9hg5cdz7jwpq1wp38fvzab9y8p0m6-net-tools-2.10
/nix/store/zf12chbmsxmkidrgafqwf8pw4ldlpdch-gnupg-2.4.7
/nix/store/zql0aksg8vpmaivh4ylkzg8ky4k1r3ms-perl-5.40.0-env
/nix/store/6y075mclcdc18g0s59k51a2w4m62hr5l-nixos-system-iron-sp-tty-25.11pre-git
/nix/store/cxhhdp3q0sqxjdvn877l3j50605z8zqd-system-path
/nix/store/9zj5p3mirb7i01fi3dsjzdx1nqvgfny6-etc
/nix/store/c7y67cfdn8fkln04h7vk9fafph6q78p1-initrd-linux-6.12.31
/nix/store/qbfcxvd99py1i5g8nld4c9hfnz4jp47l-nixos-system-iron-25.11pre-git
```

so I think these are all the ones my system directly depends on

of course we have things like `...-etc` here which has a lot of closure
dependencies or actually maybe not as much

um but for example `...-setup-etc.pl` maybe not

`...-user-groups.json`, `...-install-grub.sh`, `...-perl-5.40.0-env`,
`...-local-cmds`, `...-system-path`

oh that's that has probably a lot of ones

```
$ nix-store -q --references /nix/store/cxhhdp3q0sqxjdvn877l3j50605z8zqd-system-path
... lots of output ...
```

yeah so that's where all the packages are in in the end

okay so uh we kind of saw nvd and nh here

let's see what other commands nh has

home-manager functionality

so I know about home-manager

> visits https://github.com/nix-community/home-manager

I'm not a big fan of how the default installation or it's kind of hard to
install

I wish it was kind of tight more tightly integrated into nixos

but currently

I mean I feel like this could go through some revisions

but uh there's usage Home-manager manual

> goes to
> https://nix-community.github.io/home-manager/index.xhtml#ch-installation

installing standalone

so this is like with channels uh personally I use not any of these ones here

I don't use nix-channel to do stuff

there is yeah that's NixOS module

that's decent but also explained using channels here

so I wonder how nh does it

so if you do like home help see

```
$ nh home --help
Home-manager functionality

Usage: nh home [OPTIONS] <COMMAND>

Commands:
  switch  Build and activate a home-manager configuration
  build   Build a home-manager configuration

Options:
  -v, --verbose  Show debug logs
  -h, --help     Print help
```

switch and build so I wonder does it come

so let's see do I have home-manager in my path

```
$ home-manager
The program 'home-manager' is currently not installed. You can install it
by typing:
  nix profile install nixpkgs#home-manager.out

Or run it once with:
  nix shell nixpkgs#home-manager.out -c home-manager ...
```

I do not

so what if we do a build

```
$ nh home build
error: the following required arguments were not provided:
  <FLAKEREF>

Usage: nh home build <FLAKEREF> [-- <EXTRA_ARGS>...]

For more information, try `--help`.
```

I want a flake ref

so I guess a standard thing would be to do um dot what it what is it home.nix?

> searches home.nix in
> https://nix-community.github.io/home-manager/index.xhtml#ch-usage

where is it usually?

oh its here `~/.config/home-manager/flake.nix`

okay so

```console
$ mkdir $(dirname ~/.config/home-manager/flake.nix)
mkdir: cannot create directory ‘/home/tweagysil/.config/home-manager’: File exists
```

```console
$ mkdir $(dirname ~/.config/home-manager/flake.nix) -p
```

and we do this

```console
$ vim ~/.config/home-manager/flake.nix
```

and then a simple

well let's copy one from here

> scrolls in https://nix-community.github.io/home-manager/index.xhtml#ch-usage

what is a default one? oh I see the default configuration is placed here is
there like a

oh here's an example let's copy that

```nix
# file: ~/.config/home-manager/flake.nix
{ config, pkgs, ... }:

{
  # Home Manager needs a bit of information about you and the
  # paths it should manage.
  home.username = "jdoe";
  home.homeDirectory = "/home/jdoe";

  # This value determines the Home Manager release that your
  # configuration is compatible with. This helps avoid breakage
  # when a new Home Manager release introduces backwards
  # incompatible changes.
  #
  # You can update Home Manager without changing this value. See
  # the Home Manager release notes for a list of state version
  # changes in each release.
  home.stateVersion = "24.05";

  # Let Home Manager install and manage itself.
  programs.home-manager.enable = true;
}
```

so let's see we have home.username

I'm going to fill one I have

`home.username = "tweagysil";`

same here

`home.homeDirectory = "/home/tweagysil";`

stateVersion

and home-manager.enable this is kind of something I'm wondering about

because .enable

I think that installs home-manager like once you run it the first time

I'm just going to go in here

> searches 'home-manager.enable' in
> https://nix-community.github.io/home-manager/options.xhtml

> programs.home-manager.enable

    Whether to enable Home Manager.

    Type: boolean

    Default: false

it's kind of recursive

default false you can enable it

just kind of I want to check what it actually does

> visits
> https://github.com/nix-community/home-manager/blob/master/modules/programs/home-manager.nix

oh I see so yeah it actually installs

that installs home-manager

so we probably wouldn't want that

`#programs.home-manager.enable = true;` commented out

assuming nh comes with a way to to have that be installed by default

so home manager

```
$ nh home build ~/.config/home-manager
warning: Git tree '/home/tweagysil' is dirty
error: path '/nix/store/j5nns40g488p6sbwqcpls6zdpss493yq-source/.config/home-manager/flake.nix' does not exist
Error:
   0: Failed to parse nix-eval output:

Location:
   src/home.rs:197
```

briefly reading chat here

it's really small on my phone maybe I need to change that

all right yeah

we can use it as an nixos module

home build let's see what failed here

does not exist is this because I need to probably I need to make it a

```
cd ~/.config/home-manager
git init
```

hold on flake.nix and home.nix um right well let's do git init

I mean this home.nix is kind of outdated let's remove that

`rm home.nix`

```console
$ git init
$ git add --all
```

and then nh build current directory

```console
$ nh build .
warning: Git tree '/home/tweagysil/.config/home-manager' is dirty
error:
      ... while evaluating the file '/nix/store/...-source/flake.nix':

      error: '/nix/store/...-source/flake.nix' must be an attribute set
Error:
   0: Failed to parse nix-eval output:

Location:
   src/home.rs:197
```

file must

right this is not a this is not a

this is a home.nix file

`mv flake.nix home.nix`

and how does home-manager interact with flakes like standalone, is it described
here?

> search flakes in https://nix-community.github.io/home-manager/index.xhtml

oh here it is standalone setup

> visits
> https://nix-community.github.io/home-manager/index.xhtml#sec-flakes-standalone

> nix run home-manager/master -- init --switch

oh there's an init thing

I guess let's run that then

init switch

let's get rid of this one for now

`rm home.nix`

oh and no I don't want to switch yet

just like this

```console
$ nix run home-manager/master -- init
Creating /home/tweagysil/.config/home-manager/home.nix...
Creating /home/tweagysil/.config/home-manager/flake.nix...
```

okay as I created a flake.nix

> opens flake.nix

that's a okay

I guess that works and does it have the same thing here

> opens home.nix

oh we have a nice initial one

it's good let me disable this one for now

`#programs.home-manager.enable = true;` commented out

just going to see what it does all right

```
$ nh home build .
... error ...
path /nix/store/...-source/home.nix does not exist
```

and it looks like

well I mean in this case actually yeah we don't need to worry about installing
home-manager

because it's effectively declared in here

```nix
# file: flake.nix
  inputs = {
    # Specify the source of Home Manager and Nixpkgs.
    nixpkgs.url = "github:nixos/nixpkgs/nixos-unstable";
    home-manager = {
      url = "github:nix-community/home-manager";
      inputs.nixpkgs.follows = "nixpkgs";
    };
  };

  outputs =
    { nixpkgs, home-manager, ... }:
    let
      system = "x86_64-linux";
      pkgs = nixpkgs.legacyPackages.${system};
    in
```

and so right it comes from here

so yeah I guess right you wouldn't use `home-manager`

no I guess like by default it would install this here

`programs.home-manager.enable = true;`

would install the home-manager command

so you can use the home-manager command and don't have to use the nix flakes
directly

something like that

but now let me do this add git stuff

`git add --all`

```console
$ nh home build .
... runs ...
```

let's get it to work

hold on wait yeah I disabled it

`#programs.home-manager.enable = true;` commented out

so I think we don't need to install the actual home-manager command with this

can also see it uses nvd and diffs with the one that I have already

```
$ nh home build .
warning: Git tree '/home/tweagysil/.config/home-manager' is dirty
warning: Git tree '/home/tweagysil/.config/home-manager' is dirty
> Building Home-Manager configuration
warning: Git tree '/home/tweagysil/.config/home-manager' is dirty
> Comparing changes
<<< /home/tweagysil/.local/state/nix/profiles/home-manager
>>> /run/user/1001/nh-home-8lbsPW/result
```

that sounds pretty good

there's a lot of warnings here looks like it imports it multiple times

something I really like doing with commands to just see what they do is to use
strace

and we can filter specifically for when new processes are invoked

so I can do

`strace -e trace=process nh home build .`

equals process I'm also going to add `-f` to see the to have it track through
forks

and I'm going to do `-o log`

`strace -e trace=process -f -o log nh home build .`

so once I do that once it's done

I can look into log

`vim log`

and I can see all the kind of commands it evaluates

and oh right by default it doesn't filter out the ones that failed

I think that there's a way to do that too let's

`man strace` search `failed`

> failed only successful only

yeah let's do that or - a small z uh -z (zee /ˈziː/) or (zed /ˈzɛd/)

okay log

`vim log`

and okay that looks much better

so we have uh rep stuff it calls nix-eval home configuration it applies

oh I see so it calls it once to just figure out if there is a specific hostname

```log
execve("/run/current-system/sw/bin/nix", ["nix", "eval", ".#homeConfigurations", "--apply", " x: x ? \"tweagysil@zion\" "] ... = 0
```

right okay

checks the hostname with the well the username with the hostname suffix then

just the hostname or the username

```log
execve("/run/current-system/sw/bin/nix", ["nix", "eval", ".#homeConfigurations", "--apply", " x: x ? \"tweagysil\" "] ... = 0
```

what else does it do

```log
execve("/run/current-system/sw/bin/nix", ["nix", "build", ".#homeConfigurations.tweagysil.c"..., "--log-format", "internal-json", "--verbose", "--out-link", "/run/user/1001/nh-homeM58GgH/re"...], ... = 0
```

we can't see the entire thing here

that's all also something let's fix that

`man strace`

was it limit strace limits is called limit string strings-in-hex

thought the default strace

how fast can I find this oh `string-limit` here

>     --string-limit=strsize

    Specify the maximum string size to print (the default is 32).  Note that filenames are not considered strings and are always printed in full.

yeah so let's do -s and increase that to like bunch more -s 100 okay

`strace -e trace=process -f -o log -z -s 100 nh home build .`

`vim log`

and uh now we can see it here

```log
execve("/run/current-system/sw/bin/nix", ["nix", "build", ".#homeConfigurations.tweagysil.config.home.activationPackage", "--log-format", "internal-json", "--verbose", "--out-link", "/tmp/nh-homeNaLeSW/result"] ... = 0
```

so it calls this here

oh I see so it doesn't even call the home-manager CLI

actually directly goes into the activationPackage

and I think that's also pretty much just what home-manager does

there's a small chance that home-manager like the cli changes its behavior

but I guess it should be stable so it shouldn't really happen

`vim log`

we have num we have nix-eval of the current system okay and all of these

```log
clone3({flags=CLONE_VM|CLONE_FS|CLONE_FILES|CLONE_SIGHAND|CLONE_THREAD|CLONE_SYSVSEM|CLONE_SETTLS|CLONE_PARENT_SETTID|CLONE_CHILD_CLEARTID, child_tid=0x7f28ae1fc990, parent_tid=0x7f28ae1fc990, exit_signal=0, stack=0x7f28ad1fc000, stack_size=0xffff40, tls=0x7f28ae1fc6c0} => {parent_tid=[57310]}, 88) = 57310
....
```

I wish I knew how to filter these out

okay but yeah it does some more it does

oh I see these are then all the

oh yeah we can see here that's what nvd does underneath so we it is nix-store
query references -qR um nix-build

we have `nix path-info --closure-size` that's exactly what we saw earlier so
that's interesting

just having that confirmation that's what it does

all right let's maybe move on to

let's see

```
nh --help
...
clean
...
```

there's clean

what does that do

```
$ nh clean
Enhanced nix cleanup

Usage: nh clean [OPTIONS] <COMMAND>

Commands:
  all      Cleans root profiles and calls a store gc
  user     Cleans the current user's profiles and calls a store gc
  profile  Cleans a specific profile

Options:
  -v, --verbose  Show debug logs
  -h, --help     Print help
```

so that's the replacement for I guess nix-collect-garbage

clean all does that have any specific options

```
$ nh clean all --help
Cleans root profiles and calls a store gc

Usage: nh clean all [OPTIONS]

Options:
  -k, --keep <KEEP>              At least keep this number of generations [default: 1]
  -v, --verbose                  Show debug logs
  -K, --keep-since <KEEP_SINCE>  At least keep gcroots and generations in this time range since now [default: 0h]
  -n, --dry                      Only print actions, without performing them
  -a, --ask                      Ask for confirmation
      --nogc                     Don't run nix store --gc
      --nogcroots                Don't clean gcroots
  -h, --help                     Print help
```

at least this number of derivations keep since

I think let's move on from nh

`vim log`

you can do oh yeah uh we have a nice Vim command to remove everything but exec
let me briefly try that out

`:g!/exec/d`

and takes a while I suppose

yep it's pretty much frozen for now

let's give it a couple more seconds yeah I hear my computer turning here

okay let's cancel that but seems to have worked for up here

probably also way to do that in here using syscall directly uh strace directly

anyways let's move on a bit

I don't want to be at nh all the time

but we've seen some of it let's see what else we have here

> sees https://github.com/tweag/nix-hour/issues/20#issuecomment-2021099035
> https://github.com/Gabriella439/nix-diff derivation diffing

> visits https://github.com/Gabriella439/nix-diff

> Explain why two Nix derivations differ

so there is also a kind of built-in one

but it doesn't have all the same features

so let's see

we even have an example here

yeah okay let's try it out

let's just copy this right or let's do a bit more manual

let's do so we have a configuration.nix here

```nix
# file: /etc/nixos/configuration.nix
{ lib, ... }: {
    boot.loader.grub.device = "nodev";
    fileSystems."/".device = "/devst";
    system.stateVersion = "23.11";

    environment.systemPackages = [ ];
}
```

I'm just going to do one of these go into here

I'm going to do a let me use a nix-instantiate

so nix-instantiate just evaluates the nix code and creates a derivation without
actually building it

very useful in my opinion

let me get nixpkgs from here

```console
$ nix-instantiate '<nixpkgs/nixos>' --arg configuration ./configuration.nix -A system
```

it doesn't really matter how we get it

build it like this and system sure

should not take too long

```console
$ nix-instantiate '<nixpkgs/nixos>' --arg configuration ./configuration.nix -A system
warning: you did not specify '--add-root'; the result might be removed by the garbage collector
/nix/store/c6ss4f3ra3qbpc8kpn3x2pgwrbr4gwg2-nixos-system-nixos-25.11pre-git.drv
```

okay so that's our first our first derivation

and now we add a system package

let's just add like `pkgs.curl`

`environment.systemPackages = [ pkgs.curl ];`

would be an interesting use case or an interesting case

maybe because curl might already be available by default

we then need nix-diff

```console
$ nix-instantiate '<nixpkgs/nixos>' --arg configuration ./configuration.nix -A system
warning: you did not specify '--add-root'; the result might be removed by the garbage collector
/nix/store/90dlx78fp9wz6qsnsn1vpirj30r1papx-nixos-system-nixos-25.11pre-git.drv
```

so it did change different hash

now let's see actually there's nix

uh isn't there `nix diff` no

`nix diff` errors

there's `nix why-depends`

there's

`man nix3`

hold on well what kind of things are there I thought there was one

```
$ man nix3-<TAB TAB>
nix3-build            nix3-hash-to-base32                nix3-registry-pin
nix3-bundle           nix3-hash-to-base64                nix3-registry-remove
nix3-config           nix3-hash-to-sri                   nix3-repl
nix3-config-check     nix3-help                          nix3-run
nix3-config-show      nix3-help-stores                   nix3-shell
nix3-copy             nix3-key                           nix3-search
nix3-daemon           nix3-key-convert-secret-to-public  nix3-store
nix3-derivation       nix3-key-generate-secret           nix3-store-add
nix3-derivation-add   nix3-log                           nix3-store-add-file
nix3-derivation-show  nix3-manpages.gz                   nix3-store-add-path
nix3-develop          nix3-nar                           nix3-store-cat
nix3-edit             nix3-nar-cat                       nix3-store-copy-log
nix3-eval             nix3-nar-dump-path                 nix3-store-copy-sigs
nix3-flake            nix3-nar-ls                        nix3-store-delete
nix3-flake-archive    nix3-nar-pack                      nix3-store-diff-closures
nix3-flake-check      nix3-path-info                     nix3-store-dump-path
nix3-flake-clone      nix3-print-dev-env                 nix3-store-gc
nix3-flake-info       nix3-profile                       nix3-store-info
nix3-flake-init       nix3-profile-diff-closures         nix3-store-ls
nix3-flake-lock       nix3-profile-history               nix3-store-make-content-addressed
nix3-flake-metadata   nix3-profile-install               nix3-store-optimise
nix3-flake-new        nix3-profile-list                  nix3-store-path-from-hash-part
nix3-flake-prefetch   nix3-profile-remove                nix3-store-ping
nix3-flake-show       nix3-profile-rollback              nix3-store-prefetch-file
nix3-flake-update     nix3-profile-upgrade               nix3-store-repair
nix3-fmt              nix3-profile-wipe-history          nix3-store-sign
nix3-hash             nix3-realisation                   nix3-store-verify
nix3-hash-convert     nix3-realisation-info              nix3-upgrade-nix
nix3-hash-file        nix3-registry                      nix3-why-depends
nix3-hash-path        nix3-registry-add
nix3-hash-to-base16   nix3-registry-list
```

registry, why-depends, store is there no diff here?

I thought there was one, maybe not

maybe that's just why-depends that I thought of okay

yeah let's get nix-diff in scope here now

```
$ nix-shell --command zsh -p nix-diff
```

let's do nix-diff and you see I used it before

```
$ nix-diff /nix/store/kbfqff6b2ssqxvmg4hjkrmswg34x8nmy-nix-2.13.7.drv /nix/store/nmn5fyavqn8iy04d9isrsif80l0rf8wq-nix-2.13.7.drv
```

so first derivation second derivation and let's see what changed here

```
$ nix-diff /nix/store/c6ss4f3ra3qbpc8kpn3x2pgwrbr4gwg2-nixos-system-nixos-25.11pre-git.drv /nix/store/90dlx78fp9wz6qsnsn1vpirj30r1papx-nixos-system-nixos-25.11pre-git.drv
- /nix/store/c6ss4f3ra3qbpc8kpn3x2pgwrbr4gwg2-nixos-system-nixos-25.11pre-git.drv:{out}
+ /nix/store/90dlx78fp9wz6qsnsn1vpirj30r1papx-nixos-system-nixos-25.11pre-git.drv:{out}
• The input derivation named `etc` differs
  - /nix/store/ad2xczm6y53lfpakvmdc6l28vyjsrvs1-etc.drv:{out}
  + /nix/store/cns0cg1psk1zzdhlrmvpcs5gz8xsg1qb-etc.drv:{out}
  • The input derivation named `dbus-1` differs
    - /nix/store/fj9gcdli738lr3z41m3w3ww1rdd9j4fs-dbus-1.drv:{out}
    + /nix/store/xjsgfr6k6fcyn9nc3pbfjs19cashi52k-dbus-1.drv:{out}
    • The input derivation named `system-path` differs
      - /nix/store/giliwl2c6ccp3inaak3q5wwrjlh1fb8h-system-path.drv:{out}
      + /nix/store/w99s1ixs1762yyqx826y00dpn3cvcqvk-system-path.drv:{out}
      • The environments do not match:
          pkgs=''
            ################################################ OMITTED HUGE DIFF ###########################################################
          ''
    • Skipping environment comparison
  • The input derivation named `system-units` differs
    - /nix/store/y0prk9vq47vcmslznfwwqx10i27rqd1h-system-units.drv:{out}
    + /nix/store/6g4dbz3zn5vfbqrc2g5jxqil0hqsm25q-system-units.drv:{out}
    • The input derivation named `unit-dbus.service` differs
      - /nix/store/9fpazc0hc5jrd05nx9z852lml75f0a70-unit-dbus.service.drv:{out}
      + /nix/store/8hv1h3f01dfk4cfj1z0yplp818xcdwp0-unit-dbus.service.drv:{out}
      • The input derivation named `X-Restart-Triggers-dbus` differs
        - /nix/store/ky272zndk1rw5m47hljnlpl2yg4ggaaa-X-Restart-Triggers-dbus.drv:{out}
        + /nix/store/7frs31qws7klr185574mzpikmvnl6w4d-X-Restart-Triggers-dbus.drv:{out}
        • Input derivations differ but have already been compared
            dbus-1
        • Skipping environment comparison
      • Skipping environment comparison
    • Skipping environment comparison
  • The input derivation named `user-units` differs
    - /nix/store/k6zz8j9hrz1agh205cb99hf2xa07s19v-user-units.drv:{out}
    + /nix/store/42c7318yfazzrjcaga0jmj84svjyl5rs-user-units.drv:{out}
    • The input derivation named `unit-dbus.service` differs
      - /nix/store/2qn1z5hwx4ks3m4b22l9dhbhl2y4hh57-unit-dbus.service.drv:{out}
      + /nix/store/whxcihxk2z60mf7a328mn4rz97mskhdk-unit-dbus.service.drv:{out}
      • Input derivations differ but have already been compared
          X-Restart-Triggers-dbus
      • Skipping environment comparison
    • Skipping environment comparison
  • Input derivations differ but have already been compared
      system-path
  • Skipping environment comparison
• Input derivations differ but have already been compared
    system-path
• Skipping environment comparison
```

that's not well I guess it's a json in here

but yeah okay we can see

etc changed dbus changed and apparently dbus depends on the system interface

okay lot of stuff here

and systemd units, restart triggers

and we can see here input derivation named `dbus-1` differs

and these have already been compared, so it skips that

that's nice

user units, okay

we also have this one

`The input derivation named system-path differs`

I guess this one is the main one though it's not super obvious here

but yeah the system path differs that's what really changed here

I guess uh this here isn't super obvious I'm not I guess it doesn't diff the
json like internally

would be nice if it did

but let's move along

what else does it have here

so nix-diff

we can also just use these paths, store paths and links to store paths

> $ nix-build example.nix
>
> $ nix-diff /run/current-system ./result

okay interesting so instead of a nix-instantiate let's actually do a nix-build

and then we can compare the result of that

```console
$ nix-build '<nixpkgs/nixos>' --arg configuration ./configuration.nix -A system
...
/nix/store/rxiphd82j4l1mwf7aidcm2kmv7pqjp4s-nixos-system-nixos-25.11pre-git
```

so yeah that shouldn't take too long

it's an empty configuration after all so that one and then just let's remove
curl again and build it a second time

```console
# remove pkgs.curl
$ nix-build '<nixpkgs/nixos>' --arg configuration ./configuration.nix -A system
...
/nix/store/3xplfb03y8rqyiq2yk70z5fpgka09pva-nixos-system-nixos-25.11pre-git
```

all right now let's do nix-diff and let's do the one without curl first and then
the one with curl

```console
$ nix-diff /nix/store/3xplfb03y8rqyiq2yk70z5fpgka09pva-nixos-system-nixos-25.11pre-git /nix/store/rxiphd82j4l1mwf7aidcm2kmv7pqjp4s-nixos-system-nixos-25.11pre-git
- /nix/store/3xplfb03y8rqyiq2yk70z5fpgka09pva-nixos-system-nixos-25.11pre-git:{out}
+ /nix/store/rxiphd82j4l1mwf7aidcm2kmv7pqjp4s-nixos-system-nixos-25.11pre-git:{out}
• The input derivation named `etc` differs
  - /nix/store/ad2xczm6y53lfpakvmdc6l28vyjsrvs1-etc.drv:{out}
  + /nix/store/cns0cg1psk1zzdhlrmvpcs5gz8xsg1qb-etc.drv:{out}
  • The input derivation named `dbus-1` differs
    - /nix/store/fj9gcdli738lr3z41m3w3ww1rdd9j4fs-dbus-1.drv:{out}
    + /nix/store/xjsgfr6k6fcyn9nc3pbfjs19cashi52k-dbus-1.drv:{out}
    • The input derivation named `system-path` differs
      - /nix/store/giliwl2c6ccp3inaak3q5wwrjlh1fb8h-system-path.drv:{out}
      + /nix/store/w99s1ixs1762yyqx826y00dpn3cvcqvk-system-path.drv:{out}
      • The environments do not match:
          pkgs=''
            ################################################ OMITTED HUGE DIFF ###########################################################
          ''
    • Skipping environment comparison
  • The input derivation named `system-units` differs
    - /nix/store/y0prk9vq47vcmslznfwwqx10i27rqd1h-system-units.drv:{out}
    + /nix/store/6g4dbz3zn5vfbqrc2g5jxqil0hqsm25q-system-units.drv:{out}
    • The input derivation named `unit-dbus.service` differs
      - /nix/store/9fpazc0hc5jrd05nx9z852lml75f0a70-unit-dbus.service.drv:{out}
      + /nix/store/8hv1h3f01dfk4cfj1z0yplp818xcdwp0-unit-dbus.service.drv:{out}
      • The input derivation named `X-Restart-Triggers-dbus` differs
        - /nix/store/ky272zndk1rw5m47hljnlpl2yg4ggaaa-X-Restart-Triggers-dbus.drv:{out}
        + /nix/store/7frs31qws7klr185574mzpikmvnl6w4d-X-Restart-Triggers-dbus.drv:{out}
        • Input derivations differ but have already been compared
            dbus-1
        • Skipping environment comparison
      • Skipping environment comparison
    • Skipping environment comparison
  • The input derivation named `user-units` differs
    - /nix/store/k6zz8j9hrz1agh205cb99hf2xa07s19v-user-units.drv:{out}
    + /nix/store/42c7318yfazzrjcaga0jmj84svjyl5rs-user-units.drv:{out}
    • The input derivation named `unit-dbus.service` differs
      - /nix/store/2qn1z5hwx4ks3m4b22l9dhbhl2y4hh57-unit-dbus.service.drv:{out}
      + /nix/store/whxcihxk2z60mf7a328mn4rz97mskhdk-unit-dbus.service.drv:{out}
      • Input derivations differ but have already been compared
          X-Restart-Triggers-dbus
      • Skipping environment comparison
    • Skipping environment comparison
  • Input derivations differ but have already been compared
      system-path
  • Skipping environment comparison
• Input derivations differ but have already been compared
    system-path
• Skipping environment comparison
```

I see so yeah so it's the exact same thing

and how it works is most likely it just does this a

```console
$ nix-store -q --deriver /nix/store/3xplfb03y8rqyiq2yk70z5fpgka09pva-nixos-system-nixos-25.11pre-git
/nix/store/c6ss4f3ra3qbpc8kpn3x2pgwrbr4gwg2-nixos-system-nixos-25.11pre-git.drv
$ nix-store -q --deriver /nix/store/rxiphd82j4l1mwf7aidcm2kmv7pqjp4s-nixos-system-nixos-25.11pre-git
/nix/store/90dlx78fp9wz6qsnsn1vpirj30r1papx-nixos-system-nixos-25.11pre-git.drv
```

because that gives you the derivation that produced an output

it doesn't always work though like maybe I can briefly show this

if we go to like [hydra](https://hydra.nixos.org) here and say well it's kind of
slow nowadays

I'm not sure why

oh no only a couple seconds that's nice

if we pick like anything in here let's pick the latest evaluation

> visits https://hydra.nixos.org/eval/1806986

let's just get like random store path as soon as it loads but

so what I'm going to show is that if you just do I guess Hydra actually doesn't
distribute the derivations themselves

it only distributes the outputs and that is a bit not ideal I'd say

let's just pick like this one here we can get the store path from details here

> visits https://hydra.nixos.org/build/263146414

output store paths let's just copy this one and then

```console
$ nix-store --realise /nix/store/qqyk7i9fq485gnjfvza6qx4mvjdpjizr-rtl88x2bu-6.8.11-unstable-2024-06-09
this path will be fetched (1.14 MiB download, 9.46 MiB unpacked):
  /nix/store/qqyk7i9fq485gnjfvza6qx4mvjdpjizr-rtl88x2bu-6.8.11-unstable-2024-06-09
copying path '/nix/store/qqyk7i9fq485gnjfvza6qx4mvjdpjizr-rtl88x2bu-6.8.11-unstable-2024-06-09' from 'https://cache.nixos.org'...
warning: you did not specify '--add-root'; the result might be removed by the garbage collector
/nix/store/qqyk7i9fq485gnjfvza6qx4mvjdpjizr-rtl88x2bu-6.8.11-unstable-2024-06-09
```

so we can fetch it

but now if we try to do a

```console
$ nix-store --query --deriver /nix/store/qqyk7i9fq485gnjfvza6qx4mvjdpjizr-rtl88x2bu-6.8.11-unstable-2024-06-09
/nix/store/738d11ccxlkzl9hlj3prmsh2cz17y7ac-rtl88x2bu-6.8.11-unstable-2024-06-09.drv
```

we oh we do get it interesting

did that did it actually fetch that from from Hydra

hold on let's check another one that might now work for some reason

> visits https://hydra.nixos.org/build/263145847

so let's first check if the derivation is actually there already

```console
$ stat /nix/store/wgpkz9rv0mnjyrrdlwcrk79ibcql4r76-rtl88x2bu-6.9.4-unstable-2024-06-09.drv
stat: cannot statx '/nix/store/wgpkz9rv0mnjyrrdlwcrk79ibcql4r76-rtl88x2bu-6.9.4-unstable-2024-06-09.drv': No such file or directory
```

so like stat doesn't exist

all right now let's do the realise

```console
$ nix-store --realise /nix/store/cxw79ysj6w3k5hasjnbkknjcc64m3yk2-rtl88x2bu-6.9.4-unstable-2024-06-09
this path will be fetched (1.10 MiB download, 9.35 MiB unpacked):
  /nix/store/cxw79ysj6w3k5hasjnbkknjcc64m3yk2-rtl88x2bu-6.9.4-unstable-2024-06-09
copying path '/nix/store/cxw79ysj6w3k5hasjnbkknjcc64m3yk2-rtl88x2bu-6.9.4-unstable-2024-06-09' from 'https://cache.nixos.org'...
warning: you did not specify '--add-root'; the result might be removed by the garbage collector
/nix/store/cxw79ysj6w3k5hasjnbkknjcc64m3yk2-rtl88x2bu-6.9.4-unstable-2024-06-09
```

stat again

```
$ stat /nix/store/wgpkz9rv0mnjyrrdlwcrk79ibcql4r76-rtl88x2bu-6.9.4-unstable-2024-06-09.drv
stat: cannot statx '/nix/store/wgpkz9rv0mnjyrrdlwcrk79ibcql4r76-rtl88x2bu-6.9.4-unstable-2024-06-09.drv': No such file or directory
```

oh okay that that didn't work

```
$ nix-store -q --deriver /nix/store/cxw79ysj6w3k5hasjnbkknjcc64m3yk2-rtl88x2bu-6.9.4-unstable-2024-06-09
/nix/store/wgpkz9rv0mnjyrrdlwcrk79ibcql4r76-rtl88x2bu-6.9.4-unstable-2024-06-09.drv
```

this one oh it does huh

does it exist now?

```
$ stat /nix/store/wgpkz9rv0mnjyrrdlwcrk79ibcql4r76-rtl88x2bu-6.9.4-unstable-2024-06-09.drv
stat: cannot statx '/nix/store/wgpkz9rv0mnjyrrdlwcrk79ibcql4r76-rtl88x2bu-6.9.4-unstable-2024-06-09.drv': No such file or directory
```

oh I see so it apparently knows about which derivation caused it or built it

but it doesn't have the actual derivation

and I don't think we can call realise on the derivation itself

```
$ nix-store --realise /nix/store/wgpkz9rv0mnjyrrdlwcrk79ibcql4r76-rtl88x2bu-6.9.4-unstable-2024-06-09.drv
don't know how to build these paths:
  /nix/store/wgpkz9rv0mnjyrrdlwcrk79ibcql4r76-rtl88x2bu-6.9.4-unstable-2024-06-09.drv
error: cannot build missing derivation '/nix/store/wgpkz9rv0mnjyrrdlwcrk79ibcql4r76-rtl88x2bu-6.9.4-unstable-2024-06-09.drv'
```

yeah we can get that

I guess mystery solved to some degree

> youtube chat:
>
> Yuriy Taraday: wonder if it could integrate with diffoscope

oh and diffoscope yeah diffoscope is not nix specific

but that's a very nice diffing tool and it supports

well if you have well if you go to R um what is it reproducibility or hold on is
it

it's not reproducibility is R13 nix what is that not quite oh here r13y.com

> [!NOTE]
>
> That site is gone
>
> see https://github.com/grahamc/r13y.com/issues/38 and it is now at
> https://reproducible.nixos.org/nixos-iso-minimal-runtime

I think oh here so that's a website that just kind of tracks how reproducible
the

I guess the iso minimal is and it looks to be almost fully reproducible

I think I think we were 100% some time ago so a little bit of a regression
perhaps

but yeah that uses diffoscope to show you what the differences

you can use that to kind of figure out how to actually fix it

and in this case uh I would probably not know how to fix that start section
headers

just kind of one byte differences here and there

so that's useful

```console
$ nix-shell -p diffoscope
these 150 paths will be fetched (1804.66 MiB download, 7497.84 MiB unpacked):
...
```

oh it does have a lot of dependencies apparently

but okay let's move along here

so we briefly covered nix-diff

okay I think we covered that pretty much what do we have here

> https://github.com/nix-community/nix-init initialize a package structure from
> a project url

I haven't used nix-init before but I heard good stuff from it

so let's try it out

> visits https://github.com/nix-community/nix-init

so apparently you can

> Generate Nix packages from URLs with hash prefetching, dependency inference,
> license detection, and more

so it can't be perfect because like obviously it can be very different depending
on the thing that you're trying to build

but maybe let's try it out

so how do we try that out maybe let's just get into nixpkgs and like pick a
random package maybe from by-name

```
$ cd nixpkgs # master
$ cd pkgs/by-name
```

let's do this package how many are here

```
$ echo */*/package.nix | wc
     1     2615    66896
```

oh man already over 2,500

but yeah let's do like shuffling of that

and then head one oh

```
$ echo */*/package.nix | shuf | head -1
... HUGE OUTPUT ...
```

shuf of that

I'm going to replace the spaces with new lines and then I'm going to pick the
top one

```
$ echo */*/package.nix | shuf | tr ' ' '\n' | head -1
_0/_0xpropo/package.nix
```

so we have underscore `_0/_0xproto`

`vim _0/_0xproto/package.nix`

I'm not sure if that's going to work but let's see what it does with it

so let's do

`nix-shell --command zsh -p nix-init`

and let me briefly read chat

> Yuriy Taraday: Let's package Nix with nix-init! :D

yeah nix might be pretty tricky

> Yuriy Taraday: You should use `ls` instead of `echo` ;)

oh yeah that also works

but yeah nix-init

let's see how to use that just

```
$ nix-init --help
Generate Nix packages with hash prefetching, license detection, and more
https://github.com/nix-community/nix-init

Usage: nix-init [OPTIONS] [OUTPUT]

Arguments:
  [OUTPUT]
          The path or directory to output the generated file to

Options:
  -u, --url <URL>
          Specify the URL

  -n, --nixpkgs <NIXPKGS>
          Path to nixpkgs (in nix)

          Examples:
            -n ./. (use the current directory)
            -n 'builtins.getFlake "nixpkgs"' (use the nixpkgs from the flake registry)
            -n '<nixpkgs>' (default, use the nixpkgs from channels)

  -C, --commit[=<COMMIT>]
          Commit the changes if the output path is name-based (RFC 140)

          see https://github.com/NixOS/nixpkgs/tree/master/pkgs/by-name for more information

          [possible values: true, false]

  -c, --config <CONFIG>
          Specify the config file

  -h, --help
          Print help (see a summary with '-h')

  -V, --version
          Print version
```

-u URL the path to nixpkgs okay

do we need the nixpkgs

```
$ nix-init -u https://github.com/0xType/0xPropo
Enter tag or revision (defaults to 1.100)
❯   1.100
```

enter tag or version defaults to 1.100 that seems to be accurate all right

enter tag or um yep that's the same

```
Enter version
❯ 1.100
```

name 0xpropo well let's see how it well

```
Enter pname
❯ 0x-propo
```

I guess in this case it's not that

but yeah that's yeah

I'm not sure where it gets this name from but I mean that works let's use that

```
How should this package be built?
❯   (stdenv.mkDerivation)
```

how should this package be built

I guess we don't need the C compiler to build this one

oh it's a font actually so that might not matter but yeah let's just run with it
should also work in theory

```
Enter output path (leave as empty for the current directory)
❯
```

output path let's do

```
Enter output path (leave as empty for the current directory)
❯ ~/test/nix-init
```

```
vim ~/test/nix-ini
```

that didn't work

hold on is it because the directory doesn't exist yet

`mkdir -p ~/test/nix-init`

okay let's try again we just go through all of these oh or is it because of the
`~`

did it create

```
$ ls -l
drwxr-xr-x 1 tweagysil users   13 Jun 16:41 '~'
```

oh yeah it did

this okay that's bit unexpected

so we need to escape it in this case

okay let me move that to the current directory

`mv \~/test/nix-init .`

okay and uh let's see what did it put in oh mix in it oh that's the file right
next in it let's move that to 0xpropo.nix

`mv nix-init 0xpropo.nix`

and then let's see what it generated

```nix
# file: 0xpropo.nix
{
  lib,
  stdenv,
  fetchFromGitHub,
}:

stdenv.mkDerivation rec {
  pname = "0x-propo";
  version = "1.100";

  src = fetchFromGitHub {
    owner = "0xType";
    repo = "0xPropo";
    rev = version;
    hash = "sha256-PCSx0LbV7qDrWgWcaRs1sAr3GUcU6Kw2q7HgAh8BnGA=";
  };

  meta = {
    description = "Proportional version of 0xProto";
    homepage = "https://github.com/0xType/0xPropo";
    changelog = "https://github.com/0xType/0xPropo/blob/${src.rev}/CHANGELOG.md";
    license = lib.licenses.ofl;
    maintainers = with lib.maintainers; [ ];
    mainProgram = "0x-propo";
    platforms = lib.platforms.all;
  };
}
```

so it did a mkDerivation got the pname got the version did a fetchFromGitHub
very nice

description I guess I got that from the GitHub description nice

we have homepage we have a changelog nice and it also has src.rev

oh so it uses the rec pattern which is sometimes discouraged nowadays but it's
fine

that works

with license ofl

let me just double check if that's actually correct

> visits https://github.com/0xType/0xPropo?tab=OFL-1.1-1-ov-file

what license is it is ofl1.1 yeah

that sounds pretty good

maintainers right

mainProgram is there actually a mainProgram? I guess this isn't right because

I guess nix-init is mostly meant for binaries

in this case it's a fonr so we would remove that

and all platforms I guess it wouldn't build because

make derivation by default does like a make and make install

in this case oh there's actually Makefile

it might even work

yeah I guess let's try it out

so we want to build this

for that I'm going to let's just do like

I guess let's do this I don't like doing this but it works when you just need to
have a quick build

we do a callPackage 0xpropo.nix like this

```console
$ nix-build -E 'with import <nixpkgs> {}; callPackage ./0xpropo.nix {}'
this derivation will be built:
  /nix/store/7g0qy0wasaajmdmvqj7g1dq7r558ngdj-0x-propo-1.100.drv
building '/nix/store/7g0qy0wasaajmdmvqj7g1dq7r558ngdj-0x-propo-1.100.drv'...
Running phase: unpackPhase
unpacking source archive /nix/store/7cn4ai4wy2zl5jp0nsr8wbkrfb7c97c7-source
source root is source
Running phase: patchPhase
Running phase: updateAutotoolsGnuConfigScriptsPhase
Running phase: configurePhase
no configure script, doing nothing
Running phase: buildPhase
build flags: SHELL=/nix/store/xy4jjgw87sbgwylm5kn047d9gkbhsr9x-bash-5.2p37/bin/bash
pip install -r requirements.txt
/nix/store/xy4jjgw87sbgwylm5kn047d9gkbhsr9x-bash-5.2p37/bin/bash: line 1: pip: command not found
make: *** [Makefile:9: setup] Error 127
error: builder for '/nix/store/7g0qy0wasaajmdmvqj7g1dq7r558ngdj-0x-propo-1.100.drv' failed with exit code 2;
       last 12 log lines:
       > Running phase: unpackPhase
       > unpacking source archive /nix/store/7cn4ai4wy2zl5jp0nsr8wbkrfb7c97c7-source
       > source root is source
       > Running phase: patchPhase
       > Running phase: updateAutotoolsGnuConfigScriptsPhase
       > Running phase: configurePhase
       > no configure script, doing nothing
       > Running phase: buildPhase
       > build flags: SHELL=/nix/store/xy4jjgw87sbgwylm5kn047d9gkbhsr9x-bash-5.2p37/bin/bash
       > pip install -r requirements.txt
       > /nix/store/xy4jjgw87sbgwylm5kn047d9gkbhsr9x-bash-5.2p37/bin/bash: line 1: pip: command not found
       > make: *** [Makefile:9: setup] Error 127
       For full logs, run:
         nix log /nix/store/7g0qy0wasaajmdmvqj7g1dq7r558ngdj-0x-propo-1.100.drv
```

okay it didn't work

oh need needs pip interesting that probably needs a whole bunch of work to make
it go smooth

yeah uh why does it need pip I wonder `fontmake` maybe because of that

yeah okay uh well I guess we probably all right actually

so in the nixpkgs one it fetched it from the releases so that's why it doesn't
need any pip here

because the releases probably just contain the pre-built artifact

so yeah that I guess nix-init can't really automatically detect that

but it's probably mostly meant for like more like C packages or python packages

maybe python package would be interesting to show

let's do

we could use ls

I'm not sure about that

let me just pick

oh

```
$ echo */*/package.nix | shuf | tr ' ' '\n' | head -1
_0/_0xpropo/package.nix
$ echo */*/package.nix | shuf | tr ' ' '\n' | head -1
_0/_0xpropo/package.nix
$ echo */*/package.nix | shuf | tr ' ' '\n' | head -1
_0/_0xpropo/package.nix
$ echo */*/package.nix | shuf | tr ' ' '\n' | head -1
_0/_0xpropo/package.nix
```

oh it's always the same

ah well that's obvious why we picked that one then

we need to flip this around

```
$ echo */*/package.nix | tr ' ' '\n' | shuf | head -1
mp/mpack/package.nix
```

here we go

and do we have any one that actually works decently

`vim mp/mpack/package.nix`

well in this case I mean there's I guess nix-init gives you at least the basic
structure

and this would be an interesting case because it needs to fetch from FTP

although it might not work that way

so what if we just do this one

do a nix-init -u of this

```
$ nix-init -u http://ftp.andrew.cmu.edu/pub/mpack
Enter tag or revision
❯ 1.6
Enter version
❯ 1.6
Enter pname
❯ mpack
Error: command exited with exit status: 1
stdout:

stderr:
$ nix flake prefetch --extra-experimental-features 'nix-command flakes' --json git+http://ftp.andrew.cmu.edu/pub/mpack?ref=refs/tags/1.6&submodules=1
fatal: unable to access 'http://ftp.andrew.cmu.edu/pub/mpack/': Could not resolve host: ftp.andrew.cmu.edu
...
```

that didn't work

could not resolve host I see

fetching ref I see okay yeah so it's not perfect I guess

but I've heard it works for a lot of cases especially like python packages
probably is my guess

because those are kind of a pain to package in a lot of cases

build rust package I saw there supported builders

> Supported builders

    stdenv.mkDerivation
    buildRustPackage
    buildPythonApplication and buildPythonPackage
    buildGoModule

I see build rustpackage build pythonpackage buildgomodule

> Supported fetchers

    fetchCrate
    fetchFromGitHub
    fetchFromGitLab
    fetchFromGitea
    fetchPypi
    All other fetchers supported by nurl are also supported, you just have to manually input the tag/revision of the package

that sounds pretty good

all other Fetchers supported by nurl are also supported

> visits https://github.com/nix-community/nurl
>
> Generate Nix fetcher calls from repository URLs

I see an URL that's generating nix fetch calls from repository URLs

uh that's pretty neat um right generates nix code

maybe so just a comment

that I think it's not a good idea to generate nix code in general

in this case I think it's somewhat well I think it's okay for nix-init

because that's kind of a template you want to start out from and then usually
you need some human modifications to those uh it's not like you're going to
regenerate this every time

in this case for Url fetchings I hope that in the future we have we are moving
towards a json generated lock file format instead of putting hashes in nix
files.

because this is not meant for human modification really

we don't really need the nix language at that point it's just kind of painful

because we need to deal with like escaping as well um it's kind of unclear

kind of what fetchFromGitHub actually accepts you can need kind of a more of a
stable file format for that

anyways I don't want to go into too many details for that

but yeah that's neat nix-init if you need to get started with the project just
packing packaging it

I recommend it let's see I do we have the others maybe

I think yeah let's keep those for future one I do want to jump into
[awesome-nix](https://github.com/nix-community/awesome-nix) here a bit

actually something that I that's not in awesome-nix right now is

nix-tree uh treefmt-nix there it is

so Treefmt I think is really nice

it uh basically allows you to run formats for all kinds of different

languages in your repository and there's a whole bunch of different ones
supported

> visits https://github.com/numtide/treefmt-nix/tree/main/programs

so all of these cabal

there's also some linters in here

I'm not sure it's a great fit for this but uh they're in here

it seems to work decently I've heard

there's like haskell, go all of these

and it also works without nix so this one is specifically for nix

but treefmt works independently even has a nice website

quick start

> visits https://treefmt.com/latest/getting-started/install/

so there's like configuration file format treefmt.toml

we can use that with nix as well like

let's go into here let's do treefmt just get that in scope

`nix-shell --command zsh -p treefmt`

then what if you just run it

```
$ treefmt
[ERROR] treefmt.toml could not be found in /etc/nixos and up. Use the --init option to create one or specify --config-file if it is in a non-standard location.
```

there's no treefmt.toml okay

so let's do init

```
$ treefmt --init
Generated treefmt.toml. Now it's your turn to edit it.
```

okay so we have that and all right here

```toml
# file: treefmt.toml
# One CLI to format the code tree - https://github.com/numtide/treefmt

[formatter.mylanguage]
# Formatter to run
command = "command-to-run"
# Command-line arguments for the command
options = []
# Glob pattern of files to include
includes = [ "*.<language-extension>" ]
# Glob patterns of files to exclude
excludes = []
```

that's kind of the thing where nix comes in because we don't want to specify
this all the time

we could like we could say in here nixfmt and options I don't think we need much
here I think this should work by default

do like this

```toml
# file: treefmt.toml
# One CLI to format the code tree - https://github.com/numtide/treefmt

[formatter.nix]
# Formatter to run
command = "nixfmt"
# Command-line arguments for the command
options = []
# Glob pattern of files to include
includes = [ "*.nix" ]
# Glob patterns of files to exclude
excludes = []
```

but then we also need to get nixfmt in scope

and I'm going to use nixfmt so there's the classic one that's the original one
the RFC style one that's the new one

that's official now although not stable so I'm going to add that

`nix-shell -p treefmt nixfmt-rfc-style`

and then let's go into here and

do a let's check this out before

`cd /etc/nixos` `vim flake.nix`

`treefmt` and it reformatted it very nice

but then also if you have

right you can also add arbitrary other formatters here

but yeah so treefmt-nix comes into play

when you want to specify the it using nix and

let's see oh here treefmt-nix so there is kind of a configuration you can make a
nix a treefmt wrapper

maybe let me just copy this one here treefmt.nix

```nix
# file: treefmt.nix
# myfile.nix
{
  system ? builtins.currentSystem,
}:
let
  nixpkgsSrc = builtins.fetchTarball "https://github.com/NixOS/nixpkgs/archive/refs/heads/nixos-unstable.tar.gz";
  treefmt-nixSrc = builtins.fetchTarball "https://github.com/numtide/treefmt-nix/archive/refs/heads/master.tar.gz";
  nixpkgs = import nixpkgsSrc { inherit system; };
  treefmt-nix = import treefmt-nixSrc;
in
nixpkgs.mkShell {
  packages = [
    (treefmt-nix.mkWrapper nixpkgs {
      # Used to find the project root
      projectRootFile = ".git/config";
      # Enable the terraform formatter
      programs.terraform.enable = true;
      # Override the default package
      programs.terraform.package = nixpkgs.terraform_1;
      # Override the default settings generated by the above option
      settings.formatter.terraform.excludes = [ "hello.tf" ];
    })
  ];
}
```

as we have my file this is fairly kind of standalone way to build it

I guess usually you would do something like this where you say

well we have a nixpkgs we do nixpkgs.mkShell and then I'm going to do packages
equals

and then I'm going to put a treefmt-nix.mkWrapper in here kind of like this

okay and then we move that to shell.nix

I suppose I mean you can also use flakes for that it doesn't really matter how
you get it

but yeah if we do then nix-shell should build that for us

I hope needs to fetch it first though

```console
$ nix-shell
...
       error: Package ‘terraform-1.12.1’ in /nix/store/yq3hi63knlj4sgzl9hi6hnzrjmz9swkb-source/pkgs/applications/networking/cluster/terraform/default.nix:79 has an unfree license (‘bsl11’), refusing to evaluate.

       a) To temporarily allow unfree packages, you can use an environment variable
          for a single invocation of the nix tools.

            $ export NIXPKGS_ALLOW_UNFREE=1

          Note: When using `nix shell`, `nix build`, `nix develop`, etc with a flake,
                then pass `--impure` in order to allow use of environment variables.

       b) For `nixos-rebuild` you can set
         { nixpkgs.config.allowUnfree = true; }
       in configuration.nix to override this.

       Alternatively you can configure a predicate to allow specific packages:
         { nixpkgs.config.allowUnfreePredicate = pkg: builtins.elem (lib.getName pkg) [
             "terraform"
           ];
         }

       c) For `nix-env`, `nix-build`, `nix-shell` or any other Nix command you can add
         { allowUnfree = true; }
       to ~/.config/nixpkgs/config.nix.
```

oh allow unfree what is that

oh terraform all right we don't want terraform here

we want nixfmt-rfc-style I think is an option

```nix
# file: shell.nix
# ...
# remove terraform fully
    programs.nixfmt-rfc-style.enable = true;
```

it's also based on the module system

okay let's do this nix-shell see

```
$ nix-shell
building '/nix/store/1sbwhf4sy6hx38i71niwwkclr83si6x7-treefmt.toml.drv'...
building '/nix/store/fdvc6r2ba4prm4z4cfsmns17fx97yz65-treefmt.drv'...
```

reading comments briefly

> SoupGlasses: You can also use the wrapper for the flake option
> `outputs.formatter`

yes yeah there's I think there's also some some flake integration formatter
somewhere maybe

anyways so we have that now and now I think

let's do like

```console
$ realpath $(which treefmt)
/nix/store/kmxnalrcfa3lfdsr3kvax506rbvcb2by-treefmt/bin/treefmt
```

that comes from here

hold on I just want to make sure that I don't get the the wrong one

`nix-shell`

`treefmt`

it's available

```
$ treefmt
Error: failed to load config: failed to determine tree root: failed to find tree-root based on tree-root-file: could not find [.git/config] in /etc/nixos
```

I see so this is not a git repo

I suppose needs that

`git init`

I mean it doesn't necessarily need that it's just that I said that it needed
that in here

`projectRootFile = ".git/config";`

it's kind of the default

`treefmt`

yeah that worked and so this way you don't need to actually

we don't actually need the treefmt.toml now we can remove that

`rm treefmt.toml`

`treefmt` still works

so it kind of wraps the treefmt with the right configuration that you specify in
nix

and because it's in nix you can also do

like you don't need to worry about installing it in advance

so right if we

let see I saw jsonfmt in here

so maybe try that one out too

`programs.jsonfmt.enable = true;`

jsonfmt and let's get some json

where do we get json from

let's just create one briefly

`echo '{"foo":"bar"}' >foo.json`

okay and treefmt

well we need to re-enter the shell to just reload it

`nix-shell`

if you use direnv that would be a bit faster or a bit easier

okay treefmt and json format one file processed

```console
$ treefmt
formatted 1 files (1 changed) in 30ms
```

and it's formatted nicely very good and you can also customize how it formats it

so all of these formatters have a separate way of doing it

and maybe customization options

there are sometimes even different formators, right

there's also if you prefer like alejandra is another nix formatter although I
don't think it's maintained anymore

but yeah you can pick any of these and you can also specify options as well

it's all based on the module system or here module options

> visits https://github.com/numtide/treefmt-nix/blob/main/module-options.nix

yeah so there's like a formatter there's options includes excludes

you can say exactly what should be the formatter and what options should be
passed

we have like five more minutes

maybe let's just jump into like a random one that looks interesting here and
check it out

> visits https://github.com/nix-community/awesome-nix

> [nix-direnv](https://github.com/nix-community/nix-direnv) - A fast loader and
> flake-compliant configuration for the direnv environment auto-loader.

uh we have nix-direnv

we talked a lot about nix about direnv and nix-direnv

there actually maybe briefly let me mention there's a I think a pretty good
nixos module now

for direnv that kind of works by default where you don't need anything else I
think

it might just be this one yeah

> visits https://search.nixos.org/options?query=direnv

`programs.direnv.enable` Turn on integration

there's `programs.direnv.loadInNixShell`

okay well there's that [nix-health](https://github.com/juspay/nix-health) what
is that

health of nix-install is that is that maintained? it is

interesting let's check it out

`nix-shell -p nix-health`

```
$ nix-health
🩺️ Checking the health of your Nix setup (x86_64-linux on NixOS):
✅ Minimum Nix Version
   nix version = 2.22.1
✅ Flakes Enabled
   experimental-features = flakes fetch-tree nix-command
✅ Disk Space
   min disk space = 1024.0 GB; total = 1.2 TB
✅ Max Jobs
   max-jobs = 8
✅ Nix Caches in use
   substituters =  https://tweag-webauthn.cachix.org/ https://cache.nixos.org/
✅ Trusted Users
   trusted-users = infinisil tweagysil
✅ Direnv installation
   direnv location = Some("/run/current-system/sw/bin/direnv")
✅ All checks passed
```

Flakes enabled oh it checks that Flakes is enabled and probably complains if
it's not

not sure how I feel about that but that's fine

Max jobs, nix caches in use, trusted users, direnv installation okay neat

see what else do we have

> [nixd](https://github.com/nix-community/nixd) - Nix language server, based on
> Nix libraries.

nixd I'm using [nil](https://github.com/oxalica/nil) as a language server

but I'm also hearing that nixd is pretty good

I think nixd is based on the like internal like unstable C++ API

I mean API it's just going to expose Library files

but yeah we just have a couple minutes I'm wondering what else we could look at
here

> [services-flake](https://github.com/juspay/services-flake) - A NixOS-like
> service configuration framework for Nix flakes

I mean there's also these other projects where is it like devbox devshell uh
devenv is not here? oh it is here

nh, nixpkgs-hammering, nix-alien oh yeah nix-alien maybe let's check this one
out

> [nix-alien](https://github.com/thiagokokada/nix-alien) - Run unpatched
> binaries on Nix/NixOS easily.

run unpatched binaries and actually I think

hold on we have a nix.dev page

which you get redirected to if you try to run a unpatched binary on nixos

enabled by default since recently is this in frequently asked questions

it's not

let's briefly do oh it's here patch

oh here it is

> https://nix.dev/guides/faq#how-to-run-non-nix-executables

yeah how to run non-nix executables

does it actually

so there's some ways on how to do that

- it says use version packaged in nixpkgs if that exists
- write a next expression
  - you can build it from source
  - you can modify ELF header with like autopatchelfhook
  - buildFHSEnv
- you can use [nix-ld](https://github.com/Mic92/nix-ld) which is nice

and there's steam-run

it doesn't mention nix-alien

so let's just briefly check it out

I might not have checked it up before

> visits https://github.com/thiagokokada/nix-alien

so

> $ nix-alien myapp # Run the binary inside a FHS shell with all needed shared
> dependencies to execute the binary

okay that I mean there's probably some overlap with the other things we just
looked at

but this is neat so this is NIX_LD_LIBRARY_PATH for the dependencies

and this lists all the ones

I don't have an unpatched binary ready to

I guess we have a lot of unpatched binaries in nixpkgs could check those out

we are running out of time though nix-alien program, ellipses

okay that's neat

okay uh maybe let's really briefly try it out

so if I go into packages and let's just grep for like patchelf I suppose

or maybe `autoPatchelfHook` that usually well

we're kind of pre-selecting ones that work well to automatically patch here

but I think that's fine for now autoPatchelfHook so it doesn't unpack here

maybe we can do something like nix-shell let me actually `unalias nix-shell`

so that we can do nix-shell -A so we now use nix-shell

for the use case of entering into a derivation environment

and we're going to do cups is it somewhere in here oh here

`nix-shell -A cups-kyodialog`

okay we need the arg config allow unfree equals true

bit messy here

```
$ nix-shell -A cups-kyodialog --arg config '{allowUnfree = true;}'
```

> [!NOTE]
>
> with nix3 command, this should work
>
> nix develop -f '<nixpkgs>' cups-kyodialog --arg config '{allowUnfree = true;}'

okay we should get into a shell with bash and

then I'm going to refer to nixpkgs manual

and I think there's one of these here

hold on here building package in nix-shell which kind of tells you the the kind
of basics

> goes to
> https://nixos.org/manual/nixpkgs/unstable/#sec-building-stdenv-package-in-nix-shell

so we need to go into an empty directory and actually let's think we should be
able to do that here as well

so cd into an empty directory

`cd $(mkdtemp -d)`

then I'm going to do this export out

`export out=$(pwd)/out`

although I don't think we actually need this just to unpack but yeah

and then I'm going to run this

`phases="${prePhases[*]:-} unpackPhase patchPhase" genericBuild`

```console
$ ls -laa
total 0
drwxr-xr-x 1 tweagysil users .
drwxr-xr-x 1 tweagysil users ..
```

and didn't work indeed it didn't work

that's not great uh why did that not work

is there like oh there's an unpackCmd

```console
$ echo $unpackCmd
ar p "$src/Debian/EU/kyodialog_amd64/kyodialog_9.3-0_amd64.deb" data.tar.gz | tar -xz
```

maybe we can just do this

```console
$ $unpackCmd
ar: two different operation options specified
```

no we can't okay

I think uh I think we might have to skip this for now

it's taking a bit too long

all right but anyways uh this was nice if you have any other interest in like
there's a lot of different tools here

> https://github.com/nix-community/awesome-nix

we only kind of scratched the surface here but we also covered a lot of these
before as well

so yeah if you're interested check it out

but yeah thanks for watching and see you next time, bye.
