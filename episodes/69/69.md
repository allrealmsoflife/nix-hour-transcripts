and welcome to the next next
hour uh we're starting bit late today
but that's good um so today we'll talk
about the lookup path syntax in
NYX um for that uh well just before we
start if you want something to be looked
at you can open an issue in this
repository and we might get to it at
some point so uh before we actually do
that it would be really useful to have a
a VM we could try this out with and just
recently I saw that there was a good
tutorial for how to get a VM for a
console in on next. here um I believe it
was under here yeah Nexus virtual
machines so I will try to make use of
this and I want to use specifically
these options here which I believe
should allow me to run VM within a
terminal without having to get the VM
window so I'll briefly go through here
here if you want more details you can
you can check that out um in here I
think there should be a sample
configuration
yes like
this and I'm going to go into the well
I'm going to commit this afterwards into
the N our repository yep uh that is a
good point should share my screen um
yeah so next they here uh you can find
the tutorial the tutorial here on the
left tutor NEX NEX virtual
machines so there's a sample
configuration in
here um I'm going to copy this
one I'm going to create a new directory
here we
have this one and let's just put it in a
well let's call it configuration. mix we
need to make it a bit bigger probably so
it's easier to
see like this by the way we're going to
make the next hour a bit shorter today I
have something to do after this uh okay
so sample configuration kind of weird
how it adds new lines in between here
can I just copy it with this button oh
that works okay
interesting so uh we can build the
VM let's do that
yes so do we want to use nixus 2311
let's
actually uh pin that
that's I want to I want to do that uh
let's use end pins why
not doesn't really matter how we pin
stuff um and we want to pin NY packages
let's get it from NY uh from GitHub I
guess I think like this um and then the
branch we want uh what we want next
packages on unable or nus unstable we're
using nios here so let's use nus
unstable channel uh which
notably it's in it notably the N
unstable Channel runs tests for NX oh
and oh it adds a next packages by
default so I guess we'll use whatever it
has by default why not or I think we can
override it as
well um
yeah doesn't really matter so we need uh
just any next packages and then we can
run this command I don't want to run
this command though I think we can
specify this a bit better in the next
file
so here we
go add a default next and I'm just going
to do like very simple sources equals
import and pins and then import sources
so we get NY
packages um and that's actually in this
case we want to evaluate NY W so we can
straight up do
import sources. next packages plus so
string conation
NEX and uh we want to call this with
certain arguments so we can call it pass
the nest configuration with a NY path
here but if we look into this Nest
directory
let's do this right
here why do I open the the browser for
that I have n packes locally
anyways so yeah we can also so by
default it reads from nus config here
but we can also just pass this as an
argument and if you're using flakes you
also have to pass this
one all right so configuration we're
going to use the one we have specified
in here then we want to build the VM
uh we can we can specify this on the on
the command
line so next bu a
VM and let's see if that works it should
in theory now there's a uh unfortunately
there is a bug in N pins that I'm afraid
to point out because it needs to refetch
next packages um even after it kind of
downloaded it an initial time should
really be fixed is it's not hard problem
I know the problem as well uh but
yeah um although that's ni also has the
same problem it should be possible to
avoid that but that's for another
time and see
I'm I I know a lot of people want me to
use more Flakes and uh I agree flakes
doesn't have that problem so maybe I
should all right building this uh
looking good should be done in a
second all right and I'm going to copy
this one let's see if that
works yep that seems to work so we get
the Nexus output right in our
terminal that's nice oh and uh let's see
what we have in the
configuration let me open this here
69 um here Alice is our user initial
password test so Alice
test all right and NEX s
version Oh the new lines are Ving
interesting
so okay that works okay so next PATH is
our actual topic here or the lookup path
synex more specifically maybe let's
briefly go into the next
manual and just kind of check how it is
documented here look up
path here we go I think in the past it
was called search
path um but it has been renamed to be
kind of more
clear so uh blah look up path is and
identifier with an optional path suffix
that resoles a path value if the
identifier matches a search path entry
um value of Lo a path is determined by
built-in St next PATH um kind of I feel
like that's mistake that should also be
look up path entry uh but yeah so we
have a hint here built in next PATH uh
so this relates to the Nyx path
environment variable and uh let's go
from that so let's just do like a NY
rapple here at first and let's look at
the next PATH value bu in next PATH
uh laser evaluated by default so we need
to do a colon p to print the full
value
I oh this is a reoccurring theme I feel
like um how it has something Channel
related in here I don't think it there
should be anything in there though I
think it's just a default entry next
channels uh manifest yeah that's just
something kind of Legacy it's
not using channels here in my case well
I guess we can we can see actually
that's what what the looka path syntax
is for so if we do a um this it's going
to look through all of these entries and
try to find the first match and uh so it
if there's no prefix here it well it it
checks to see if this file exists SL
next packages because next packages is
our kind of file name here here if it
doesn't exist it tries to find the next
one um in this case we have a match on
the prefix here in which case it should
then return this one directly so if we
do this we can we can see this one and
this is the one the same next packages I
get from my from my
system and also the Lo up path syntax
has a yeah find file is does the exact
same thing so we can say find file next
pack is in we need to pass this one
directly
so um string list expected because it's
the other way around next PATH next
packages like this yeah so that's the
exact same thing and notably this it's
it's like you you should probably
shouldn't ever need this but um you can
pass Dynamic strings in here so you
could be like oh um I know if you if you
dynamically populate the next PATH
environment variable so that would
work uh are these files shared after I
was trying to follow along I'm too slow
uh yes I uh will share these afterwards
in the next hour repository so TW
nexar um okay so we have we have this um
let's also so so this is the next PATH
we get inside our n let's just verify
that it's the same outside so it should
be populated from the Nyx path let's see
what that is set to in this case it does
match and
so but if we look at the the option here
so builtin St next
PATH uh the value of the next PATH
configuration setting uh blah blah blah
the sugared um next PATH configuration
setting what is that so list of search
pass blah blah blah the default value is
this so there is a default value if you
don't pass it but it can be overwritten
with the next PATH path environment
variable or the- I command line option
so if we try something like this so say
oh actually NY instantiate has that as
well so we there is NY instantiate D-
find file that's the equivalent of the
path lookup
syntax so so this way we can also
resolve that and it's kind of easier
than doing this
here um like
this yeah same thing or if you use the
new experimental CLI NYX
eval
um
xure and uh pure evoltion mode there we
need to use inure so yeah this is indeed
an
impurity based on just what we read here
but also we can try something like this
what if we unset the environment
variable so we unset next
PATH let's make this like this so we
unset next PATH and now let's look at
the value of uh of that buil-in stni
path path now oh that's actually not
kind of not really what I was expecting
oh I guess
I guess it might filter these based on
what exists and in this case I
guess this doesn't exist for me neither
does this but this one does let's
actually verify this
briefly if I remove this file or this
directory which I think Nick's n adds
that which you should probably avoid
using in
general but if we remove that yeah then
it's it's entirely gone so
filters the default by the ones that
actually exist okay can we also do that
with the DH I so what happens if we have
like do das I override the uh add to the
defaults or override the entire defaults
let's try that
so um I guess let's do buil-in start
next PATH like this and then Das I
equals
bar um yes it over writes the completely
if we remove
that well I guess we removed the the one
thing that would indicate the default is
used so let's actually just do like a
let's just recreate
this next Dev
exper channels d p sure okay so that
exists D I F Bar oh so it adds it okay
so and here we can get into the the
tricky bits of how this all of this
works and there is a bug relating to
that
so um let's actually jump to that really
briefly because it's it's kind of
important and I I wish someone would fix
it so if you search for like next PATH
here
um broken nck path tracking
issue
uh
yeah this one so next PATH environment
variable does not work when N.C has a
next pass setting so there's kind of a
wrong precedence level here and that's
also the kind of bug of a the cause of a
bug in next packages so if we
do um yeah actually now we want to
switch to the VM because I want to
change
N.C uh let's do that in here
yeah um we I kind of wish I could
rebuild within that VM I do have a
template for that but I haven't used it
uh I could switch to that template
still guess I guess let's why
not um let's see can I log out here I
cannot is there how do I do that I think
there's a kind of key command to to log
out it's
like no control D doesn't
work um I guess LS test power
off sud R
off
best does that work okay that works bit
bit
tedious all right but we have the
template in here uh we
copy templates VM and just
do yeah let's just copy it into VM
here uh there is a build-
AVM run I believe
which builds a VM that we can can run
and edit the configuration within the VM
very useful I've used this a couple
times in the
past um but so the oh it's already done
that's
nice there all been VM and now we want
to oh actually the VM here has a
graphical user interface I don't really
want that and it takes a really long
time to start up so I'm going to briefly
remove that
so I think it's somewhere in
here um Z
[Music]
shell no exer over here we don't want
any of
this okay this one I don't think we want
either or at least this
one okay now let's try building it
again the Do Run
or we might be
struggling half the time in this next ER
just uh trying to get the VM to
run all right should be fairly quick and
now let's do
the command here again and hopefully
that's just going to work qel pars
conso I so I know that we can pass these
arguments within the uh configuration so
like that it adds it by default not sure
about this one though be interesting to
figure out I want this to work kind of
by
default all right let's
see seems to be going fine so far and we
are even have the automatic login
here looks pretty good all right so and
here what is really nice about this VM
config is that there is a configuration
file in ETC nexs we can addit that and
we can rebuild within the
VM so console is that is might already
be the default interesting so we might
not need that after
all uh so we can we can do things in
here um and actually in this case I want
to add
it I should really add this to the
default template I want to have like a
module lnx where I put the things
specific for this n
hour mod n and now in here we're going
to do we're going to change the NY Dash
path setting so that's a NY settings so
it's uh ny. settings. n- path and then
what do we want uh so this would be kind
of a way to configure the NY path on
like a global
level uh we can
do like next packes or or we don't even
need to use an next pack you can use
anything here really we could even do uh
let's do uh text equals and then we're
going to write a brief file like
builtins do2 file I guess text and then
we're just going to put text like um
hello into this
file all right and even that should in
theory
work so let's try that I have a VM
switch script here which allows me to
rebuild within the VM oh yeah and I can
check the the Run VM script to
see uh whether it has the argument by
default so we can briefly do that result
bin run Nexus
VM
uel um
params oh
uh here they are consult TT
y z and there it's TTY s z maybe that's
important I guess
uh well I guess I could run it could I
run it once
more I think I even I think I
can let's try it out result in run Nexus
VM and then no
graphic like
this oh there's also a TTY as
zero oh it did work although we didn't
see the boot up dialogue so I guess that
might be the reason that one is
added um
anyways here we go get
that um okay so we rebuild this here
let's briefly check that we have
next we have that setting so next PATH
equals that now let's see what what uh
kind of next I guess let's use n
rapple so builtins next
PATH and okay so we can we can see this
we can resolve that text file and we can
even do like a built-in. read
file on that to get the string back all
right uh but now the bug if we set the
next PATH environment variable it
shouldn't work so let's do like so this
should work find file
text does but if we set next PATH equals
let's for example say text equals uh
configuration Mi oh uh there's some
terminal breakage
reset should hopefully
help uh no it's kind
of ter uh
does this work oh no it's all messed
up um this did actually
work okay hold on let's exper next PATH
next PATH equals uh text
equals all
right no instantiate find file
text that did work I'm kind of surprised
is it that Dash I doesn't work or am I
on a the wrong next version or was this
fixed at some
point um food does not exist will be
ignored that's fair uh will typ
this um actually it didn't work right
yeah right we set the next PATH to
configuration on next um Echo next PATH
yeah text equals F and right it doesn't
work that's what I wanted to show indeed
we get the original path not the one we
were
expecting and so yeah that um does mess
up some some things and is BU that
should be fixed at some point I think
there's even somewhere in
here oh yeah here this one great issue
by Valentine
where oh is it actually here
search paths somewhere there's a huge
table of all the ways next PATH can
interact with with each
other I can't find it right
now is it here
maybe maybe
not okay uh does not fall next PATH I
don't think that's
that is there next PATH presidence no
this one also no there's there's like
three Pi that try to fix this
um but yeah in in next packes the one
thing that doesn't work and actually
let's show this
here and and maybe actually this is just
going to shout out to get other people
to look into the ISS and try to fix it
because it's it's kind of really painful
and so a very common thing and I I
really recommend that too is to not use
channels I
well well not use channel so the next
Channel command it's just very stateful
I'm not a fan of it and so there's a
setting for that in NEX if you go to
configuration. next men configuration.
next there is channel enable or so yeah
next. channel. enable so whether the
next Channel command and state files are
made available on the
machine
um so if enabled these are initialized
and it's enabled by fault we don't want
that we want it to be more pure so let's
do that next. channel. enable equals
false and let's
um yeah let's let's rebuild in switch
meanwhile I'm going to go to the issue
that actually documents the
problem and so I saw
this let's go to next packages I think
let's just search for the for the option
that should be go next to channel.
enable here it
is so uh this is pi that introduced the
option this is Pier that reported the
problem
um yeah next channels or the next
Channel command especially is is major
problem I want to point out that the
channel concept goes further than just
next Channel so actually I think this is
the best page to view it Chels are
really on the more fundamental level
there are just a way to kind of uh
test test code before it gets kind of
pushed and and so channels is you kind
of distribution mechanism uh it doesn't
directly relate to next Dash channel
it's actually endpins also supports
fetching from channels which has
advantages like fetching from like
fetching the programs. SQ database
allowing kind of buil-in
uh by default you can you can find the
uh have the command not found thing work
and we covered that in the nixar like a
couple weeks ago I
think uh but yeah so next Channel we
don't want any of that uh let's see if
it worked so let's do like next
Channel help next Channel command not
found that's what I was hoping for um
but but now the problem maybe we'll go
into
here an empty next
PATH uh it seems that empty next PATH
also makes next the next PATH have no
effect because next path is always
ignored ah yes so if we let's actually
look for next PATH is right now I might
need to reload the terminal for that to
yeah uh let's do like a
bash and this that is that Reloaded it
is
not how can we reload the terminal
within the VM I guess we can log
out log
out and it automatically locks me back
in that's that's interesting Echo next
PATH yeah so now it's set to the to the
value and so in here we have this but
now let's try next instantiate find file
next packages and we get this file was
not found in search path so this gets
back to this problem where right we can
set the NY path but if the NY Dash path
option is set in next. conon it's not
going to
apply and we can see this here next. con
next PATH is set to an empty
value um and we would expect to be able
to override this with uh the next PATH
environment
variable
um yeah and so there is is the idea of
putting the the entries here instead of
the uh the next PATH I think that also
has some problems associated with it um
where I'm not quite sure about that
right
now uh Flex are the second place
think oh I see all
right uh yeah and so actually I so
actually let's let's kind of emulate
kind of pinning things on a actually
let's compare the N path we have right
now to flakes because what we can do or
flakes by default has something like the
has a registry so next flag
registry uh list is
that what is
it registry oh it's just next registry
next
registry and uh let's actually for this
let's enable the Nyx command and pl
features DC
n
module we're going to do ny. settings.
experimental features I
believe that's how it
works next command and flex in this case
personally I don't use these features a
lot but uh they are very popular I would
hope they get stabilized at some point
though VM
switch yes uh so I mean I feel like we
should maybe do another next hour on
Flakes at some point I I think the kind
of fourth next hour I already did was
about flakes as well um but just kind of
updating on things um on what I think
about them but that's for another
time so
uh we have we enabled the experimental
features so now next
registry requires a sub command is there
like a
list list yes list
so okay we have this is registry and so
this is what makes things like next
search next packages has hello work or
hello like
this um actually is that how you use n
search I Ed it very much but yeah so so
this thing here is looked up in the
registry okay and we found hello that's
good and so if we let's actually look
into this registry can we there command
for well there's no command to directly
resolve a registry entry I
guess um so instead let's just do list
let's look what next packages points
to so we can find this right here so
next package points to this which is so
this is a kind of unstable reference or
an un uh an impure reference so
everybody well I could change the
registry and point it to something
somewhere completely different
furthermore this is also an impure
reference so this is the next packes
unstable Branch uh that updates
regularly as that actually updates based
on the channels being published
um and
so right we can do the next setion that
way we can also do uh next
eval oh can we actually do that next
eval next packages
Dash I don't think that
works
no kind of just want to get path to it
but maybe that doesn't work uh but in
any case we can pretty much do the same
thing with next PATH so if we set next
PATH well in this case it's won't
actually work because we have the next
dash pass setting in our in our
config so actually we should remove that
otherwise it's really hard to
demonstrate yeah let's do
that um next search valid as long as
your next PATH set oh does it use a next
PATH by
default
interesting um well I know at least next
build that definitely shouldn't use a
next PATH let's actually look man three
search um I think it uses I think it
uses the flakes yeah I I don't think it
should use the next PATH by default um
if you
use well yeah whatever let's let's try
the the next PATH thing so next registry
list so this is the registry now let's
mirror the next packages entry using a
next PATH so we do next PATH and now
what is the kind of input thing it's
next packages so we point NY packages to
this here now flakes has this uh
reference syntax thing uh there's
nothing like that in the old CLI
commands could also be added but we can
still just refer to GitHub to balls
directly so we can do github.com SL NEX
SL next packages and the next GitHub has
these
tarball uh entry points or end
points oh next pack is
unstable I think I said it correctly the
terminal doesn't display it nicely
though
Echo yeah so this is the value now and
now if we do next like next build next
packages d a a uh hello it's going to
fetch this uh this is based on the
tarball cach which I believe caches
things for an hour by default would be
nice if it uh going to use the E tag or
something to not refetch something if it
didn't change uh but yeah this works we
can this way kind of impurely resolve
hello the same way as next build next
pus uh hash hello does kind of the same
thing uh just I mean it's it's pretty
much the same
thing um but we can also do you can do
this with the registry you can do this
with the next PATH you can pin something
so if we say it's actually change the
registry it's going here Etc NEX
module uh what is the option to change
the registry let's look into that let's
let's use let's use um let's close some
windows for
one um let's use search. next.org nexos
options
registry next. registry
um I wish this was a bit more specified
how how it
works uh you can set it in
NEX registry type oh there is something
more here not sure why it doesn't
display maybe that's was a recent
addition so we can we can check that if
we switch to
unstable next. registry or maybe they
aren't displayed oh yeah here they are
okay
so and my terminal here is kind of
broken
registry
okay and ignore the weird Terminal
Glitches so we can say next packages
then we need
a we need from so that's next packages
we need
A2 uh in this case well we need to use a
flight graph so let's use this next
packages now we can pin it to a specific
commit
so let's just pick like the one from
Master
here this
one all right uh what else is is there
to
set
flake uh flake input from is Rewritten
what so we from the flake reference to
be
Rewritten flake input ROM is written
Rewritten what I don't get what this is
meaning to
say um
huh
flake
what hold on is flake even
used oh I guess it's it's used for the
two thing oh I see if we set
two we don't need to set the flake thing
okay and um yeah okay that should be
fine okay uh let's just verify this
actually
is what we think it is that looks kind
of
correct um now we don't need to change
the registry using the system there's
also ways to change it in like per user
and uh I think per project as well
yes um what is this registry from is not
type of attribute set
of uh what R oh that's a reference
attribute okay yeah I wish there was an
example
SOC NEX
module uh so I'm just reading chat
briefly okay I think that's all going
good
there so uh we need oh God this is
terrible actually let me let me do a
what if I do a
reset what if I do a log
out let's see if that helped at
all yes it did
okay so we have we need to say type
indirect
indirect uh ID equals next
packes
okay then two
type oh and now we need we need to
specify the entire thing
here um can we not just specify the path
directly maybe not to make default type
path oh so that's like oh so if you said
like this redirects it to a path I
suppose yes
okay so
two oh uh how do we do this type equals
GitHub
um I need I need the reference
here uh I think that's like fetch Tre
which
is unstable but fetch Tre it should
somewhere document this this
format here I think yeah get
oh subject to
change and uh they're not documented
here type GitHub owner reper okay
this is kind of what I'm looking
for owner NEX this is turning into flake
lesson
here repo next pack is now rev I'm
hoping
H doesn't really say oh here it
is uh commit hash
yes
okay this one right
here he does this work now G
switch ah yes path we oh yeah we can use
Etc next package as well
um oh I see with flake we can pass a
flake input
directly uh well I think this works now
let's see next registry list it should
show it
doesn't it sure doesn't um registry.
Json let's pipe that into JQ which I
don't have available here
um yeah
this this is something I I really wish
that was stable already a way to fetch
well you you can get a shells without
all the GCC stuff it's really pointless
to download this for when you just need
a
binary so next registry uh actually
jq. Etc uh now
next oh no isn't etc etc next registry.
Json I mean it looks correct to
me
um yeah hold on mix
registry list oh okay wait this Global
oh system here ah here it is okay so I
guess the system one overrides the
global one so if we do
n um how can we verify this actually
let's do like a n build- v next PES hash
hello okay uh CC 5B is being downloaded
and I think that's the one I copy yeah
CC
5p okay so that works we can pin stuff
with the flate
registry and now actually I think
there's also a command to do that so
next registry help add
so this uh can modify the user flake
registry so that's specific to each
user pin a flake to its
current registry
okay but yeah so we kind of do pretty
much the same thing with next PATH so
all we do is next pathal next PES equals
then we need a way to refer to it we use
the tower ball syntax um next West next
packages uh tar ball and now we copy the
hash like this now if we do next
build then we use next PES d a hello
should give us exactly the same the same
B
even oh we can use built-in. get flake
next packages to resolve these all
right yep so that's exactly the same
thing
um I had a thought there um oh yeah
right uh so the kind of neat thing here
is as well that there's this kind of Mag
magical kind of Channel syntax here so
actually this is fairly simple like
that and this way you can still use
channels but this actually I mean this
just resolves to the channel URL which
is something like channels. nexus. org
fetches it from there so that way you
also get things like
um the programs. sqi database with
it and we can try that and that should
also
work oh and we
can
well I think CH like channels on their
own should also be deprecated at some
point but flakes currently doesn't
really have a good answer for that so I
mean I keep mentioning it the programs.
sqi database just doesn't have a way to
be represented in right now and it is a
very useful
concept um okay
so uh we have that uh actually is there
anything big missing that we haven't
covered I guess are there any questions
about anything we just talked
about um otherwise I feel like we can
probably end it a bit
early we
have the
registry um oh yeah and actually let's
let's also try this
so let's do like a I believe is the home
directory Al Mir I'm not sure let's just
put it in here EC NEX let's do a make
Deer
Lake and then fl. next so if you put
actually I wanted to try this a bit more
but I might we might not have enough
time but if you just use outputs equals
next package is here dot dot dot and
let's just do next packages like result
equals next packages dot does this work
result next pack.
R and
um probably not let's try
though yeah string well set was
expected uh so let's do result equals
this just want to quick evaluate
something so next
result there we get
that um but without well I guess in this
case it created the lock file for us so
it locked it uh and so if you don't
commit this lock file though these
references in a flight. next file
work pretty much the same as a lookup
path so if we do like the same in
in uh stable
mix so let's say I mean yeah the thing
you probably have seen like million
times this year very convenient for
testing things but um it is impure so if
we do this kind of works the same way we
can do next build uh yeah just next
build in this case
oh oh right it's with import next
packages see m times and spell it wrong
so yeah that also works that then uses
the next PATH to resolve that so very
similar F does provide a way to resolve
like automatically lock these references
uh personally I prefer the way of of
endpins of like explicitly saying that I
want to lock a specific input and uh for
for most cases you don't really need
these kind of impure references but they
do allow solving the issue of having too
many instances of next packages uh in
your your like lock files and uh if you
if you want to read more about that you
can you can check out this blog post by
Jones or
simbat uh which kind of talks about that
where right if you depend on some flages
and each of them pins their own next
package and packages and so on you get
kind of an explosion of the lock file
um and that could be like if if like
somehow
allowed pinning the Nyx path as well and
actually have a proposal for that kind
of in a draft stage like imagine you
could say uh in here something like um
next PATH you could say like this uh
next packages equals so this is not
exactly my proposal but can it goes in
that direction you could say so we Pinn
next packages two let's do like okay we
have an input specification here and we
output n PES or outpath something like
that so this would kind of mean whenever
in this pure evaluation any kind of Nyx
file refers to Nyx packages in a lookup
path so something like this it would
resolve to this pinned next packages so
benefit you can kind of you don't have
to use the follows mechanism to try to
make all of your dependencies use the
same next packages which really gets out
of hand and and there is no good way to
ensure it works for everything uh if you
use this you can can tell dependencies
okay you can you can use a next packes
and dependencies could even check like
is there NY packes in the NY pth that I
can use and if there is I'll I'll just
use that and and libraries can also kind
um decide that like do I want a pin
packages for my own uh for my own flake
or would I be willing to use a next
packages from the parent flake uh from
the flake that Imports me something like
that I think there's there's something
there to to fix some issues with
flakes all right uh I um I think this is
probably good for today I'm going to
power off and uh yeah if there there
aren't any other questions let's end it
here and I wish you all a very good day
and uh see you next time
