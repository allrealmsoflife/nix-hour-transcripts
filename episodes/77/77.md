[![Watch on youtube](https://img.youtube.com/vi/CJFX-UU6Fzc/0.jpg)](https://youtu.be/CJFX-UU6Fzc?list=PLyzwHTVJlRc8yjlx4VR4LU5A5O44og9in)

hello and welcome to the next nix-hour

if you have an issue you want to be looked at in one of these

you can do so by opening an issue here https://github.com/tweag/nix-hour

today we'll look at language tooling again

we've done that for three times now although with various different questions

but yeah we got these questions 2 weeks ago

and I thought might be good to take a look at them and just going to see if we
can make anything work there

> visits https://github.com/tweag/nix-hour/issues/20#issuecomment-2165281615

so um we have `yarn2nix` maybe a bit of background there I think there were two
yarn2nixes.

> duckduckgo yarn2nix

> https://github.com/nix-community/yarn2nix
>
> https://github.com/Profpatsch/yarn2nix

are they these two?

or is one redirect to the other no it's actually a separate one

yeah this is a different one so, it's very confusing

and there's actually this repo https://github.com/nix-community/yarn2nix

but it's also in nixpkgs

so if we look for files and go to `yarn2nix` there's that in here

> visits https://github.com/NixOS/nixpkgs
>
> `t` keyboard shortcut for file search
>
> search for yarn2nix

`yarn2nix-moretea` and I think that's the one in `nix-community` which was
originally by moretea

and so that's probably why it's archived here

okay yeah I think that's the story

so I think the actual `yarn2nix` version that is being used mostly is the one in
nixpkgs

so question

> reads https://github.com/tweag/nix-hour/issues/20#issuecomment-2165281615

is so not well documented

for example `signal-desktop` is using deb package instead of building from
source

let's see what is that

> clicks
> https://github.com/NixOS/nixpkgs/blob/nixos-24.05/pkgs/applications/networking/instant-messengers/signal-desktop/signal-desktop-aarch64.nix

oh I see it's not well documented so people are using this instead

let's see generic

> visits
> https://github.com/NixOS/nixpkgs/blob/nixos-24.05/pkgs/applications/networking/instant-messengers/signal-desktop/generic.nix

is that using `yarn2nix`? _search for yarn2nix no results_

no that's not using `yarn2nix`

okay so signal is packaged like this but I guess it's a yarn package so it could
be packaged with `yarn2unix` hopefully

while the repository has yarn.lock

trying to build it results in an error that should have been resolved

if I understand correctly so it's that

I mean let's try this out so I'll copy this one

and let's just make that work or well let's try

it's number 77

```console
$ cd nix-hour/code
$ mkdir 77
$ cd 77
```

I guess let me copy the template that I have here

```console
$ cp ../../templates/vm . -r
```

vm

```console
$ mv vm/* .
```

let's copy all of these into here

```console
$ rmdir vm
rmdir: failed to remove 'vm': Directory not empty
$ rm -rf vm
```

so this as a a VM with it

(um but uh let's see)

in the default.nix there just some some like standard stuff to get a nixpkgs

and then down here I'll do one of these

I'll do uh

```nix
lib.makeScope pkgs.newScope (final: {

    signal = pkgs.callPackage ./signal.nix { };

})
```

and like this all right signal.nix

copy that one in oh not right oh oh how did I do that okay we're back

copy it in _copies from github issue comment_

```nix
{mkYarnPackage, fetchFromGitHub}:

mkYarnPackage rec {
    pname = "signalapp";
    version = "7.12.0";

    src = fetchFromGitHub {
        owner = "signalapp";
        repo = "Signal-Desktop";
        rev = "ccad9a8f0137941f6f69eadc02e0fe718709a503";
        hash = "sha256-FRVlOxqnvYl5cujio9WOD9Vs6XiLBn3KGNWRNy5vSaQ=";
        fetchSubmodules = true;
    };
}
```

ah finally

and then let's try building it

so `cd nix-hour/code/77` and we build the signal one

```console
$ nix-build -A signal
... runs in background ...
```

uh we have a comment

> Yuriy Taraday I think you have to use upstream binaries for Signal client, or
> they won't like you.

um I guess that could be a _chukles nervously_

um there could be one of their like uh like that you can't distribute it uh with
your own builds

um I guess I won't distribute this myself but if someone does want to try that,
might have to make sure that's fine

_opens fzf directory chooser inside nixpkgs local checkout_

um maybe I'd hope that's even pointed out in the GitHub discussions or somewhere
in uh on the signal package

uh let's see active modules, which one is it?

instant messagers signal desktop this one

```console
$ cd nixpkgs/pkgs/applications/networking/instant-messengers/signal-desktop
$ ls -1
generic.nix
default.nix
signal-desktop-aarch64.nix
signal-desktop-beta.nix
signal-desktop.nix
update.sh
```

um let's see binary is there anything in here

```console
$ rg binary -i
generic.nix
187:    sourceProvenance = with lib.sourceTypes; [ binaryNativeCode ];
```

binary native code um might need might be on GitHub somewhere

anyways we're trying to build it anyways

so it's uh well it's going here

and let's see maybe let's read the error message a bit more closely

_opens https://github.com/tweag/nix-hour/issues/20#issuecomment-2165281615_

_navigates to
https://discourse.nixos.org/t/mkyarnpackage-lockfile-has-incorrect-entry/21586_

> so I'm trying to build `marp-cli` with `yarn2nix` however the the build
> complains with

> couldn't find any versions of pug that matches "^2.0.3"

> and the lock file has incorrect entry for `pug-runtime`. Ignoring it

that doesn't seem super related

> possible versions are these usually caused by a missing...

um by missing what?

> entry in the lock file running yarn without the --offline flag

okay

um minimal flake to reproduce

and the error there was

or the solution there

_navigates to https://github.com/NixOS/nixpkgs/pull/214952_

fix uncopied resolutions field

> yarn only uses the resolutions field in the top level package of a workspace
> well has been taken into account for makeYarnWorkspace

uh this is in nixpkgs

> it has not been fixed for mkYarnPackage yet, which also uses the yarn
> workspace mechanism under the hood

okay

well let's see

hoping this this is going to finish relatively soon or error (nix-build -A
signal running in the background)

_laughs_

um okay well let's let's read a bit more here let's see what the actual fix was
here

maybe also get a bit familiar with the codebase

_opens https://github.com/NixOS/nixpkgs/pull/214952/files_

uh so we have `workspaceJSON` maybe let's expand this I'm going to view the file

_opens
https://github.com/GuillaumeDesforges/nixpkgs/blob/6bf78d8d3d07a77c043b68f3795a250257a23b21/pkgs/development/tools/yarn2nix-moretea/yarn2nix/default.nix_

and uh where was that `workspaceJSON`

_goes to
https://github.com/GuillaumeDesforges/nixpkgs/blob/6bf78d8d3d07a77c043b68f3795a250257a23b21/pkgs/development/tools/yarn2nix-moretea/yarn2nix/default.nix#L104_

> build time JSON generation to avoid IFD

um okay and what does this do?

well maybe maybe let's look at this

_goes back to https://github.com/NixOS/nixpkgs/pull/214952/files_

the resolutions

seems like uh maybe not

oh this might be tricky to figure out and it still doesn't fail

would be good to have a reproducible example there

um let me read a bit more here

_reads https://github.com/tweag/nix-hour/issues/20#issuecomment-2165281615_

> results in an error that should? have been resolved and if we look at the lock
> file those packages that yarn2nix can'tfind are indeed empty packages put
> there by the signal team

_opens
https://github.com/signalapp/Signal-Desktop/blob/af1c593fef4e485127ea356b3b592f3c781c2a16/yarn.lock#L7620_

um these here

oh I see they don't have an integrity field

and why might that be it

um registry yarn package nop canvas nop

what is that seems kind of something odd here

maybe it's something that yarn supports

that uh isn't supported by `yarn2nix`

and actually I've been pointed by Yuri to another uh kind of yarn thing which is
kind of newer and maybe that is going to work better

[yarn-plugin-nixify](https://github.com/stephank/yarn-plugin-nixify)

so maybe we could also try that out if if this fails and we can't figure it out

and this is kind of newish it looks like

so it might work better

um and let's also see what this does maybe actually let's go to `yarn2nix` first
and and see what how that actually works

so in order to do that

_goes to
https://github.com/NixOS/nixpkgs/tree/master/pkgs/development/tools/yarn2nix-moretea/yarn2nix_

here it is yarn2nix is there a read me? there's no read me

um is there is there documentation in the nixpkgs manual?

_opens https://nixos.org/manual/nixpkgs/unstable_

I'd hope so

`yarn2nix`

um it's not it it's not it I'm just going to grep through here

`yarn2nix` this is in the JavaScript section

_goes to https://nixos.org/manual/nixpkgs/unstable/#javascript-yarn2nix_

> [!WARNING]
>
> As of nixpkgs Version 25.05pre-git
>
> WARNING: The yarn2nix functions have been deprecated in favor of the new
> yarnConfigHook, yarnBuildHook and yarnInstallHook. Documentation for them
> still appears here for the sake of the packages that still use them. See also
> a tracking issue [#324246](https://github.com/NixOS/nixpkgs/issues/324246).
>
> No such warning at the time of this video which was 24.11pre-git

> okay so preparation you need the lock file um if they contain package.json
> they can be used like this

so this is the preparation okay `fetchYarnDeps`

> and then mkYarnPackage will by default to try generate binary for _blah blah
> blah_

okay so mkYarnModules

> will generate derivation including the node_modules directory

okay

> overriding dependency behavior, pitfalls

um okay that is something

is there uh let's see `fetchYarnDeps`, `mkYarnPackage` there's not actually a
good example of `mkYarnPackage` in here is there?

_searches for mkYarnPackage in manual_

um okay well it links to this which might give us some clues

_opens https://github.com/search?q=mkYarnPackage+language%3ANix&type=code_

yeah that does

but okay uh docs yeah docs aren't great

and so make.. right we might need to actually look into a bit more how it works

maybe also like

is there some docks in the original one? so like on the nix-community one?

_goes to https://github.com/nix-community/yarn2nix_

uh installation instructions, requirements

there's an example here so that's good

um `yarn.lock` `yarnNix`

oh this might be tricky

let's see

it failed! well we have an error at least, that's good

<details open>
<summary>Collapse</summary>

```nix
...
ommited
...
success Set "yarn-offline-mirror" to "/nix/store/7jwwv5ddyglvbch5gdw5af9fyz0rw5w4-offline".
Done in 0.05s.
yarn install v1.22.19
[1/4] Resolving packages...
warning Lockfile has incorrect entry for "canvas@^2.6.1". Ignoring it.
warning Lockfile has incorrect entry for "jsdom@^15.2.1". Ignoring it.
error Couldn't find any versions for "canvas" that matches "^2.6.1" in our cache (possible versions are ""). This is usually caused by a missing entry in the lockfile, running Yarn without the --offline flag may help fix this issue.
info Visit https://yarnpkg.com/en/docs/cli/install for documentation about this command.
Error: Couldn't find any versions for "jsdom" that matches "^15.2.1" in our cache (possible versions are ""). This is usually caused by a missing entry in the lockfile, running Yarn without the --offline flag may help fix this issue.
    at MessageError.ExtendableBuiltin (/nix/store/yickii092b1il40gdjd65nvwx32ss7rb-yarn-1.22.19/libexec/yarn/lib/cli.js:721:66)
    at new MessageError (/nix/store/yickii092b1il40gdjd65nvwx32ss7rb-yarn-1.22.19/libexec/yarn/lib/cli.js:750:123)
    at NpmResolver.<anonymous> (/nix/store/yickii092b1il40gdjd65nvwx32ss7rb-yarn-1.22.19/libexec/yarn/lib/cli.js:50438:15)
    at Generator.next (<anonymous>)
    at step (/nix/store/yickii092b1il40gdjd65nvwx32ss7rb-yarn-1.22.19/libexec/yarn/lib/cli.js:310:30)
    at /nix/store/yickii092b1il40gdjd65nvwx32ss7rb-yarn-1.22.19/libexec/yarn/lib/cli.js:321:13
error: builder for '/nix/store/3na9dj7k9w87mygvjv23sd8fnq9r3pb8-signal-desktop-modules-7.12.0.drv' failed with exit code 1;
       last 20 log lines:
       > patching sources
       > updateAutotoolsGnuConfigScriptsPhase
       > configuring
       > building
       > yarn config v1.22.19
       > success Set "yarn-offline-mirror" to "/nix/store/7jwwv5ddyglvbch5gdw5af9fyz0rw5w4-offline".
       > Done in 0.05s.
       > yarn install v1.22.19
       > [1/4] Resolving packages...
       > warning Lockfile has incorrect entry for "canvas@^2.6.1". Ignoring it.
       > warning Lockfile has incorrect entry for "jsdom@^15.2.1". Ignoring it.
       > error Couldn't find any versions for "canvas" that matches "^2.6.1" in our cache (possible versions are ""). This is usually caused by a missing entry in the lockfile, running Yarn without the --offline flag may help fix this issue.
       > info Visit https://yarnpkg.com/en/docs/cli/install for documentation about this command.
       > Error: Couldn't find any versions for "jsdom" that matches "^15.2.1" in our cache (possible versions are ""). This is usually caused by a missing entry in the lockfile, running Yarn without the --offline flag may help fix this issue.
       >     at MessageError.ExtendableBuiltin (/nix/store/yickii092b1il40gdjd65nvwx32ss7rb-yarn-1.22.19/libexec/yarn/lib/cli.js:721:66)
       >     at new MessageError (/nix/store/yickii092b1il40gdjd65nvwx32ss7rb-yarn-1.22.19/libexec/yarn/lib/cli.js:750:123)
       >     at NpmResolver.<anonymous> (/nix/store/yickii092b1il40gdjd65nvwx32ss7rb-yarn-1.22.19/libexec/yarn/lib/cli.js:50438:15)
       >     at Generator.next (<anonymous>)
       >     at step (/nix/store/yickii092b1il40gdjd65nvwx32ss7rb-yarn-1.22.19/libexec/yarn/lib/cli.js:310:30)
       >     at /nix/store/yickii092b1il40gdjd65nvwx32ss7rb-yarn-1.22.19/libexec/yarn/lib/cli.js:321:13
       For full logs, run 'nix log /nix/store/3na9dj7k9w87mygvjv23sd8fnq9r3pb8-signal-desktop-modules-7.12.0.drv'.
error: 1 dependencies of derivation '/nix/store/srnckdqs1wp7vkj3bsxs9c0cbipgsy9w-signal-desktop-7.12.0.drv' failed to build
```

</details>

so

> couldn't find any versions for canvas

and so yeah that's the error we saw

> Lockfile has incorrect entry for canvas ignoring it

um we could maybe try

um try to see the dependency graph

sometimes useful to kind of see what the intermediate steps are because I think

there's probably a derivation that builds all the dependencies and one that then
uses them

so I'm going to use -Q what should it be? references I think immediate
dependencies of the store path

`nix-store -q --references ...`

um but actually we don't have a store path yet

we only have this
`/nix/store/srnckdqs1wp7vkj3bsxs9c0cbipgsy9w-signal-desktop-7.12.0.drv` and so
might actually not work directly

no actually that should work

```console
$ nix-store -q --references /nix/store/srnckdqs1wp7vkj3bsxs9c0cbipgsy9w-signal-desktop-7.12.0.drv
/nix/store/v6x3cs394jgqfbi0a42pam708flxaphh-default-builder.sh
/nix/store/09wshq4g5mc2xjx24wmxlw018ly5mxgl-bash-5.2-p15.drv
/nix/store/7ja36s1x32g3cn3acga4faciqyn5gsw8-source.drv
/nix/store/cx5j3jqvvz8b5i9dsrn0z9cxhfd8r73p-stdenv-linux.drv
/nix/store/n4k6jdxal9annipfx09h578n64xavkzy-nodejs-18.18.2.drv
/nix/store/j3d69jh8gvia1jwadk3dxddj7mbijlbk-yarn-1.22.19.drv
/nix/store/3na9dj7k9w87mygvjv23sd8fnq9r3pb8-signal-desktop-modules-7.12.0.drv
/nix/store/imk0yxvcx0fw32yp7q0wx5c2932vnjcq-rsync-3.2.7.drv
/nix/store/pby2lh0dg27nk1yzgcfx8529lf6zjj30-fixup_bin.js
```

it's going to print the derivations it depends on

yeah this is the one I'm looking for
`/nix/store/3na9dj7k9w87mygvjv23sd8fnq9r3pb8-signal-desktop-modules-7.12.0.drv`

signal-desktop-modules and so that's a derivation, derivation suffix

I'm going to use

```console
$ nix-store --realise /nix/store/3na9dj7k9w87mygvjv23sd8fnq9r3pb8-signal-desktop-modules-7.12.0.drv
```

to get the

_same error as above_

oh that's the one that fails

...I see

right

`error: 1 dependencies of derivation '/nix/store/srnckdqs1wp7vkj3bsxs9c0cbipgsy9w-signal-desktop-7.12.0.drv' failed to build`

it's said here dependencies of the derivation failed to build

it's good

and we could have also get it gotten it here

`error: builder for '/nix/store/3na9dj7k9w87mygvjv23sd8fnq9r3pb8-signal-desktop-modules-7.12.0.drv' failed with exit code 1;`

yeah builder for this derivation failed

uh let me just see what what does that derivation do I'm going to look at show
derivation

`nix show-derivation /nix/store/3na9dj7k9w87mygvjv23sd8fnq9r3pb8-signal-desktop-modules-7.12.0.drv`

so this prints a json of all the derivation attributes

`nix show-derivation /nix/store/3na9dj7k9w87mygvjv23sd8fnq9r3pb8-signal-desktop-modules-7.12.0.drv | jq`

we can see here things like `inputDrvs` these are all the things it depends on

uh source `/nix/store/7ja36s1x32g3cn3acga4faciqyn5gsw8-source.drv` I guess
that's the source of the uh package we're trying to build

there's this workspace-package.json thing

and obviously there's yarn, nodejs

fixup_yarn_lock, that looks kind of relevant

uh maybe let's look at these couple here

so workspace-package.json um let's just do a realize on that

```console
$ nix-store --realise /nix/store/d75ffkc2drxj8bw47vp1cl4vrp931yyp-signal-desktop-modules-7.12.0-workspace-package.json.drv
warning: you did not specify '--add-root'; the result might be removed by the garbage collector
/nix/store/vahfkis9m8llgprh0fjfn766jqsxc86r-signal-desktop-modules-7.12.0-workspace-package.json
```

see what that contains

```console
$ cat /nix/store/vahfkis9m8llgprh0fjfn766jqsxc86r-signal-desktop-modules-7.12.0-workspace-package.json
{
  "private": true,
  "resolutions": {
    "@mixer/parallel-prettier/prettier": "2.8.0",
    "@storybook/react/@storybook/core/node-fetch": "2.6.1",
    "@types/react": "17.0.45",
    "@types/react-dom": "17.0.17",
    "dmg-license": "https://registry.yarnpkg.com/nop/-/nop-1.0.0.tgz",
    "fabric/canvas": "https://registry.yarnpkg.com/nop/-/nop-1.0.0.tgz",
    "fabric/jsdom": "https://registry.yarnpkg.com/nop/-/nop-1.0.0.tgz",
    "fast-glob/glob-parent": "5.1.2",
    "read-last-lines/mz/thenify-all/thenify": "3.3.1"
  },
  "workspaces": [
    "deps/**"
  ]
}
```

uh there's resolutions in here is that the same one as the one in signal?

we could do well.. let's keep that open somewhere

let me open that here _new terminal with nvim_

`nvim /nix/store/vahfkis9m8llgprh0fjfn766jqsxc86r-signal-desktop-modules-7.12.0-workspace-package.json`

uh and let's compare that to the source

I'll look at I'll get the source from here there's various ways of getting the
source

but since we have it right here let's do that

also realize that

```console
$ nix-store --realise /nix/store/7ja36s1x32g3cn3acga4faciqyn5gsw8-source.drv
warning: you did not specify '--add-root'; the result might be removed by the garbage collector
/nix/store/jfmxg4j30hdp5vx2ybdsc1a8flh3cjmr-source
```

here's the source

let's go let's use pushd

```console
$ pushd /nix/store/jfmxg4j30hdp5vx2ybdsc1a8flh3cjmr-source
/nix/store/jfmxg4j30hdp5vx2ybdsc1a8flh3cjmr-source ~/nix-hour/code/77
```

pushd allows us to get back easily with `popd` later

it's kind of like a directory stack

so we'll look at the package.json file here `vim package.json`

okay that's a separate one

so right let see workspace-package.json

is there a workspace-package.json in here?

...there isn't

okay so it's kind of generated

let's let's look at the source for that

open another window down here

`cd nixpkgs/pkgs/development/tools/yarn2nix-moretea`

```console
$ rg workspace
default.nix
78:    workspaceDependencies ? [], # List of yarn packages
... ommited ...
389:        workspaceDependencies = workspaceDependenciesTransitive;
```

`workspaceDependencies` yes there's some generation going on

I think the default.nix might be the biggest one here

and let's see uh workpace

how does that actually work

so let's go from the from the

`popd` here

let's go from the actual thing we're calling _opens signal.nix_

and that's `mkYarnPackage`

_opens nixpkgs/pkgs/development/tools/yarn2nix-moretea/default.nix_

so we go into, not `mkYarnModules` but `mkYarnPackage`

just kind of understand this a bit more

```nix
mkYarnPackage = {
  name ? null,
  src,
  packageJSON ? src + "/package.json",
  yarnLock ? src + "/yarn.lock",
  yarnNix ? mkYarnNix { inherit yarnLock; },
  offlineCache ? importOfflineCache yarnNix,
  nodejs ? inputs.nodejs,
  yarn ? inputs.yarn.override { inherit nodejs; },
  yarnFlags ? [ ],
  yarnPreBuild ? "",
  yarnPostBuild ? "",
  pkgConfig ? {},
  extraBuildInputs ? [],
  publishBinsFor ? null,
  workspaceDependencies ? [], # List of yarnPackages
  packageResolutions ? {},
  ...
}@attrs:
```

so we take a whole bunch of arguments and actually these are the ones that would
ideally be documented

uh we can see it looks at the package.json from the source

so we pass the source it looks at that file uh

the yarn.lock, `mkYarnNix` what does `mkYarnNix` do?

```nix
# Generates the yarn.nix from the yarn.lock file
mkYarnNix = { yarnLock, flags ? [] }:
  pkgs.runCommand "yarn.nix" {}
  "${yarn2nix}/bin/yarn2nix --lockfile ${yarnLock} --no-patch --builtin-fetchgit ${lib.escapeShellArgs flags} > $out";
```

> generate a `yarn.nix` from the yarn.lock file

um not sure why this is necessary here

`importOfflineCache`

```nix
importOfflineCache = yarnNix:
  let
    pkg = callPackage yarnNix { };
  in
    pkg.offline_cache;
```

and that does a `callPackage` that seems a bit weird

oh I see so it calls the `yarn2nix` tool to generate a nix file from the
yarn.lock file

can we also look at the yarn.nix file I wonder

So like um `yarnNix` would be the thing we look for

uh yeah `yarnNix` let's grep for that and see if it's exported anywhere

removeAttrs, yarnNix

um yeah right now we we're already outside the function here

so let's get back here

I don't think it's exposed anywhere so here pass through that's how we could get
access to it

um I guess we are in nixpkgs right here so we could actually just add it

um maybe let's do that why not

```nix
passthru = {
  inherit package packageJSON deps;
  workspaceDependencies = workspaceDependenciesTransitive;
  inherit yarnNix;
} // (attrs.passthru or {});
```

like `inherit yarnNix` and um or maybe what was it the offline cache maybe
that's the more relevant one

```nix
passthru = {
  inherit package packageJSON deps;
  workspaceDependencies = workspaceDependenciesTransitive;
  inherit offlineCache;
} // (attrs.passthru or {});
```

and with that I think we should be able to do something like this in here

well we need to get the actual nixpkgs here

I'm going to import the one from my home directory instead

_cd back to nix-hour/code/77_

```nix
# file: default.nix
let
    pkgs = import ~/src/nixpkgs/main {
        config = {};
        overlays = [];
        inherit system;
    };
    inherit (pkgs) lib;
in
```

uh so that's the the current version here and that's useful for debugging often
times

so signal dot now we should get offline cach here yep

```console
$ nix-build -A signal.offlineCache
```

let's see can we build that is that a buildable thing?

_cancels above build_

```console
$ nix-instantitate --eval -A signal.offlineCache
```

oh maybe it's not even oh I guess uh oh no it fetches everything again? won't it

yeah that kind of sounds like it

um we could to make that work

so I have uh npins here actually I removed this `use nix` when I copied the
files uh not properly

```console
$ echo 'use nix' > .envrc
$ direnv allow
direnv: loading ~/nix-hour/code/77/.envrc
direnv: using nix
error:
       … while evaluating the file '/home/tweagysil/nix-hour/code/77/shell.nix':

       error: attribute 'shell' missing
       at /home/tweagysil/nix-hour/code/77/shell.nix:1:1:
            1| (import ./default.nix { }).shell
             | ^
            2|
direnv: nix-direnv: Evaluating current nix shell failed. Falling back to previous environment!
```

no wait shell is missing

all right I removed the shell as well okay let's get the shell back here

```nix
# file: default.nix
  signal = ...;

  shell = pkgs.mkShell {
    packages = [
      pkgs.npins
    ];
  };
})
```

copy undo redo stuff like that

um by the way that's I think persistent undo redo in Vim something like that

so you can even if you close the file and jump back you can just get it uh

get the history again I think uh or is it an undo swap file something

undo redo, probably help undo in vim it's going to tell you more about that

um I see

> youtube chat
>
> James Sully :h udf

...

> youtube chat: Yuriy Taraday
>
> It's generating it dynamically in IFD if it is not provided ahead of time.

think that that's the case here it's not provided ahead of time

um but I want to do uh get npins

I just want to look at the version of nixpkgs that we've used here

```console
$ npins show
nixpkgs: (Nix channel)
    name: nixos-unstable
    url: https://releases.nixos.org/nixos/unstable/nixos-24.05pre554114.e92039b55bcd/nixexprs.tar.xz
    hash: 00yqc6qwaw8y1aq6zjpd27d3zz7bh14lr0ms080r22rdrg9yba78
```

it's this one so I'll actually check out the exact same version in my tree here

```console
$ git switch e92039b55bcd
fatal: a branch is expected, got commit 'e92039b55bcd'
hint: If you want to detach HEAD at the commit, try again with the --detach option.
```

um detach that's fine

```console
$ git switch e92039b55bcd --detach
error: Your local changes to the following files would be overwritten by checkout:
        pkgs/development/tools/yarn2nix-moretea/yarn2nix/default.nix
Please commit your changes or stash them before you switch branches.
Aborting
```

stash first

```console
$ git stash
Saved working directory and index state WIP on (no branch): 72f92f567f50 Merge pull request #322001 from bobvanderlinden/git-cola-4.8.0
```

switch to it

```console
$ git switch e92039b55bcd --detach
Updating files: 100% (33278/33278), done.
Previous HEAD position was 72f92f567f50 Merge pull request #322001 from bobvanderlinden/git-cola-4.8.0
HEAD is now at e92039b55bcd Merge pull request #270856 from trofi/kea-update
```

and stash pop

```console
$ git stash pop
Auto-merging pkgs/development/tools/yarn2nix-moretea/yarn2nix/default.nix
HEAD detached at e92039b55bcd
Changes not staged for commit:
  (use "git add <file>..." to update what will be committed)
  (use "git restore <file>..." to discard changes in working directory)
        modified:   pkgs/development/tools/yarn2nix-moretea/yarn2nix/default.nix
... ommited ...
```

okay so now we should have the exact same version

um did I do that properly? yeah I did

okay all right now it shouldn't rebuild anything

```console
$ nix-build -A signal.offlineCache
/nix/store/7jwwv5ddyglvbch5gdw5af9fyz0rw5w4-offline
```

and we'll just get the offline cache here, okay that worked

and let's see it's a directory

what does it have in here

```console
$ cd /nix/store/7jwwv5ddyglvbch5gdw5af9fyz0rw5w4-offline
$ ls
... ommited ...
```

oh that has a lot of things

```console
$ ls -l # eza
... ommited ...
lrwxrwxrwx - root  1 Jan  1970 y18n___y18n_3.2.2.tgz -> /nix/store/14i2mcspbrgj10xnhiqkwjw9pn4ha569-y18n___y18n_3.2.2.tgz
lrwxrwxrwx - root  1 Jan  1970 y18n___y18n_4.0.0.tgz -> /nix/store/58m2k9iim1gjx8d8ap73jk5m6vnsgh1j-y18n___y18n_4.0.0.tgz
lrwxrwxrwx - root  1 Jan  1970 y18n___y18n_5.0.5.tgz -> /nix/store/6l6b02xi10bmjyq9x1mjwh9b57yj911j-y18n___y18n_5.0.5.tgz
lrwxrwxrwx - root  1 Jan  1970 yaeti___yaeti_0.0.6.tgz -> /nix/store/h0dkd6psmwv5cnckyb4xv59m8pk6900z-yaeti___yaeti_0.0.6.tgz
... ommited ...
```

offlineCache...

um this this is kind of weird because these don't seem to exist right

stat of this

```console
$ stat /nix/store/14i2mcspbrgj10xnhiqkwjw9pn4ha569-y18n___y18n_3.2.2.tgz
  File: /nix/store/14i2mcspbrgj10xnhiqkwjw9pn4ha569-y18n___y18n_3.2.2.tgz
  Size: 3602            Blocks: 8          IO Block: 4096   regular file
Device: 0,33    Inode: 161632660   Links: 2
Access: (0444/-r--r--r--)  Uid: (    0/    root)   Gid: (    0/    root)
Access: 2025-02-17 12:17:22.000000000 +0530
Modify: 1970-01-01 05:30:01.000000000 +0530
Change: 2025-02-17 12:17:22.636020496 +0530
 Birth: 2025-02-17 12:17:22.636020496 +0530
```

oh no that does exist not sure why they're red here then

right let's just confirm this

```console
$ cat /nix/store/14i2mcspbrgj10xnhiqkwjw9pn4ha569-y18n___y18n_3.2.2.tgz
... bat warning binary file ...
```

yeah they do exist

okay so that's a cache and I guess there like if we try to build it again

uh let's just confirm that what we're looking for isn't there

<details open>
<summary>Collapse</summary>

```console
$ nix-build -A signal
these 2 derivations will be built:
  /nix/store/3na9dj7k9w87mygvjv23sd8fnq9r3pb8-signal-desktop-modules-7.12.0.drv
  /nix/store/srnckdqs1wp7vkj3bsxs9c0cbipgsy9w-signal-desktop-7.12.0.drv
building '/nix/store/3na9dj7k9w87mygvjv23sd8fnq9r3pb8-signal-desktop-modules-7.12.0.drv'...
patching sources
updateAutotoolsGnuConfigScriptsPhase
configuring
building
yarn config v1.22.19
success Set "yarn-offline-mirror" to "/nix/store/7jwwv5ddyglvbch5gdw5af9fyz0rw5w4-offline".
Done in 0.05s.
yarn install v1.22.19
[1/4] Resolving packages...
warning Lockfile has incorrect entry for "canvas@^2.6.1". Ignoring it.
warning Lockfile has incorrect entry for "jsdom@^15.2.1". Ignoring it.
error Couldn't find any versions for "canvas" that matches "^2.6.1" in our cache (possible versions are ""). This is usually caused by a missing entry in the lockfile, running Yarn without the --offline flag may help fix this issue.
info Visit https://yarnpkg.com/en/docs/cli/install for documentation about this command.
Error: Couldn't find any versions for "jsdom" that matches "^15.2.1" in our cache (possible versions are ""). This is usually caused by a missing entry in the lockfile, running Yarn without the --offline flag may help fix this issue.
    at MessageError.ExtendableBuiltin (/nix/store/yickii092b1il40gdjd65nvwx32ss7rb-yarn-1.22.19/libexec/yarn/lib/cli.js:721:66)
    at new MessageError (/nix/store/yickii092b1il40gdjd65nvwx32ss7rb-yarn-1.22.19/libexec/yarn/lib/cli.js:750:123)
    at NpmResolver.<anonymous> (/nix/store/yickii092b1il40gdjd65nvwx32ss7rb-yarn-1.22.19/libexec/yarn/lib/cli.js:50438:15)
    at Generator.next (<anonymous>)
    at step (/nix/store/yickii092b1il40gdjd65nvwx32ss7rb-yarn-1.22.19/libexec/yarn/lib/cli.js:310:30)
    at /nix/store/yickii092b1il40gdjd65nvwx32ss7rb-yarn-1.22.19/libexec/yarn/lib/cli.js:321:13
error: builder for '/nix/store/3na9dj7k9w87mygvjv23sd8fnq9r3pb8-signal-desktop-modules-7.12.0.drv' failed with exit code 1;
       last 20 log lines:
       > patching sources
       > updateAutotoolsGnuConfigScriptsPhase
       > configuring
       > building
       > yarn config v1.22.19
       > success Set "yarn-offline-mirror" to "/nix/store/7jwwv5ddyglvbch5gdw5af9fyz0rw5w4-offline".
       > Done in 0.05s.
       > yarn install v1.22.19
       > [1/4] Resolving packages...
       > warning Lockfile has incorrect entry for "canvas@^2.6.1". Ignoring it.
       > warning Lockfile has incorrect entry for "jsdom@^15.2.1". Ignoring it.
       > error Couldn't find any versions for "canvas" that matches "^2.6.1" in our cache (possible versions are ""). This is usually caused by a missing entry in the lockfile, running Yarn without the --offline flag may help fix this issue.
       > info Visit https://yarnpkg.com/en/docs/cli/install for documentation about this command.
       > Error: Couldn't find any versions for "jsdom" that matches "^15.2.1" in our cache (possible versions are ""). This is usually caused by a missing entry in the lockfile, running Yarn without the --offline flag may help fix this issue.
       >     at MessageError.ExtendableBuiltin (/nix/store/yickii092b1il40gdjd65nvwx32ss7rb-yarn-1.22.19/libexec/yarn/lib/cli.js:721:66)
       >     at new MessageError (/nix/store/yickii092b1il40gdjd65nvwx32ss7rb-yarn-1.22.19/libexec/yarn/lib/cli.js:750:123)
       >     at NpmResolver.<anonymous> (/nix/store/yickii092b1il40gdjd65nvwx32ss7rb-yarn-1.22.19/libexec/yarn/lib/cli.js:50438:15)
       >     at Generator.next (<anonymous>)
       >     at step (/nix/store/yickii092b1il40gdjd65nvwx32ss7rb-yarn-1.22.19/libexec/yarn/lib/cli.js:310:30)
       >     at /nix/store/yickii092b1il40gdjd65nvwx32ss7rb-yarn-1.22.19/libexec/yarn/lib/cli.js:321:13
       For full logs, run 'nix log /nix/store/3na9dj7k9w87mygvjv23sd8fnq9r3pb8-signal-desktop-modules-7.12.0.drv'.
```

</details>

um so that's uh what was it again

canvas... right

> lockfile has incorrect entry

I mean this is yarn

so I guess it might be this yarn version that's just kind of outdated

that might be it well let's see that later

so canvas is that in here?

`cd /nix/store/7jwwv5ddyglvbch5gdw5af9fyz0rw5w4-offline`

let's do like one of these

_fzf search for canvas text, alternative is `ls | rg canvas`_

that sure isn't here

okay um and so it might.. Hmm

incorrect entry this is tricky, debugging live

_opens yarn2nix-moretea/yarn2nix/default.nix_

but let's see `offlineCache`

uh well it's also here but we were at `mkYarnPackage`

so (make) offlineCache

I suppose... hmmm

I guess this would only apply when we actually need to get the packages

I think even yarn is like saying that I won't even try to look for that package

right because there's an incorrect entry

uh is that it or am I am I like missing something here with the error

is that the same one here

_opens
https://discourse.nixos.org/t/mkyarnpackage-lockfile-has-incorrect-entry/21586_

```console
error: builder for '/nix/store/9af4bw297961rx7wc8a2yyzap2fqn0wh-marp-team-marp-cli-modules-2.1.4.drv' failed with exit code 1;
       last 10 log lines:
       > warning Lockfile has incorrect entry for "pug-runtime@^2.0.4". Ignoring it.
       > error Couldn't find any versions for "pug" that matches "^2.0.3" in our cache (possible versions are ""). This is usually caused by a missing entry in the lockfile, running Yarn without the --offline flag may help fix this issue.
       > info Visit https://yarnpkg.com/en/docs/cli/install for documentation about this command.
       > Error: Couldn't find any versions for "pug-runtime" that matches "^2.0.4" in our cache (possible versions are ""). This is usually caused by a missing entry in the lockfile, running Yarn without the --offline flag may help fix this issue.
       >     at MessageError.ExtendableBuiltin (/nix/store/8lajm4glg9v9f7lzpz4r4gm02rqwgnkl-yarn-1.22.18/libexec/yarn/lib/cli.js:721:66)
       >     at new MessageError (/nix/store/8lajm4glg9v9f7lzpz4r4gm02rqwgnkl-yarn-1.22.18/libexec/yarn/lib/cli.js:750:123)
       >     at NpmResolver.<anonymous> (/nix/store/8lajm4glg9v9f7lzpz4r4gm02rqwgnkl-yarn-1.22.18/libexec/yarn/lib/cli.js:50430:15)
       >     at Generator.next (<anonymous>)
       >     at step (/nix/store/8lajm4glg9v9f7lzpz4r4gm02rqwgnkl-yarn-1.22.18/libexec/yarn/lib/cli.js:310:30)
       >     at /nix/store/8lajm4glg9v9f7lzpz4r4gm02rqwgnkl-yarn-1.22.18/libexec/yarn/lib/cli.js:321:13
       For full logs, run 'nix log /nix/store/9af4bw297961rx7wc8a2yyzap2fqn0wh-marp-team-marp-cli-modules-2.1.4.drv'.
error: 1 dependencies of derivation '/nix/store/9lxxd3250h492b4s2lvxcf53ral42mcn-marp-cli.drv' failed to build
```

> couldn't find has incorrect entry for pug-runtime

so I think this might actually be a separate error then because here it says
only an `incorrect entry for pug-runtime` but it couldn't find pug

whereas in this case it's the same package that's missing

so maybe that's that's a slight clue

yeah um

> youtube chat
>
> Yuriy Taraday I guess they blocked these dependencies in the lockfile to
> prevent them from getting downloaded or smth.

interesting

we could also look at the at the repo they have

so let's go here again

`cd ~/nix-hour/code/77`

signal

_opens signal.nix_

and I guess like debugging often times you just need more info

and the more you get and the more you figure stuff out uh the more it becomes
clear what the problem might be

so let's look at the source

_goes to https://github.com/signalapp/signal-desktop, specifically to a main
branch with commit
https://github.com/signalapp/Signal-Desktop/commit/b23efedba96e5c53d4b875447d11a52b76c155ea_

and uh specifically we're wondering about this entry in the lock file

uh which one is it

_goes to previously opened tab
https://github.com/signalapp/Signal-Desktop/blob/af1c593fef4e485127ea356b3b592f3c781c2a16/yarn.lock#L7620_

was that mentioned here

oh yeah we we have it here

oh yeah we we have the source here already

canvas is one of them

so let's look at the blame and see when it was added or if there's any extra
context behind that

_opens
https://github.com/signalapp/Signal-Desktop/blame/af1c593fef4e485127ea356b3b592f3c781c2a16/yarn.lock#L7620_

taking a while here though

update signal to there

_opens
https://github.com/signalapp/Signal-Desktop/commit/8b969b5a0a09fb3ce1a5b1dd7f2b74b4eb9d72a4_

um did that actually change it in a significant way

is that something recent

_search:canvas_

_goes to
https://github.com/signalapp/Signal-Desktop/commit/8b969b5a0a09fb3ce1a5b1dd7f2b74b4eb9d72a4?diff=split#diff-51e4f558fae534656963876761c95b83b6ef5da5103c4adef6768219ed76c2deL7620_

oh it kind of changed oh what is this

canvas@

```diff
- canvas@^2.6.1, "canvas@https://registry.yarnpkg.com/nop/-/nop-1.0.0.tgz", dmg-license@^1.0.11, "dmg-license@https://registry.yarnpkg.com/nop/-/nop-1.0.0.tgz", jsdom@^15.2.1, "jsdom@https://registry.yarnpkg.com/nop/-/nop-1.0.0.tgz":
+ canvas@^2.6.1, "canvas@https://registry.yarnpkg.com/nop/-/nop-1.0.0.tgz":
```

okay maybe like are these lockfiles documented?

is that a new feature perhaps

I have no idea what this... what is going on here

so there's a package

then I guess this is one this this like one mirror or so for the package

uh dmg-license

oh there's a lot of these `nop`s here is that a noop then?

is that like package that's essentially not resolved and that's why it's nop
here

that actually kind of looks like it

so maybe get a bit more info here

_opens https://registry.yarnpkg.com/nop_

is there anything interesting here

> library for providing a function that does nothing; it's like super useful

um okay is that like some kind of fallback that is being used?

_opens https://github.com/supershabam/nop_

index.json _opens index.js
https://github.com/supershabam/nop/blob/master/index.js_

literally is nothing so I guess that's uh not something that's actually useful

> youtube chat
>
> Yuriy Taraday They all point to nop though!

oh uh let's see if we go up one of the these

I mean the others here have an actual thing here

```yaml
camelcase@^6.0.0: version "6.2.0"
  resolved "https://registry.yarnpkg.com/camelcase/-/camelcase-6.2.0.tgz#924af881c9d525ac9d87f40d964e5cea982a1809"
  integrity sha512-c7wVvbw3f37nuobQNtgsgG9POC9qMbNuMQmTCqZv23b6MIz0fcYpBiOlv9gEN/hdLdnZTDQhg6e9Dq5M1vKvfg==
```

there's only all of these are nop here

```
canvas@^2.6.1, "canvas@https://registry.yarnpkg.com/nop/-/nop-1.0.0.tgz", dmg-license@^1.0.11, "dmg-license@https://registry.yarnpkg.com/nop/-/nop-1.0.0.tgz", jsdom@^15.2.1, "jsdom@https://registry.yarnpkg.com/nop/-/nop-1.0.0.tgz":
```

and uh one of like they got kind of removed

is this an a list of packages that are kind of all omitted

and so you have canvas which points to canvas@nop which doesn't exist

dmg-license pointing at dmg-license@nop yeah

okay so I guess it's all of these

um then I'm still wondering why

I guess let's go back a bit more in the history

uh I mean this is a bit far from removed from nix

but that's kind of something you have to get into with nix

as soon as you, well kind of

well you need you need to jump into all of these language ecosystems and debu
build failures and stuff like that

and that's just complicated sometimes

uh so let's look again at the blame

I'm going to use the GitHub feature here to go back more in history

so this one blame prior to this change

to maybe get a bit more clues

_goes to
https://github.com/signalapp/Signal-Desktop/blame/33ec40d7b4ad8be055ff4ae119f64ecc4ca6c3a7/yarn.lock_

> Your blame took too long to compute.

um oh oh no blame took too long to compute

that's not great uh well guess we could go into a local

let's clone it locally then

git clone this one

um and actually let's do well now we

`git clone https://github.com/signalapp/Signal-Desktop`

can't oh maybe we can use a

no we can't use a shell

so there is a filter equals tree 0 or something like this

`git clone https://github.com/signalapp/Signal-Desktop --filter=tree:0`

which allows you to fetch the entire history without fetching the files and the
blobs and the contents of that history

so if you have something like nixpkgs and you need to like know what all the
commits are

and be like able to do a g log uh this would be really nice

uh but in this case we actually need the blame so we this wouldn't be enough

```console
$ git clone
```

> yt chat:
>
> designernasser maybe this canvas packages should be removed?

maybe that could be

like I guess we could try patching it um and just see what happens

uh I'm not an expert in yarn but it might also be possible to get it to like
show

why it has that package or like show the dependency graph

and uh that's going to take some time I hope that doesn't mess with the stream

yeah it should be only be download

okay A bit overwhelmed here on what exactly we should look at

um yarn, signal let's see

is there maybe an issue that sometimes also occurs

like if we search for canvas

_opens https://github.com/signalapp/Signal-Desktop/issues?q=canvas_

by the way I delete the so if I go to issues

`https://github.com/signalapp/Signal-Desktop/issues?q=is%253Aissue%20is%253Aopen`

um if you just search here we'd only find open issues

`https://github.com/signalapp/Signal-Desktop/issues?q=is%3Aissue%20is%3Aopen%20canvas%20`

and so I if you only search for this you only find issues

`https://github.com/signalapp/Signal-Desktop/issues?q=is%3Aissue%20canvas%20`

this way you find issues and prs

`https://github.com/signalapp/Signal-Desktop/issues?q=canvas%20`

and I'm not sure if GitHub can fix that or if that that's not even a bug

but if you do the same for prs

like if you search for canvas here

`https://github.com/signalapp/Signal-Desktop/pulls?q=canvas`

yeah you'll only find prs so if you want to find PR and issues

I think you need to go here

`https://github.com/signalapp/Signal-Desktop/issues`

`https://github.com/signalapp/Signal-Desktop/issues?q=canvas`

um yes?

are some of these prs?

yeah yeah this is a pr

okay is there anything here uh

> cropped image, image glitch

no that does not look like anything relevant

um maybe there's a something relevant in a thread on discoure

um oh I have the chat open on my my phone

let me briefly just find the same one

it is the thread on issue with yarn fetch yarn deps this one

_opens https://discourse.nixos.org/t/issue-with-yarn-fetchyarndeps/44889_

uh getting point to this one

> trying to fetch pretch building fails with an but yarn being unable to fetch
> package nop

that looks kind of relevant

> when running in offline mode even though the exact package exists in the
> offline cache

okay uh is that the same error here

let's just check

oh that's also signal

so that's uh that's good

is that maybe the the exact same person asking the original issue

might be the case

uh where did I

here it is

uh no it's not the same person

so uh it's not the same error

it says can't make a request in offline mode

um okay

_reads https://discourse.nixos.org/t/issue-with-yarn-fetchyarndeps/44889/2_

> I've avoided that one resorted to doing it logic manually, requires
> package.json also to be vendored

um okay so that does offline they do offlineCache here and then configurePhase
with stuff here

okay and does that work I mean if that works that would be kind of a solution
but uh it's not very exciting for for us here

but let's try let's try

_copies code from
https://discourse.nixos.org/t/issue-with-yarn-fetchyarndeps/44889/2_

```nix
# file: signal.nix
{
  lib,
  stdenv,
  fetchFromGitHub,
  fixup-yarn-lock,
  yarn,
  nodejs,
  fetchYarnDeps,
}:

stdenv.mkDerivation (finalAttrs: {
  pname = "signal-desktop";
  version = "7.5.1";

  src = fetchFromGitHub {
    owner = "signalapp";
    repo = "Signal-Desktop";
    rev = "v${finalAttrs.version}";
    hash = "sha256-++XRYI36LbFDGuDJDU2qpy2NG5iOGyFxhy/gRxfHXbI=";
  };

  postPatch = ''
    substituteInPlace package.json \
        --replace-fail '"node": "20.9.0"' ""
  '';

  offlineCache = fetchYarnDeps {
    yarnLock = "${finalAttrs.src}/yarn.lock";
    hash = "sha256-15Z4MyQk8ZeP7oZ1GWoHFhSGsW222t98O7AftcnexSA=";
  };

  nativeBuildInputs = [
    yarn
    fixup-yarn-lock
    nodejs
  ];

  configurePhase = ''
    runHook preConfigure

    export HOME=$(mktemp -d)
    yarn config --offline set yarn-offline-mirror ${finalAttrs.offlineCache}
    fixup-yarn-lock yarn.lock
    yarn install --offline --frozen-lockfile --ignore-platform --ignore-scripts --no-progress --non-interactive
    patchShebangs node_modules/

    runHook postConfigure
  '';
})
```

so this one and let's try building

```console
$ nix-build -A signal
error:
       … while calling the 'abort' builtin
         at /home/tweagysil/src/nixpkgs/main/lib/customisation.nix:203:65:
          202|
          203|     in if missingArgs == {} then makeOverridable f allArgs else abort error;
             |                                                                 ^
          204|

       … while evaluating a path segment
         at /home/tweagysil/src/nixpkgs/main/lib/customisation.nix:197:57:
          196|             else "<unknown location>";
          197|         in "Function called without required argument \"${arg}\" at "
             |                                                         ^
          198|         + "${loc'}${prettySuggestions (getSuggestions arg)}";

       error: cannot coerce a Boolean to a string: false
```

> cannot coerce a Boolean to a string

maybe this wasn't actually tested

uh offlineCache

hold on

> cannot coerce a Boolean to a string, function called without

uh let's get show trace is that the problem here

```console
$ nix-build -A signal --show-trace
error:
       … from call site
         at ~/nix-hour/code/77/default.nix:15:12:
           14|
           15|   signal = pkgs.callPackage ./signal.nix { };
             |            ^
           16|

       … while calling 'callPackageWith'
         at /home/tweagysil/src/nixpkgs/main/lib/customisation.nix:152:35:
          151|   */
          152|   callPackageWith = autoArgs: fn: args:
             |                                   ^
          153|     let

       … while calling the 'abort' builtin
         at /home/tweagysil/src/nixpkgs/main/lib/customisation.nix:203:65:
          202|
          203|     in if missingArgs == {} then makeOverridable f allArgs else abort error;
             |                                                                 ^
          204|

       … from call site
         at /home/tweagysil/src/nixpkgs/main/lib/customisation.nix:201:15:
          200|       # Only show the error for the first missing argument
          201|       error = errorForArg missingArgs.${head (attrNames missingArgs)};
             |               ^
          202|

       … while calling 'errorForArg'
         at /home/tweagysil/src/nixpkgs/main/lib/customisation.nix:188:21:
          187|
          188|       errorForArg = arg:
             |                     ^
          189|         let

       … while evaluating a path segment
         at /home/tweagysil/src/nixpkgs/main/lib/customisation.nix:197:57:
          196|             else "<unknown location>";
          197|         in "Function called without required argument \"${arg}\" at "
             |                                                         ^
          198|         + "${loc'}${prettySuggestions (getSuggestions arg)}";

       error: cannot coerce a Boolean to a string: false
```

uh yes

> customisation called without argument

oh I I can't really understand this

um wait let me just look at this

we finalAttrs.version

we have some stuff in here

source that should not be boolean

maybe

maybe yarn, that fixup-yarn-lock

did something kind of break in an incompatible way and so the code here is kind
of outdated

this was in May 5 though

that's like very recent

could try to update my nixpkgs version I suppose

uh maybe let's do that

> cannot coerce a Boolean to a string: false

oh wait hold on

it's it's complaining about it here

so so this `arg` here is the problem

> and a function called without required argument arg

what why would this be

`vim nixpkgs/lib/customisation.nix`

_searches without required_

without required argument `arg` at this location

(it goes here..) why would this be a problem?

so that's actually code I wrote originally but I haven't really seen any
problems with it so far

and that's I mean that's callPackage code

uh so it's without required argument arg at here

I mean this this might be it, maybe the error is bit at the wrong place

and it's referring to `loc'` instead

and I mean we could uh like what if we just trace some stuff here

like if you have a nixpkgs you can modify

you can also just introspect some debug statements in here

I'm going to try (let's make this a bit bigger)

going to try do like a `traceSeqN` I suppose or `traceSeq arg`

um that might work

uh might need to some parentheses here actually

actually I don't think we need those

but anyways let's do that and then we should get

```console
$ nix-build -A signal
trace: false
... ommited, same error as above ...
```

yeah trace:false so that's actually that argument is actually false

um so `errorForArg` where is that used?

missingArgs arg.head

> # Only show error for the first missing argument

okay could we do

so I think we actually want to know what this is `head (attrNames missingArgs)`

and so let's do a bit more debugging here

let's say uh `errorForArg` let let's make like `ctx`

let's add a context variable here

so in the context variable we're going to pass this attribute

`error = errorForArg (head (attrNames missingArgs)) missingArgs.${head (attrNames missingArgs)};`

okay and we're copying it but we're debugging so that's fine

so that's an arg that is missing and uh we have the context here now

let's also trace the context

uh I'm going to do it like this

where I do inherit ctx and arg

so we get both without having to like mess around with how to exactly print them

because `traceSeq` I think.. does it print a pretty version of this?

I'm going to hope it does

```diff
diff --git a/lib/customisation.nix b/lib/customisation.nix
index dec1ab9f4faa..29c259a8fb94 100644
--- a/lib/customisation.nix
+++ b/lib/customisation.nix
@@ -185,7 +185,7 @@ rec {
         else if length suggestions == 1 then ", did you mean ${elemAt suggestions 0}?"
         else ", did you mean ${concatStringsSep ", " (lib.init suggestions)} or ${lib.last suggestions}?";

-      errorForArg = arg:
+      errorForArg = ctx: arg:
         let
           loc = builtins.unsafeGetAttrPos arg fargs;
           # loc' can be removed once lib/minver.nix is >2.3.4, since that includes
@@ -194,11 +194,13 @@ rec {
             else if ! isFunction fn then
               toString fn + optionalString (pathIsDirectory fn) "/default.nix"
             else "<unknown location>";
-        in "Function called without required argument \"${arg}\" at "
-        + "${loc'}${prettySuggestions (getSuggestions arg)}";
+        in
+        lib.debug.traceSeq { inherit ctx arg; }
+        ("Function called without required argument \"${arg}\" at "
+        + "${loc'}${prettySuggestions (getSuggestions arg)}");

       # Only show the error for the first missing argument
-      error = errorForArg missingArgs.${head (attrNames missingArgs)};
+      error = errorForArg (head (attrNames missingArgs)) missingArgs.${head (attrNames missingArgs)};

     in if missingArgs == {} then makeOverridable f allArgs else abort error;

diff --git a/pkgs/development/tools/yarn2nix-moretea/yarn2nix/default.nix b/pkgs/development/tools/yarn2nix-moretea/yarn2nix/default.nix
index 914296d70953..4aa0af719374 100644
--- a/pkgs/development/tools/yarn2nix-moretea/yarn2nix/default.nix
+++ b/pkgs/development/tools/yarn2nix-moretea/yarn2nix/default.nix
@@ -387,6 +387,7 @@ in rec {
       passthru = {
         inherit package packageJSON deps;
         workspaceDependencies = workspaceDependenciesTransitive;
+        inherit offlineCache;
       } // (attrs.passthru or {});

       meta = {
```

```
$ nix-build -A signal
trace: { arg = false; ctx = "fixup-yarn-lock"; }
... ommited, same error as previous one ...
```

ah yes it does

okay so fixup-yarn-lock is the variable

> so function called with our required argument true

um oh wait is that was that something in the

another window here

and I should get back to the to the chat there

> youtube chat
>
> Yuriy Taraday You could also try using debugger ;)

uh I could try the debarger we tried the debarger before

it didn't quite work that well so

_laughs_

I'm going to stay away from that, for now

uh but yeah fixup-yarn-lock I mean, that's that argument right, is that

uh how does that how does that make sense?

oh hold on `errorForArg` we have `missingArgs` so that's an arg that is missing

um yeah so I guess that doesn't exist in nixpkgs fixup-yarn-lock

but then I'm wondering why does the error print this thing

`error: cannot coerce a Boolean to a string: false`

I guess let's let's look what

uh let's actually go into the default.nix here

let's add `inherit pkgs;`

```nix
# file: default.nix
# ...
  };

  inherit pkgs;
})
```

here so we can debug on packages

get access to that

so now we should be able to do like `nix-eval -A pkgs.fixup-yarn-lock <TAB>`
`nix-eval -A pkgs.fixup_yarn_lock`

oh there's an underscore version I guess that's one that was intended to be used
here

we're kind of debugging not the thing I wanted

but I think we're getting to see some more nix here which is good

um so we could just fix that but I'm kind of worried about the the error just
being wrong

and so I guess let's also, let's print some more things let's print the
`missingArgs` yes

_in lib/customisation.nix_ `lib.debug.traceSeq { inherit ctx arg missingArgs; }`

okay let's see what that gives us

```console
$ nix-build -A signal
trace: { arg = false; ctx = "fixup-yarn-lock"; missingArgs = { fixup-yarn-lock = false; }; }
... ommited ...
```

so missingArgs we have uh missingArgs is fixup-yarn-lock equals false

um okay

> function called without required argument

so is that a bug in the code here?

`errorForArg`

I mean it kind of looks like an error

but how could this be

let's try something else

um what if we try florp

<details open>
<summary>Collapse</summary>

```nix
# file: signal.nix
{
  lib,
  stdenv,
  fetchFromGitHub,
  #fixup-yarn-lock,
  yarn,
  nodejs,
  fetchYarnDeps,

  florp,
}:

stdenv.mkDerivation (finalAttrs: {
  #pname = "signal-desktop";
  #version = "7.5.1";

  #src = fetchFromGitHub {
  #  owner = "signalapp";
  #  repo = "Signal-Desktop";
  #  rev = "v${finalAttrs.version}";
  #  hash = "sha256-++XRYI36LbFDGuDJDU2qpy2NG5iOGyFxhy/gRxfHXbI=";
  #};

  #postPatch = ''
  #  substituteInPlace package.json \
  #      --replace-fail '"node": "20.9.0"' ""
  #'';

  #offlineCache = fetchYarnDeps {
  #  yarnLock = "${finalAttrs.src}/yarn.lock";
  #  hash = "sha256-15Z4MyQk8ZeP7oZ1GWoHFhSGsW222t98O7AftcnexSA=";
  #};

  #nativeBuildInputs = [
  #  yarn
  #  fixup-yarn-lock
  #  nodejs
  #];

  #configurePhase = ''
  #  runHook preConfigure

  #  export HOME=$(mktemp -d)
  #  yarn config --offline set yarn-offline-mirror ${finalAttrs.offlineCache}
  #  fixup-yarn-lock yarn.lock
  #  yarn install --offline --frozen-lockfile --ignore-platform --ignore-scripts --no-progress --non-interactive
  #  patchShebangs node_modules/

  #  runHook postConfigure
  #'';
})
```

</details>

I hope florp doesn't exist and

let's let's remove this one let's just have something very simple

I'm a bit perplexed how this is a problem

I'm just going to do nix-instantiate of signal

```console
$ nix-instantiate -A signal
trace: { arg = false; ctx = "florp"; missingArgs = { florp = false; }; }
... ommited, same error ...
```

um

> cannot coerce a Boolean to a string

same thing here uh did I did I mess something up with the code

is this

what is happening with with this nixpkgs here

so let's get let's go into nixpkgs

```console
$ cd ~/src/nixpkgs/main
$ git log
commit e92039b55bcd58469325ded85d4f58dd5a4eaf58
Merge: af69bf31f195 c687a1297f73
Author: Martin Weinelt <hexa@darmstadt.ccc.de>
Date:   Wed Nov 29 11:33:01 2023 +0100

    Merge pull request #270856 from trofi/kea-update

    kea: 2.4.0 -> 2.4.1

commit af69bf31f1952ce944dfacf541d3b4bef9faed78
... ommited ...
```

from where is that that's from 2023

like I guess we can try a newer one

let's I guess check out the master version

git stash our changes for now

```console
$ git stash
Saved working directory and index state WIP on (no branch): e92039b55bcd Merge pull request #270856 from trofi/kea-update
```

check out the master version

```
$ git checkout master
Updating files: 100% (33278/33278), done.
Previous HEAD position was e92039b55bcd Merge pull request #270856 from trofi/kea-update
Switched to branch 'master'
Your branch is up to date with 'upstream/master'.
```

just see if it's the same problem there

```console
$ nix-build -A signal
... ommited ...
       error: evaluation aborted with the following error message: 'lib.customisation.callPackageWith: Function called without required argument "florp" at /home/tweagysil/nix-hour/code/77/signal.nix:10, did you mean "floorp", "bloop" or "flamp"?'
```

it's not

aha

oh! was this

I mean oh at this point we can do git bisection

um and just figure out why this is the case

uh let's do something something neat here

so we had the now let's see switched to branch previous head position was this
`e92039b55bcd`

okay so I'm going to do a bisect and before I do that I want to get it in a
single command actually

`man git bisect`

so we start

uh here bisect um where is it? start?

oh here it is start um then we

need a bad, new

okay we can do it like this

```console
$ git bisect start
status: waiting for both good and bad commits
$ git bisect good HEAD
status: waiting for bad commit, 1 good commit known
$ git bisect bad e92039b55bcd
Some good revs are not ancestors of the bad rev.
git bisect cannot work properly in this case.
Maybe you mistook good and bad revs?
```

the one we had before although I do want to double check that

so here this one um

> some good news refs are not ancestors of the bad ref good bad

oh it should be the other way around right

wait git bisect um reset

let's try it again

```console
$ git bisect start
status: waiting for both good and bad commits
```

and I think we need to do uh old and new instead

that's kind of well it's the same thing

but less confusing if you have if you want to find where it started working
instead of where it started breaking

I'm going to do new for HEAD

```console
$ git bisect new HEAD
status: waiting for good commit(s), bad commit known
```

I'm going to do old for the original one there

actually before we do that let's just check it out

```console
$ git switch e92039b55bcd
fatal: a branch is expected, got commit 'e92039b55bcd'
hint: If you want to detach HEAD at the commit, try again with the --detach option.
```

let's check it out again with uh detach I suppose

```console
$ git switch e92039b55bcd --detach
warning: you are switching branch while bisecting
Updating files: 100% (33278/33278), done.
HEAD is now at e92039b55bcd Merge pull request #270856 from trofi/kea-update
```

and let's just verify that we do get the same error

```console
$ nix-build -A signal
... ommited ...
     error: cannot coerce a Boolean to a string: false
```

yep we do

so at this point we can do git bisect uh that's the old one

```console
$ git bisect old
... running ...
```

okay now it would go ahead try to find the middle point

um...

if that that takes too long I might skip this actually

yeah the it might be a significant amount of uh revisions we need to get through
here this is a like a Year's worth of commits which is a lot

um okay well let's do like a couple steps just to show how we would do this

uh if if you haven't done a git bisection before

so we try it again and actually we don't need to try to build it

I guess nix-instantiate also works just fine

so here uh this is the thing we want it's the new thing it's the thing that has
been fixed so we do

```console
$ git bisect old
Bisecting: 45109 revisions left to test after this (roughly 16 steps)
[8ead81a60f410dd4db6df106254c087b6b333967] Merge remote-tracking branch 'upstream/master' into staging-next
```

git bisect new

um actually I have a an alas for this `gbsg`

uh well good is there one for new?

there's not one for new

so let's not do that `git bisect new`

```console
$ git bisect new
Bisecting: 22554 revisions left to test after this (roughly 15 steps)
[a7a238bc0ee7cee342472055d7c2683cc268dd7c] Merge pull request #283979 from b-eyselein/master
```

`nix-build -A signal` _new correct error_

and the good thing is any step after this is just going to take half the amount
of time

so this is already faster now so just repeat that `git bisect new`

you could also automate this with `git bisect run`

uh but in this case I think it should be fine

```console
$ git bisect new
Bisecting: 11264 revisions left to test after this (roughly 14 steps)
[2a70c1590015b07606426fcde4c9ad398a0015c1] Merge pull request #278307 from chewblacka/update-apx
```

`nix-build -A signal` _new correct but different looking error_

it changed a little bit and actually if we tried to automate this it would have
messed it up probably

because suddenly like it's separate error

uh but it's still not the thing we're looking for

so this is still new

```console
$ git bisect new
Bisecting: 5626 revisions left to test after this (roughly 13 steps)
[c0afcc29aa8e3c90e7bd244fbae30dbe7c2a8a45] Merge pull request #273724 from r-ryantm/auto-update/kodiPackages.future
```

`nix-build -A signal` _new correct error_

this is new

```console
$ git bisect new
Bisecting: 2807 revisions left to test after this (roughly 12 steps)
[37eb75ecc29fcdbe94b7480a024e5619abb0f06b] Merge pull request #270301 from atorres1985-contrib/arcan
```

`nix-build -A signal` _new correct error_

this is new

```console
$ git bisect new
Bisecting: 1405 revisions left to test after this (roughly 11 steps)
[afbb5d827285eb80a4f622fe3662422bc3b0e50d] Merge pull request #271607 from aaronjheng/etcd_3_4
```

this should actually go pretty fast

`nix-build -A signal` _OLD INCORRECT boolean coersion error_

oh here we go this is the one we we don't want so let's do old

```console
$ git bisect old
Bisecting: 703 revisions left to test after this (roughly 10 steps)
[5f5e76c08153f251bd7cd5dba20fe8254925597d] Merge pull request #272086 from ConnorBaker/fix/jaxlib-bin-remove-cuda-asserts
```

`nix-build -A signal` _new correct error_

here this is new

```console
$ git bisect new
Bisecting: 350 revisions left to test after this (roughly 9 steps)
[5aa5b3c1a7f614c030a9662fe64083818b949336] linux-rt_6_1: 6.1.59-rt16 -> 6.1.64-rt17
```

`nix-build -A signal` _new correct error_

this is new

```console
$ git bisect new
Bisecting: 175 revisions left to test after this (roughly 8 steps)
[2705caa784bfc2c19a4cb21636167289740f5b3d] Merge pull request #271472 from r-ryantm/auto-update/go-task
```

`nix-build -A signal` _new correct error_

this is also new

```console
$ git bisect new
Bisecting: 86 revisions left to test after this (roughly 7 steps)
[49b3903e84ecc63eb03f519bd586f5186616abcb] Merge pull request #271799 from r-ryantm/auto-update/python310Packages.gptcache
```

`nix-build -A signal` _new correct error_

```console
$ git bisect new
Bisecting: 43 revisions left to test after this (roughly 6 steps)
[6998cf86e9a6ef83b32956337f65aba8656671fe] Merge pull request #271670 from matthiasbeyer/update-cargo-update
```

```console
$ nix-build -A signal
... ommited ...
            7|     functionArgs isFunction mirrorFunctionArgs isAttrs setFunctionArgs
            8|     optionalAttrs attrNames levenshtein filter elemAt concatStringsSep sort take length
             |                             ^
            9|     filterAttrs optionalString flip pathIsDirectory head pipe isDerivation listToAttrs
```

okay oh this is uh this is a skip

this is just a completely separate error so we we won't try to do that one

```console
$ git bisect skip
Bisecting: 43 revisions left to test after this (roughly 6 steps)
[dd6fa9c2e691ead3b729a064d816c375be2a0c1f] mujoco: 3.0.0 -> 3.0.1
```

`nix-build -A signal` _new correct error_

see that's new one and we should be almost there

```console
$ git bisect new
Bisecting: 0 revisions left to test after this (roughly 1 step)
[290bc1fbe0855cbc82efa17bf9382f428512910f] mujoco: 2.3.7 -> 3.0.0, add Python bindings
```

`nix-build -A signal` _new correct error_

```console
$ git bisect new
Bisecting: 0 revisions left to test after this (roughly 0 steps)
[e4346914e19f1ffc1b26a8eac09b245f92a513e0] glfw: fix build for Python bindings
```

`nix-build -A signal` _new correct error_

```console
$ git bisect new
e4346914e19f1ffc1b26a8eac09b245f92a513e0 is the first new commit
commit e4346914e19f1ffc1b26a8eac09b245f92a513e0 (HEAD)
Author: Viktor Sonesten <v@tmplt.dev>
Date:   Tue Nov 7 21:04:30 2023 +0100

    glfw: fix build for Python bindings

 pkgs/development/python-modules/glfw/default.nix       |  4 +---
 pkgs/development/python-modules/glfw/search-path.patch | 11 -----------
 2 files changed, 1 insertion(+), 14 deletions(-)
 delete mode 100644 pkgs/development/python-modules/glfw/search-path.patch
```

yes and it's not the one we're looking for

hold on um something completely unrelated uh

git bisect let's do a visualize

`git bisect visualize`

just kind of see well I mean it's not much of a visualization

um or maybe we could do a git bisect

uh let's see there's a replay I suppose

```console
$ git bisect replay
error: no logfile given
```

oh no replay no let's look at log?

<details open>
<summary>Collapse</summary>

```console
$ git bisect log
git bisect start
# status: waiting for both good and bad commits
# new: [72f92f567f50917f0f5c12c1a94dbaeb5a012074] Merge pull request #322001 from bobvanderlinden/git-cola-4.8.0
git bisect new 72f92f567f50917f0f5c12c1a94dbaeb5a012074
# old: [e92039b55bcd58469325ded85d4f58dd5a4eaf58] Merge pull request #270856 from trofi/kea-update
git bisect old e92039b55bcd58469325ded85d4f58dd5a4eaf58
# new: [8ead81a60f410dd4db6df106254c087b6b333967] Merge remote-tracking branch 'upstream/master' into staging-next
git bisect new 8ead81a60f410dd4db6df106254c087b6b333967
# new: [a7a238bc0ee7cee342472055d7c2683cc268dd7c] Merge pull request #283979 from b-eyselein/master
git bisect new a7a238bc0ee7cee342472055d7c2683cc268dd7c
# new: [2a70c1590015b07606426fcde4c9ad398a0015c1] Merge pull request #278307 from chewblacka/update-apx
git bisect new 2a70c1590015b07606426fcde4c9ad398a0015c1
# new: [c0afcc29aa8e3c90e7bd244fbae30dbe7c2a8a45] Merge pull request #273724 from r-ryantm/auto-update/kodiPackages.future
git bisect new c0afcc29aa8e3c90e7bd244fbae30dbe7c2a8a45
# new: [37eb75ecc29fcdbe94b7480a024e5619abb0f06b] Merge pull request #270301 from atorres1985-contrib/arcan
git bisect new 37eb75ecc29fcdbe94b7480a024e5619abb0f06b
# old: [afbb5d827285eb80a4f622fe3662422bc3b0e50d] Merge pull request #271607 from aaronjheng/etcd_3_4
git bisect old afbb5d827285eb80a4f622fe3662422bc3b0e50d
# new: [5f5e76c08153f251bd7cd5dba20fe8254925597d] Merge pull request #272086 from ConnorBaker/fix/jaxlib-bin-remove-cuda-asserts
git bisect new 5f5e76c08153f251bd7cd5dba20fe8254925597d
# new: [5aa5b3c1a7f614c030a9662fe64083818b949336] linux-rt_6_1: 6.1.59-rt16 -> 6.1.64-rt17
git bisect new 5aa5b3c1a7f614c030a9662fe64083818b949336
# new: [2705caa784bfc2c19a4cb21636167289740f5b3d] Merge pull request #271472 from r-ryantm/auto-update/go-task
git bisect new 2705caa784bfc2c19a4cb21636167289740f5b3d
# new: [49b3903e84ecc63eb03f519bd586f5186616abcb] Merge pull request #271799 from r-ryantm/auto-update/python310Packages.gptcache
git bisect new 49b3903e84ecc63eb03f519bd586f5186616abcb
# skip: [6998cf86e9a6ef83b32956337f65aba8656671fe] Merge pull request #271670 from matthiasbeyer/update-cargo-update
git bisect skip 6998cf86e9a6ef83b32956337f65aba8656671fe
# new: [dd6fa9c2e691ead3b729a064d816c375be2a0c1f] mujoco: 3.0.0 -> 3.0.1
git bisect new dd6fa9c2e691ead3b729a064d816c375be2a0c1f
# new: [290bc1fbe0855cbc82efa17bf9382f428512910f] mujoco: 2.3.7 -> 3.0.0, add Python bindings
git bisect new 290bc1fbe0855cbc82efa17bf9382f428512910f
# new: [e4346914e19f1ffc1b26a8eac09b245f92a513e0] glfw: fix build for Python bindings
git bisect new e4346914e19f1ffc1b26a8eac09b245f92a513e0
# first new commit: [e4346914e19f1ffc1b26a8eac09b245f92a513e0] glfw: fix build for Python bindings
```

</details>

uh well I mean at this point this kind of failed and uh that's a it's a bad sign

hold on I mean let's try this

`nix-build -A signal` _new correct error_

so that fails

and now if we go back one commit are you saying this is going to fail in the
other way

```console
$ git checkout HEAD~
Previous HEAD position was e4346914e19f glfw: fix build for Python bindings
HEAD is now at 3b759e96f271 Merge pull request #263458 from m-bdf/sonic-pi-add-jack-tools
```

`nix-build -A signal` _same new correct error_

```console
$ git checkout HEAD~
Previous HEAD position was 3b759e96f271 Merge pull request #263458 from m-bdf/sonic-pi-add-jack-tools
HEAD is now at 63429f43caf2 Merge pull request #263627 from colemickens/systemd-stage1-fix-dosfstools
```

`nix-build -A signal` _same new correct error_

no

no that that that's not the case

so some somewhere I messed up here

anyways uh we'll skip this

it's a problem in nixpkgs that, this thing we try to debug

so it's not like at all related to what we're trying

so uh let's get back to I guess let's do master after all

going to do git bisect uh git bisect reset

```console
$ git bisect reset
Updating files: 100% (35182/35182), done.
Previous HEAD position was 63429f43caf2 Merge pull request #263627 from colemickens/systemd-stage1-fix-dosfstools
HEAD is now at 72f92f567f50 Merge pull request #322001 from bobvanderlinden/git-cola-4.8.0
```

this gets you back to where you started, in our case that's master

and let's do this again

and uh yeah now we can actually go in here, undo this

<details open>
<summary>Collapse</summary>

```nix
# file: signal.nix
{
  lib,
  stdenv,
  fetchFromGitHub,
  fixup-yarn-lock,
  yarn,
  nodejs,
  fetchYarnDeps,

  florp
}:

stdenv.mkDerivation (finalAttrs: {
  pname = "signal-desktop";
  version = "7.5.1";

  src = fetchFromGitHub {
    owner = "signalapp";
    repo = "Signal-Desktop";
    rev = "v${finalAttrs.version}";
    hash = "sha256-++XRYI36LbFDGuDJDU2qpy2NG5iOGyFxhy/gRxfHXbI=";
  };

  postPatch = ''
    substituteInPlace package.json \
        --replace-fail '"node": "20.9.0"' ""
  '';

  offlineCache = fetchYarnDeps {
    yarnLock = "${finalAttrs.src}/yarn.lock";
    hash = "sha256-15Z4MyQk8ZeP7oZ1GWoHFhSGsW222t98O7AftcnexSA=";
  };

  nativeBuildInputs = [
    yarn
    fixup-yarn-lock
    nodejs
  ];

  configurePhase = ''
    runHook preConfigure

    export HOME=$(mktemp -d)
    yarn config --offline set yarn-offline-mirror ${finalAttrs.offlineCache}
    fixup-yarn-lock yarn.lock
    yarn install --offline --frozen-lockfile --ignore-platform --ignore-scripts --no-progress --non-interactive
    patchShebangs node_modules/

    runHook postConfigure
  '';
})
```

</details>

and we should also get back a better error message here

```console
$ git bisect reset
```

let's do this

```console
$ nix-build -A signal
... ommited ...
       error: evaluation aborted with the following error message: 'lib.customisation.callPackageWith: Function called without required argument "florp" at /home/tweagysil/nix-hour/code/77/signal.nix:10, did you mean "floorp", "bloop" or "flamp"?'
```

um florp, yeah we don't care about florp anymore

so let's get rid of that

_remove florp arg from signal.nix_

signal and

```console
$ nix-build -A signal
... running ...
```

oh okay so this `fixup-yarn-lock` has become an alias I'd expect

let's just verify this to make sure we understand that

```console
$ vim pkgs/top-level/aliases.nix
# search: fixup-yarn-lock -> no results
```

it's not here

maybe it was removed already

it's a fairly quick re uh like deprecation cycle then

uh we can look at

so this is `gwch pkgs/top-level/aliases.nix`

um the command essentially `git log --patch`

oh no it's not hold on, what?

git what changed `gwch`

uh

```console
$ alas gwch
gwch='git log --patch --no-merges'
```

oh, no merges, well yeah

top level aliases

and uh sometimes I like to just grep through here

```console
$ git log --patch --no-merges pkgs/top-level/aliases.nix
# searches: fixup-yarn-lock
```

and be like fixup-yarn-lock

to see if it was ever in here

> Pattern not found

so I guess it wasn't

uh V let's see let's just grep for for this fixup-yarn-lock

```console
$ rg fixup-yarn-lock
... ommited, many occurrences ..
```

yeah that's all over the place

uh is it ever in like fixup

oh and we could also do `git log -S` which allows you to search for a string in
the diff

so I guess specifically I'm looking for fixup_yarn_lock like this

```console
$ git log -Sfixup_yarn_lock
... running ...
```

and uh I mean it's kind of the same as just `git log --patch` and then do a grep
over that but I guess this is probably a bit more optimized

so yeah and we found some in here

```console
$ git log -Sfixup_yarn_lock
... ommited ...

commit 3e9e7d092f59234b45b1fa42d09f16bbbd7addb9
Author: huantian <davidtianli@gmail.com>
Date:   Wed Apr 3 00:35:32 2024 -0700

    tetrio-desktop: re-add tetrio-plus, now from source

... ommited ...

commit c1677a5ddb4342c701317dfc0c7cd330ba6e0cbc
Author: Felix Buehler <account@buehler.rocks>
Date:   Wed Nov 22 23:06:46 2023 +0100

    electron-fiddle: migrate to prefetch-yarn-deps

commit be146a1021a0e4b0e6a608fc2b5fb07f9888008c
Author: Felix Buehler <account@buehler.rocks>
Date:   Wed Nov 22 22:32:58 2023 +0100

    discourse: migrate to prefetch-yarn-deps
... ommited ...
```

which is

oh migrate to prefetch-yarn-deps

um yeah stuff is building this is building the same thing again

maybe actually it might work this time we did upgrade update nixpkgs

um yeah let's just pick any of these just to see what's happening

well let me go into nixpkgs here and show this commit

```
$ cd ~/src/nixpkgs/main
$ git show 3e9e7d092f59234b45b1fa42d09f16bbbd7addb9
# search: yarn_
```

and then what does it fetch yarn or yarn underscore

fixup_yarn_lock yeah fixup_yarn_lock is here

am I missing something with

with this `-S` here if you look at git

```console
$ man git log
# search: -S
       -S<string>
           Look for differences that change the number of occurrences of the specified string (i.e. addition/deletion) in a file.
           Intended for the scripter’s use.

           It is useful when you’re looking for an exact block of code (like a struct), and want to know the history of that block
           since it first came into being: use the feature iteratively to feed the interesting block in the preimage back into -S,
           and keep going until you get the very first version of the block.

           Binary files are searched as well.
```

does it only show things that were added and not ones that were removed

> look for difference that change the number of occurrences of the specified
> string addition, deltion in a file. intended for scripter's use

I mean that sounds like it's a thing I'm looking for

uh it's string though maybe it's like

I'm really not sure at this point

so many things failed here

uh a little bit unfortunate

but I mean that's uh that's what debuging is mostly about

so um I mean we have this

uh at this point I mean let's just continue trying to just use anything here

and maybe the the discussion around that might turn might like give more context

> youtube chat
>
> Yuriy Taraday Maybe grep for fixup-yarn-lock?

oh I mean I already did that

```console
$ rg fixup-yarn-lock
```

```console
$ rg fixup_yarn_lock
```

oh I mean it's also here

all-packages?

```console
$ vim pkgs/top-level/all-packages.nix
# search: yarn_lock
inherit (yarn2nix-moretea)
    yarn2nix
    mkYarnPackage
    mkYarnModules
    fixup_yarn_lock;
```

I mean it's also here

um I guess I'm maybe I'm confused I'm not sure why I'm actually looking for this
anymore

so let's just continue

let's let's see this so here we have the error

```
$ nix-build -A signal
... ommited ...
error: builder for '/nix/store/x9gfbnpsbs77syxf9040an328sp8cn8b-signal-desktop-7.5.1.drv' failed to produce output path for output 'out' at '/nix/store/x9gfbnpsbs77syxf9040an328sp8cn8b-signal-desktop-7.5.1.drv.chroot/root/nix/store/jhx46my9m7ky34qv5xbzsdqn4isbjqaa-signal-desktop-7.5.1'
```

I guess this wasn't like a fully complete um fully complete build here

we have a configurePhase and then I guess the buildPhase hasn't been written
here

_Reads https://discourse.nixos.org/t/issue-with-yarn-fetchyarndeps/44889/4_

> was able to make some progress on it uh but I'm running into an odd error in
> the buildPhase about permissions when copying electron to the build
> destination. I've included the current state

there's there's a lot of discussion here

um some patches as well

oh I'm trying to run the app so apparently there's a a successful build already

there's a patch file okay well someone is really like working on this

and it appears to not be very trivial

um so I think honestly it's it might be best to

like I don't want to just copy all of this I don't think I can look into into
this and give you like a very good like explanation of it

so I think it might be best to actually just look a bit more into yarn2nix see
how it works um so we understand it a bit better and uh yeah let's do that

that so once more I'm going to go into here

```console
# nixpkgs commit is 72f92f567f50917f0f5c12c1a94dbaeb5a012074
$ cd ~/src/nixpkgs/main/pkgs/development/tools/yarn2nix-moretea/yarn2nix
```

um and uh let's look at the default.nix

I think that's really the main bit

going to run tree here just to see what kind of things there are

```console
$ tree
.
├── bin
│   └── yarn2nix.js
├── default.nix
├── internal
│   ├── fixup_bin.js
│   └── fixup_yarn_lock.js
├── lib
│   ├── fixPkgAddMissingSha1.js
│   ├── generateNix.js
│   ├── mapObjIndexedReturnArray.js
│   └── urlToName.js
├── LICENSE.txt
├── nix
│   └── expectShFunctions.sh
├── package.json
├── yarn.lock
└── yarn.nix

5 directories, 13 files
```

there are some json (js) files in here

I think these are for the yarn2nix tool itself

so on one hand there's a tool in here

which I guess uh if you go into the default.nix

yarn2nix it's this one

and where does it come from?

mkYarnPackage

```nix
# file: yarn2nix/default.nix
  yarn2nix = mkYarnPackage {
    src = lib.fileset.toSource {
      root = ./.;
      fileset = lib.fileset.unions [
        ./bin
        ./lib
        ./package.json
        ./yarn.lock
      ];
    };
```

right so that uses bin, lib, package.json and yarn.lock

okay and so we have bin/yarn2nix.js

this is what it actually does

um maybe also let's let's just build it

and try to run it on yarn to itself here

I guess that's that's what this is yarn.lock and yarn.nix

so let's go into here

um maybe I can also use there's a neat thing

```console
$ git rev-parse --show-toplevel`
/home/tweagysil/src/nixpkgs/main
```

which points you to the top level thing

and uh that's very useful in scripts

so you could do like this here

okay but we want to build yarn2nix

```console
$ nix-build "$(git rev-parse --show-toplevel)" -A yarn2nix
these 2 paths will be fetched (0.66 MiB download, 6.25 MiB unpacked):
  /nix/store/nmq453540qf3i7n9iw63bkmcygs30hjv-yarn2nix-1.0.0
  /nix/store/v9pbvpr7ansi5q8kdbvp0cw5cbd4xngf-yarn2nix-modules-1.0.0
copying path '/nix/store/v9pbvpr7ansi5q8kdbvp0cw5cbd4xngf-yarn2nix-modules-1.0.0' from 'https://cache.nixos.org'...
copying path '/nix/store/nmq453540qf3i7n9iw63bkmcygs30hjv-yarn2nix-1.0.0' from 'https://cache.nixos.org'...
/nix/store/nmq453540qf3i7n9iw63bkmcygs30hjv-yarn2nix-1.0.0
```

let's just get that

and then `./result/bin/yarn2nix`

let's just do the help here

```console
$ ./result/bin/yarn2nix --help
Usage: yarn2nix [options]

Options:
  -h --help           Shows this help.
  --no-nix            Hide the nix output
  --no-patch          Don't patch the lockfile if hashes are missing
  --lockfile=FILE     Specify path to the lockfile [default: ./yarn.lock].
  --builtin-fetchgit  Use builtin fetchGit for git dependencies to support on-the-fly generation of yarn.nix without an internet connection
```

and

> hide the nix output, don't patch lock file if hases are missing

not sure what that is about

oh

> specify the lock file

oh I see

oh I see so sometimes hashes are missing and you might say don't patch them

um I think by default yeah that's might actually be a bit of a clue

I think by default it doesn't do that if I understand correctly

so yarn2nix no-patch

```nix
# file: yarn2nix/default.nix
      "${yarn2nix}/bin/yarn2nix --lockfile ${yarnLock} --no-patch --builtin-fetchgit ${lib.escapeShellArgs flags} > $out";
```

oh no-patch

well I guess it...

I wouldn't expect those `nop` packages to...

well you could fetch them I suppose

but maybe like this is kind of it

so maybe let's let's do that let's generate it manually

actually specifically for for the uh for signal right

so uh signal desktop I have it cloned here

now this is the master version

maybe we shouldn't use master, might be a good point

is there a tag uh which tag did we try building here

jumping around a lot here

but the tag we have here

or maybe let's just go back in history here a bit more and see what the original
was

`7.12.0` and `7.5.1` is one used in the issue

um I guess let's go back here a bit try it with mkYarnPackage in the end

going to switch to this version uh detach

```console
$ cd Signal-Desktop
$ git switch v7.12.0 --detach
HEAD is now at ccad9a8f0 v7.12.0
```

okay now we have yarn2nix here

uh how do I want to do this?

I guess uh since we have it here I'm just going to do yarn2nix

then wait what did we need

let's just go back into here yarn2nix

```nix
# file: yarn2nix/default.nix
  mkYarnNix = { yarnLock, flags ? [] }:
    pkgs.runCommand "yarn.nix" {}
    "${yarn2nix}/bin/yarn2nix --lockfile ${yarnLock} --no-patch --builtin-fetchgit ${lib.escapeShellArgs flags} > $out";
```

see this we have lock file builtin fetchgit and escape the flags

oh I mean we can pass flags here

uh I mean we can't remove the no patch flag

um but we could try changing it a little bit

so that maybe we

or is there a flag to enable patching again?

uh let's see

```console
$ ./result/bin/yarn2nix --help
Usage: yarn2nix [options]

Options:
  -h --help           Shows this help.
  --no-nix            Hide the nix output
  --no-patch          Don't patch the lockfile if hashes are missing
  --lockfile=FILE     Specify path to the lockfile [default: ./yarn.lock].
  --builtin-fetchgit  Use builtin fetchGit for git dependencies to support on-the-fly generation of yarn.nix without an internet connection
```

no patch there... I don't think there is

so we could maybe do

I mean this is not entirely

I mean let's introduce that let's say

noPatchLockfile and say it's enabled by default

```nix
# file: yarn2nix/default.nix
  mkYarnNix = { yarnLock, flags ? [], noPatchLockfile ? true }:
```

well actually I think let's switch it around and let's say patchLockfile

```nix
# file: yarn2nix/default.nix
  mkYarnNix = { yarnLock, flags ? [], patchLockfile ? true }:
```

it's way easier to reason about flags that aren't inverted

there's noPatchLockfile and then you say it's false

and you need to think about oh I'm going to invert false and gets a little bit
messy

uh same for like things like dontBuild there's flag for dontBuild

um I think those would be better as do build

but yes, patchLockfile by default by default it's false

and then we only do

so we do a lib.optional string for if the if it's not true patchLockfile then we
add that flag

um like this so is that right if this is false this is true then we add it and
so it stays the same and the other way around

```nix
# file: yarn2nix/default.nix
  mkYarnNix = { yarnLock, flags ? [], patchLockfile ? false }:
    pkgs.runCommand "yarn.nix" {}
    "${yarn2nix}/bin/yarn2nix --lockfile ${yarnLock} ${lib.optionalString (! patchLockfile) "--no-patch"} --builtin-fetchgit ${lib.escapeShellArgs flags} > $out";
```

yeah okay so we have a small patch I'm really not sure if that's going to help
but we can see some nix codes that good

and so if we go to mkYarnPackage

```nix
# file: yarn2nix/default.nix
  mkYarnPackage = {
    name ? null,
    src,
    packageJSON ? src + "/package.json",
    yarnLock ? src + "/yarn.lock",
    yarnNix ? mkYarnNix { inherit yarnLock; },
    offlineCache ? importOfflineCache yarnNix,
    nodejs ? inputs.nodejs,
# ...
```

how is it called there?

so this is the function that has the new argument

we call it with yarn.lock okay

we we could try like passing an argument here

so let's try it let's try `yarnNix`

we want to pass

um well we need the source here uh

```nix
# file: code/77/signal.nix
{mkYarnPackage, fetchFromGitHub}:

mkYarnPackage rec {
    pname = "signalapp";
    version = "7.12.0";

    src = fetchFromGitHub {
        owner = "signalapp";
        repo = "Signal-Desktop";
        rev = "ccad9a8f0137941f6f69eadc02e0fe718709a503";
        hash = "sha256-FRVlOxqnvYl5cujio9WOD9Vs6XiLBn3KGNWRNy5vSaQ=";
        fetchSubmodules = true;
    };
}
```

I guess we do have the source there `rec` here

not always recommended, ironically even though it's called `rec` um stands for
recursive not recommended

um but yeah let's try this

so I'm going to call this function manually

uh is it available in here I wonder

mkYarnNix I guess we'll find out relatively soon

so `mkYarnNix`

uh we need the yarn lock here which is source plus yarn.lock

and we need uh what is it again?

patchLockfile equals true

```nix
# file: code/77/signal.nix
{mkYarnPackage, mkYarnNix, fetchFromGitHub}:

mkYarnPackage rec {
    pname = "signalapp";
    version = "7.12.0";

    src = fetchFromGitHub {
        owner = "signalapp";
        repo = "Signal-Desktop";
        rev = "ccad9a8f0137941f6f69eadc02e0fe718709a503";
        hash = "sha256-FRVlOxqnvYl5cujio9WOD9Vs6XiLBn3KGNWRNy5vSaQ=";
        fetchSubmodules = true;
    };

    yarnNix = mkYarnNix {
        yarnLock = src + "/yarn.lock";
        patchLockfile = true;
    };
}
```

okay and uh let's just try it see what happens

```console
$ nix-build -A signal
... ommited ...
       error: evaluation aborted with the following error message: 'lib.customisation.callPackageWith: Function called without required argument "mkYarnNix" at /home/tweagysil/nix-hour/code/77/signal.nix:1'
```

> function called without required argument mkYarnNix

um okay is it exposed anywhere else

```console
$ vim yarn2nix/default.nix
# searchL mkYarnNix
```

let's just go in here and look for it

wait this is all exposed somewhere I wonder

let's go in here

```console
$ cd ~/src/nixpkgs/main
$ nix-build -A yarn2nix-moretea.<TAB>
defaultYarnFlags      importOfflineCache    mkYarnNix             override              reformatPackageName   yarn
fixup_yarn_lock       linkNodeModulesHook   mkYarnPackage         overrideDerivation    spdxLicense           yarn2nix
getLicenseFromSpdxId  mkYarnModules         mkYarnWorkspace       pkgs                  unlessNull
```

oh here it is, okay

so we want that

mkYarn oh no yarn2nix-moretea and that might work

```nix
# file: signal.nix
{mkYarnPackage, yarn2nix-moretea, fetchFromGitHub}:

mkYarnPackage rec {
    pname = "signalapp";
    version = "7.12.0";

    src = fetchFromGitHub {
        owner = "signalapp";
        repo = "Signal-Desktop";
        rev = "ccad9a8f0137941f6f69eadc02e0fe718709a503";
        hash = "sha256-FRVlOxqnvYl5cujio9WOD9Vs6XiLBn3KGNWRNy5vSaQ=";
        fetchSubmodules = true;
    };

    yarnNix = yarn2nix-moretea.mkYarnNix {
        yarnLock = src + "/yarn.lock";
        patchLockfile = true;
    };
}
```

let's see

<details open>
<summary>Collapse</summary>

```console
$ nix-build -A signal
building '/nix/store/izvmf3jnnssiqz98zdnyr5bmvz84495w-yarn.nix.drv'...
node:events:496
      throw er; // Unhandled 'error' event
      ^

Error: getaddrinfo EAI_AGAIN registry.npmjs.org
    at GetAddrInfoReqWrap.onlookupall [as oncomplete] (node:dns:118:26)
Emitted 'error' event on ClientRequest instance at:
    at TLSSocket.socketErrorListener (node:_http_client:500:9)
    at TLSSocket.emit (node:events:518:28)
    at emitErrorNT (node:internal/streams/destroy:169:8)
    at emitErrorCloseNT (node:internal/streams/destroy:128:3)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {
  errno: -3001,
  code: 'EAI_AGAIN',
  syscall: 'getaddrinfo',
  hostname: 'registry.npmjs.org'
}

Node.js v20.12.2
error:
       … while calling the 'derivationStrict' builtin
         at <nix/derivation-internal.nix>:37:12:
           36|
           37|   strict = derivationStrict drvAttrs;
             |            ^
           38|

       … while evaluating derivation 'signal-desktop-7.12.0'
         whose name attribute is located at /home/tweagysil/src/nixpkgs/main/pkgs/stdenv/generic/make-derivation.nix:331:7

       … while evaluating attribute 'configurePhase' of derivation 'signal-desktop-7.12.0'
         at /home/tweagysil/src/nixpkgs/main/pkgs/development/tools/yarn2nix-moretea/yarn2nix/default.nix:329:7:
          328|
          329|       configurePhase = attrs.configurePhase or ''
             |       ^
          330|         runHook preConfigure

       (stack trace truncated; use '--show-trace' to show the full, detailed trace)

       error: builder for '/nix/store/izvmf3jnnssiqz98zdnyr5bmvz84495w-yarn.nix.drv' failed with exit code 1;
       last 19 log lines:
       > node:events:496
       >       throw er; // Unhandled 'error' event
       >       ^
       >
       > Error: getaddrinfo EAI_AGAIN registry.npmjs.org
       >     at GetAddrInfoReqWrap.onlookupall [as oncomplete] (node:dns:118:26)
       > Emitted 'error' event on ClientRequest instance at:
       >     at TLSSocket.socketErrorListener (node:_http_client:500:9)
       >     at TLSSocket.emit (node:events:518:28)
       >     at emitErrorNT (node:internal/streams/destroy:169:8)
       >     at emitErrorCloseNT (node:internal/streams/destroy:128:3)
       >     at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {
       >   errno: -3001,
       >   code: 'EAI_AGAIN',
       >   syscall: 'getaddrinfo',
       >   hostname: 'registry.npmjs.org'
       > }
       >
       > Node.js v20.12.2
       For full logs, run 'nix log /nix/store/izvmf3jnnssiqz98zdnyr5bmvz84495w-yarn.nix.drv'.
```

</details>

oh we have something

> unhandled error event stack Trace while evaluating attribute Builder failed

um okay so maybe that doesn't work

> get EAI_AGAIN ticks rejections getaddrinfo registry

oh right uh this is running in a derivation

so it can't actually fetch it so that's that's why it's it's hardcoded to never
patch the lock file

but I guess that also means if we do want to patch the lock file

we can't run it in a derivation or we could use impure derivations which are an
experimental newish feature

um although then everything I think has to like rebuild every time or something
like that

has tradeoffs

so I think let's just manually do it instead then

so I'm going to do let's get yarn2nix in here

```console
$ nix-build -A pkgs.yarn2nix
/nix/store/nmq453540qf3i7n9iw63bkmcygs30hjv-yarn2nix-1.0.0
```

so get yarn2nix

going to run yarn2nix

um actually let's could we just like copy the command here

I'm going to get the derivation that failed

```console
$ nix show-derivation /nix/store/izvmf3jnnssiqz98zdnyr5bmvz84495w-yarn.nix.drv
```

and then let's do some jq magic to get to this one

although I guess we don't need the jq magic here

> [!NOTE]
>
> jq magic is
>
> nix derivation show /nix/store/izvmf3jnnssiqz98zdnyr5bmvz84495w-yarn.nix.drv |
> jq '.[].env.buildCommand' -r

but essentially just copying this command

that should work

yeah then we don't even need the result symlink

I can just do this and uh let's see

```console
$ /nix/store/nmq453540qf3i7n9iw63bkmcygs30hjv-yarn2nix-1.0.0/bin/yarn2nix --lockfile /nix/store/jfmxg4j30hdp5vx2ybdsc1a8flh3cjmr-source/yarn.lock  --builtin-fetchgit
... HUGE OUTPUT, ommited ...
```

that outputs a file

so I'll just do yarn.nix

```console
$ /nix/store/nmq453540qf3i7n9iw63bkmcygs30hjv-yarn2nix-1.0.0/bin/yarn2nix --lockfile /nix/store/jfmxg4j30hdp5vx2ybdsc1a8flh3cjmr-source/yarn.lock  --builtin-fetchgit > yarn.nix
```

is that it?

_opens yarn.nix_

that looks decent

we're almost out of time here

so oh and let's see _search:canvas_

canvas is not in here

or _search:nop_

is nop in here?

nop is in here

```nix
# file: yarn.nix:7348
    {
      name = "nop___nop_1.0.0.tgz";
      path = fetchurl {
        name = "nop___nop_1.0.0.tgz";
        url  = "https://registry.yarnpkg.com/nop/-/nop-1.0.0.tgz";
        sha1 = "cb46cf7e01574aa6390858149f66897afe53c9ca";
      };
    }
# ...
```

uh so that's oh and it did actually fetch it and it does have a hash here

so maybe maybe it's going to work

let's try it out if possible

um so how do we do this yarnNix

I guess we don't actually do use this we just do yarn.nix

```nix
# file: signal.nix
  yarnNix = ./yarn.nix;
```

okay and signal again see what it does here

<details>
<summary>Collapse</summary>

```console
$ nix-build -A signal
these 5 derivations will be built:
  /nix/store/9zfcarqp92bp81x9wm3s1iibsgfx5xc8-offline.drv
  /nix/store/h9vnb8p1dya5s3nr64zzavg2rk24sfgx-signal-desktop-modules-7.12.0-workspace-package.json.drv
  /nix/store/mxa96wmgbwa0r33aff9d4z22ifjj976v-fixup_yarn_lock.drv
  /nix/store/7l4djdswg4lj7zh933d38br7js1jdan1-signal-desktop-modules-7.12.0.drv
  /nix/store/7x1pxbxd919mg4m05pfh8ikkml5bg8ks-signal-desktop-7.12.0.drv
these 11 paths will be fetched (0.88 MiB download, 2.59 MiB unpacked):
  /nix/store/lbbfggfihm00ban6qn74z055czaqdmx5-jq-1.7.1
  /nix/store/d2kin53ib2ii492ql1kznjsgy85lhwdz-jq-1.7.1-bin
  /nix/store/zdhjf7wlszzjywpy5zvvzpkf9iyllkw5-jq-1.7.1-dev
  /nix/store/ji5hnw6mskl27rls3979bb2npzhjbqcb-jq-1.7.1-doc
  /nix/store/xj4yxyfrac5gkphn4y7rjl049i4m01fn-jq-1.7.1-lib
  /nix/store/jlp81pv77mdfw10xqbrwfzn7j45jzvik-jq-1.7.1-man
  /nix/store/989rrjnsvi0lbcc34ll3zdj7iv668475-lz4-1.9.4
  /nix/store/cfn5mxsj39zxjxpar677i25l122wnwyb-oniguruma-6.9.9-lib
  /nix/store/19p47igcrmic3lia2mn0s6ji90xc77ma-popt-1.19
  /nix/store/x4acwmdlgblkz45bvpvk1lrcq69zyn5d-rsync-3.3.0
  /nix/store/f9a465mgd3i4nk1321w18sgjf2dsjwl5-xxHash-0.8.2
copying path '/nix/store/989rrjnsvi0lbcc34ll3zdj7iv668475-lz4-1.9.4' from 'https://cache.nixos.org'...
copying path '/nix/store/f9a465mgd3i4nk1321w18sgjf2dsjwl5-xxHash-0.8.2' from 'https://cache.nixos.org'...
copying path '/nix/store/19p47igcrmic3lia2mn0s6ji90xc77ma-popt-1.19' from 'https://cache.nixos.org'...
building '/nix/store/mxa96wmgbwa0r33aff9d4z22ifjj976v-fixup_yarn_lock.drv'...
building '/nix/store/9zfcarqp92bp81x9wm3s1iibsgfx5xc8-offline.drv'...
copying path '/nix/store/lbbfggfihm00ban6qn74z055czaqdmx5-jq-1.7.1' from 'https://cache.nixos.org'...
copying path '/nix/store/ji5hnw6mskl27rls3979bb2npzhjbqcb-jq-1.7.1-doc' from 'https://cache.nixos.org'...
copying path '/nix/store/jlp81pv77mdfw10xqbrwfzn7j45jzvik-jq-1.7.1-man' from 'https://cache.nixos.org'...
patching script interpreter paths in /nix/store/bskap84688nzcnlf9w19yh7lnjw4mg01-fixup_yarn_lock
/nix/store/bskap84688nzcnlf9w19yh7lnjw4mg01-fixup_yarn_lock/bin/fixup_yarn_lock: interpreter directive changed from "#!/usr/bin/env node" to "/nix/store/74a6mmrgxzcg9axl1gmdz3j2y1bjd13f-nodejs-20.12.2/bin/node"
copying path '/nix/store/cfn5mxsj39zxjxpar677i25l122wnwyb-oniguruma-6.9.9-lib' from 'https://cache.nixos.org'...
copying path '/nix/store/x4acwmdlgblkz45bvpvk1lrcq69zyn5d-rsync-3.3.0' from 'https://cache.nixos.org'...
copying path '/nix/store/xj4yxyfrac5gkphn4y7rjl049i4m01fn-jq-1.7.1-lib' from 'https://cache.nixos.org'...
copying path '/nix/store/d2kin53ib2ii492ql1kznjsgy85lhwdz-jq-1.7.1-bin' from 'https://cache.nixos.org'...
copying path '/nix/store/zdhjf7wlszzjywpy5zvvzpkf9iyllkw5-jq-1.7.1-dev' from 'https://cache.nixos.org'...
building '/nix/store/h9vnb8p1dya5s3nr64zzavg2rk24sfgx-signal-desktop-modules-7.12.0-workspace-package.json.drv'...
building '/nix/store/7l4djdswg4lj7zh933d38br7js1jdan1-signal-desktop-modules-7.12.0.drv'...
Running phase: patchPhase
Running phase: updateAutotoolsGnuConfigScriptsPhase
Running phase: configurePhase
Running phase: buildPhase
yarn config v1.22.22
success Set "yarn-offline-mirror" to "/nix/store/5jp7ms9c29slr4rsjd5qc3c6zvjcqr2x-offline".
Done in 0.04s.
yarn install v1.22.22
[1/4] Resolving packages...
warning Lockfile has incorrect entry for "canvas@^2.6.1". Ignoring it.
warning Lockfile has incorrect entry for "jsdom@^15.2.1". Ignoring it.
error Couldn't find any versions for "canvas" that matches "^2.6.1" in our cache (possible versions are ""). This is usually caused by a missing entry in the lockfile, running Yarn without the --offline flag may help fix this issue.
info Visit https://yarnpkg.com/en/docs/cli/install for documentation about this command.
Error: Couldn't find any versions for "jsdom" that matches "^15.2.1" in our cache (possible versions are ""). This is usually caused by a missing entry in the lockfile, running Yarn without the --offline flag may help fix this issue.
    at MessageError.ExtendableBuiltin (/nix/store/a88spw7v746iffp3mcyl54s87mfdvy86-yarn-1.22.22/libexec/yarn/lib/cli.js:721:66)
    at new MessageError (/nix/store/a88spw7v746iffp3mcyl54s87mfdvy86-yarn-1.22.22/libexec/yarn/lib/cli.js:750:123)
    at NpmResolver.<anonymous> (/nix/store/a88spw7v746iffp3mcyl54s87mfdvy86-yarn-1.22.22/libexec/yarn/lib/cli.js:50440:15)
    at Generator.next (<anonymous>)
    at step (/nix/store/a88spw7v746iffp3mcyl54s87mfdvy86-yarn-1.22.22/libexec/yarn/lib/cli.js:310:30)
    at /nix/store/a88spw7v746iffp3mcyl54s87mfdvy86-yarn-1.22.22/libexec/yarn/lib/cli.js:321:13
error: builder for '/nix/store/7l4djdswg4lj7zh933d38br7js1jdan1-signal-desktop-modules-7.12.0.drv' failed with exit code 1;
       last 20 log lines:
       > Running phase: patchPhase
       > Running phase: updateAutotoolsGnuConfigScriptsPhase
       > Running phase: configurePhase
       > Running phase: buildPhase
       > yarn config v1.22.22
       > success Set "yarn-offline-mirror" to "/nix/store/5jp7ms9c29slr4rsjd5qc3c6zvjcqr2x-offline".
       > Done in 0.04s.
       > yarn install v1.22.22
       > [1/4] Resolving packages...
       > warning Lockfile has incorrect entry for "canvas@^2.6.1". Ignoring it.
       > warning Lockfile has incorrect entry for "jsdom@^15.2.1". Ignoring it.
       > error Couldn't find any versions for "canvas" that matches "^2.6.1" in our cache (possible versions are ""). This is usually caused by a missing entry in the lockfile, running Yarn without the --offline flag may help fix this issue.
       > info Visit https://yarnpkg.com/en/docs/cli/install for documentation about this command.
       > Error: Couldn't find any versions for "jsdom" that matches "^15.2.1" in our cache (possible versions are ""). This is usually caused by a missing entry in the lockfile, running Yarn without the --offline flag may help fix this issue.
       >     at MessageError.ExtendableBuiltin (/nix/store/a88spw7v746iffp3mcyl54s87mfdvy86-yarn-1.22.22/libexec/yarn/lib/cli.js:721:66)
       >     at new MessageError (/nix/store/a88spw7v746iffp3mcyl54s87mfdvy86-yarn-1.22.22/libexec/yarn/lib/cli.js:750:123)
       >     at NpmResolver.<anonymous> (/nix/store/a88spw7v746iffp3mcyl54s87mfdvy86-yarn-1.22.22/libexec/yarn/lib/cli.js:50440:15)
       >     at Generator.next (<anonymous>)
       >     at step (/nix/store/a88spw7v746iffp3mcyl54s87mfdvy86-yarn-1.22.22/libexec/yarn/lib/cli.js:310:30)
       >     at /nix/store/a88spw7v746iffp3mcyl54s87mfdvy86-yarn-1.22.22/libexec/yarn/lib/cli.js:321:13
       For full logs, run 'nix log /nix/store/7l4djdswg4lj7zh933d38br7js1jdan1-signal-desktop-modules-7.12.0.drv'.
error: 1 dependencies of derivation '/nix/store/7x1pxbxd919mg4m05pfh8ikkml5bg8ks-signal-desktop-7.12.0.drv' failed to build
```

</details>

five derivations will be built

> offline workpace stuff fixup yarn lock

uh still fails okay so I guess guess it's it's another issue

um anyways uh we are out of time

we did we were able to look into some next stuff uh which is nice

uh but yeah in the end it's a lot of like digging a lot of looking at revision
history

I'd also recommend looking at at the yarn codebase itself they might do changes
to to things

and third party projects uh or other projects might use these changes and the
lockfile might get changes stuff like that

um maybe you could update yarn in nixpkgs maybe that's going to help it somehow

maybe it's backwards compatible or something

um sometimes also yarn2nix might need changes to make it work

and finally I'd also recommend looking at

uh at this one here yarn-plugin-nixify

[yarn-plugin-nixify](https://github.com/stephank/yarn-plugin-nixify)

um which I've heard works better

and uh if so it would be good to to combobulate (?) it see how it works

integrate it into more packages ideally also make it usable in nixpkgs

all right but yeah thanks for joining

and uh have a nice week see you in the next one.
