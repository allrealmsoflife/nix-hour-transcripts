Silvan: Yeah, so since you asked this just before Simonas do you want to repeat the question?

Question: Yeah, I can repeat it, so what I've been doing, like I've been trying to play a Valorian
game, like the Rust open source game, and the launcher is running on 0.7 and I thought I will just
override it to 0.9, make a derivation and then as I started doing the derivation I came across this
problem with cargo sha256 that I did not know how to calculate it out.

Silvan: Yeah, so the question is how to update rust packages to, how to override rust packages with
newer versions well, yeah I guess that's the question, and then there's the problem of the dependency
hash not being updated automatically.

Simonas: Yeah, so making a derivation carg sha256 needs to be additionally also kind of like recalculated

Silvan: Yeah, which package did you try it on

Simonas: airshipper

Silvan: OK

```nix
nix-instantiate -A airshipper.version
error: expression does not evaluate to a derivation (or a set or list of those)
```

Okay, so do you want to use, let's use:

```nix
ne -A airshipper.version
"0.7.0"
```

And you wanted to get a newer version?

Simonas: 0.9.0

Silvan: Yeah, okay, let's I guess try it out there so, let's try to write an overlay, I'm just gonna write this
locally in my nixpkgs here:

```bash
vim overlay.nix
```
So `self: super: { }` we could also use alternative, the others are `final:` and `prev:`, it's really kind of just
convention, you can name them anything you want, then `airshipper = `, so by default usually you do something like 
this, `super.airshipper`, and then `.overrideAttrs`, because you want to override the src attribute and that's part
of the derivation attributes, so that's what `overrideAttrs` overrides. Then we get in here the `(old: ` attributes
from the derivation and can provide new ones, so here we say `src = `, well now got to figure out how it gets fetched:

```nix
# final: prev:
self: super: {
  airshipper = super.airshipper.overrideAttrs (old: {
    src =
  });
}
```

Let me go into nixpkgs here, (`~/src/nixpkgs`), go to airshipper, look at how that's packaged, we see `src = fetchFromGitLab`,
okay, that looks good, we go back here and just copy that in:

```nix
self: super: {
  airshipper = super.airshipper.overrideAttrs (old: {
    src = fetchFromGitLab {
        owner = "Veloren";
        repo = "airshipper";
        rev = "v${version}";
        hash = "sha256-V8G1mZIdqf+WGcrUzRgWnlUk+EXs4arAEQdRESpobGg=";
    };
  });
}
```

Let me do, `0.9.0`, and I guess we can also do this here version, well let's put the version here, and I think if we 
don't update the name here it will keep the same derivation name, let's see what happens, and here we need to use
`rec` I believe, we talked about this in a previous video where there is a new convention in nixpkgs which doesn't
require the `rec` anymore, the video there was a bit misleading because most derivations don't use the new convention
yet so in most cases this is still needed so `old.version` would still be 0.7.0 here, not the 0.9.0, so for now
I'm just gonna use the old convention with `rec` and then the `sha` we need to update it a bit, so it causes a refetch,
let me just change a character here, we can also clear it, yeah let's do that.

Julien Debon: Or you can use an empty string right?

Silvan: Um, yeah, I wonder if just not specifying also works, if that's the same as an empty string, I guess we can try 
it out here:

```nix
self: super: {
  airshipper = super.airshipper.overrideAttrs (old: rec {
    version = "0.9.0";
    src = fetchFromGitLab {
        owner = "Veloren";
        repo = "airshipper";
        rev = "v${version}";
        # hash = "sha256-V8G1mZIdqf+WGcrUzRgWnlUk+EXs4arAEQdRESpobGg=";
    };
  });
}
```

Viktor Kleen: What I usually do, is I say `sha256` is `self.lib.fakehash`

Silvan: Yeah that, I think nowadays that's not really required anymore because just an empty sha also works, this is a 
somewhat recent feature in nix as far as I know, and the `lib.` what is, `lib.fakeSha256`, I think that was introduced
before nix allowed empty sha's.

Viktor Kleen: You can also do the fakehash, fakehash is just the new, the sri hash string.

Silvan: I see, nice. Yeah, let's try to do that for now, I'm gonna try to do the build here:

```bash
:!nix-build -A airshipper
```

And it works, so apparently this didn't work at all, is it because I didn't provide a hash here? Or is it cargo sha 256, oh
it is because we haven't applied the overlay, I just wrote it in my local directory here. So I'm using the old CLI here,
we are in a nixpkgs checkout, you can build packages like this (`nix-build -A airshipper`), but this doesn't apply the
overlay automatically. We could move the overlay to:

```bash
mv overlay.nix ~/.config/nixpkgs/overlays/airshipper.nix
```

We need to create the directory first, `mkdir ~/.config/nixpkgs/overlays -p`, move it in there, so this is impure,
I see Yuri mentions in the chat so this is impure, so flakes doesn't work with this. Flakes would just ignore this.
I'm gonna show this without relying on this in a second

```nix
nix-build -A airshipper
error: undefined variable 'fetchFromGitLab`
```

Okay, we get an error because I made a mistake in the file but it gets evaluated, so let's fix it here, we need to use:

```nix
self: super: {
  airshipper = super.airshipper.overrideAttrs (old: {
    src = self.fetchFromGitLab {
        owner = "Veloren";
        repo = "airshipper";
        rev = "v${version}";
        sha256 = "";
    };
  });
}
```

Let's try to evaluate it again:

```nix
nix-build -A airshipper
warning: found empty hash, assuming 'sha256-AA..='
```

And okay, we can see it inferred from the empty hash, and did we provide one? We did provide one, we also want to see if
it works without any hash at all, (`# sha256 ="";`), yeah that also works, okay that's good news. You do need to watch out
a bit if you use `fetchTarball` without the hash, so this a builtin fetcher, (`builtin.fetchTarball {}`), and we could
also try this out here so let's say `src = fetchTarball {};` and then we use 
```nix
url = "https://github.com/Veloren/airshipper/archive/v0.9.0.tar.gz";
```

Julien Debon: I think it's gitlab not github.

Silvan: Oh it's gitlab all right.

Simone Narbutas: It's mirrored though.

Silvan: It does turn into the same url?

Simone Narbuta: It should be the same on github, like as far as I know

Silvan: Okay, let's try this then

```nix
self: super: {
  airshipper = super.airshipper.overrideAttrs (old: rec {
    version = "0.9.0";
    # src = self.fetchFromGitLab {
    #    owner = "Veloren";
    #    repo = "airshipper";
    #    rev = "v${version}";
    #    sha256 = "";
    #};
    src = fetchTarball {
      url = "https://gitlab.com/Veloren/airshipper/archive/v0.9.0.tar.gz";
    };
  });
}
```

So now, `nix-build -A airshipper`, so this, oh, that looked like an error, it's another url I believe..

Yuriy Taraday: Try github instead of gitlab

Silvan: Oh.. I see. That should make it work then. Ok we can see here we didn't get an error, even though we didn't provide a hash,
so this is a difference between the nixpkgs fetchers which don't work without a hash at all, well they shouldn't work
without a hash, nix does allow this warning when you don't provide a hash, but obviously you are gonna fix it when you see it.
The builtin fetchers don't need a hash and they're just gonna download these files impurely so we have to explicitly provide
a hash here, I think we can also just do `hash = "";`, let's try this:

```nix
nix-build -A airshipper
error: unsupported argument 'hash' to 'fetchTarball'
```

Fair enough, `fetchTarball` apparently doesn't have a hash, all right let's make it, that's unfortunate: `sha256 = "";`:

```nix
nix-build -A airshipper
warning: found empty hash, assuming 'sha256..='
```

This time it works, this time it gets the same result as the `fetchFromGitlab`, in that it assumes the empty zero hash.
Yeah, so I guess it might be good to always set the hash to an empty string (`sha256 = "";`) so that you don't run into
these cases where the nix packages fetchers do need them but those don't and yeah, anyways, let's go back to this, so
we get the hash back from this. As soon as it's downloaded.. it's quite a bit project seemingly, there we go, oh it
dissapeared, oh it's downloading it again.

Simon Narbutas: This should be just a launcher, so it shouldn't be a big.

Silvan: Mhm, might also just be slow for some reason then. All right I copied the hash, and insert here, and here maybe
we can also use hash, (`hash = "sha256-...=";`), oh it doesn't really matter, both of them work the same way. All right so
that works, let's try to build it. All right and now we get a patch error. Let's see it might be good to look into that and 
see what happens. Well but first I want to do this kind of overlay kind of purification in a way. So let's try to build 
this with with a flake way, so let's use the new nix CLI, let's try to build airshipper in nixpkgs here,
(`nix build .#airshipper`), this should work but give the old version, it shouldn't take a look at the overlay here, and yeah
if we look into the directory, (`result -> /nix/store/z..-airshipper-0.7.0`). Oh, and actually, oh, we can't pass in the
overlay from the CLI here, that's right, because flakes doesn't support `--arg` and `--argstr` yet,
(`nix build .#airshipper --argstr`). Uhm, fair enough, so I guess with flakes you'd have to write a `flake.nix` to import
nixpkgs with the overlay you want, (`vim flake.nix`), uhm, or with traditional nix you could also do this, `(nix-build -A airshipper`)
to make it pure. Let's move it back from nixpkgs, (`mv ~/.config/nixpkgs/overlays/airshipper.nix .`) to the local directory
for now, we can also do this, (`nix-build -A airshipper --arg overlays`), we can provide `--arg overlays` so this is,
if you import nixpkgs you can pass the overlays attribute, you can pass all the overlays in the overlays attribute, and
we can also do this from the command line so we can give the array of overlays here, here we can just say:

```nix
nix-build -A airshipper --arg overlays '[ (import ./airshipper.nix) ]'
```

And this then gives the same result without the impurity of looking it up in the `.config` directory. So let's see how far
does it get here. Well in the end it will also fetch the old, oh yeah, look here, the vendor directory is still 0.7.0.
Might be cause by the name but I don't think so, but let's update the name as well, well let's just see what the name
currently is. Let's do..

Viktor Kleen: The name looks all right, right, from the derivation?

Silvan: Oh yeah, it does look all right. Interesting, so that gets propagated automatically, in this case we don't need it.
All right, then, well.. let's also try to override this one..

Viktor Kleen: I think that's because of the.. package the pname, the version already, the name get's me confused.

Silvan: I do think that underneath there sometimes still was a problem because the kind of pname and version was only,
was kind of transformed to the name underneath and but only in the original make derivation call or something. Maybe not
though, I guess that works.

Simonas Narbutas: But I was trying to figure out what pulls in this dash vendor, does it come from the rust package function or?

Silvan: Yeah, let's look at how it's implemented underneath. So the airshipper, let's go back to airshipper here, so airshipper
uses `rustPlatform.buildRustPackage` and so what is then here, so yeah, it's this hash here, (`cargoSha256`), that is kind of
the problem, so I guess, let's take a look at `buildRustPackage`.

So how to find things in nixpkgs is always a bit of a gamble but I like to just rip, use ripgrep to search for the attribute 
equals:

```bash
rg 'buildRustPlatform ='
```

Which didn't work this time which is unfortunate

Julien Debon: Isn't it package?

Silvan: Oh `buildRustPackage`:

```bash
rg 'buildRustPackage ='
pkgs/development/compilers/rust/make-rust-platform.nix
15: ..
```

Oh awesome, I was gonna go for rustPlatform next but this makes it a bit easier:

```bash
vim pkgs/development/compilers/rust/make-rust-platform.nix
```

All right (searches for `/build`), `buildRustPackage` is this package down here. In vim useful `gf` to jump to file,
I guess most vim users already know that, but so this is the file, (`pkgs/build-support/rust/build-rust-package/default.nix`),
we have all the attributes here, we have `cargoVendorDir`, this isn't used, where is (`cargoSha256`), oh it's not in the
arguments up here. I don't like how this is done, how we have some arguments in here but also others are just accepted because
of the ellipsis here and apparently `cargoSha256` comes from there. Apparently, I'm not really sure why it's done this way,
but so `cargoSha256`, and this is used in the `cargoDeps` here, so this does `fetchCargoTarball` and it passes the
sha to that function, all right, so if we can override that function we could maybe do that:

```nix
  cargoDeps =
    if cargoVendorDir != null then null
    else if cargoLock != null then importCargoLock cargoLock
    else fetchCargoTarball ({
      inherit src srcs sourceRoot unpackPhase cargoUpdateHook;
      name = cargoDepsName;
      patches = cargoPatches;
    } // lib.optionalAttrs (args ? cargoHash) {
      hash = args.cargoHash;
    } // lib.optionalAttrs (args ? cargoSha256) {
      sha256 = args.cargoSha256;
    } // depsExtraArgs);
```

> This file currently looks like this:

```nix
cargoDeps' =
    if cargoVendorDir != null then
      null
    else if cargoDeps != null then
      cargoDeps
    else if cargoLock != null then
      importCargoLock cargoLock
    else if useFetchCargoVendor then
      fetchCargoVendor (
        {
          inherit
            src
            srcs
            sourceRoot
            cargoRoot
            preUnpack
            unpackPhase
            postUnpack
            ;
          name = cargoDepsName;
          patches = cargoPatches;
          hash = args.cargoHash;
        }
        // depsExtraArgs
      )
    else
      fetchCargoTarball (
        {
          inherit
            src
            srcs
            sourceRoot
            cargoRoot
            preUnpack
            unpackPhase
            postUnpack
            cargoUpdateHook
            ;
          name = cargoDepsName;
          patches = cargoPatches;
        }
        // lib.optionalAttrs (args ? cargoHash) {
          hash = args.cargoHash;
        }
        // lib.optionalAttrs (args ? cargoSha256) {
          sha256 = lib.warn "cargoSha256 is deprecated. Please use cargoHash with SRI hash instead" args.cargoSha256;
        }
        // depsExtraArgs
      );
```


